<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPH:DOX Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0f; --surface:#12121a; --surface2:#1a1a26;
    --border:rgba(255,255,255,0.08); --accent:#e8f048; --accent2:#48c8f0;
    --text:#f0ede8; --muted:#7a7a8a; --red:#f04848; --green:#48f0a8;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
    background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(232,240,72,0.07) 0%,transparent 60%),
               radial-gradient(ellipse 60% 40% at 80% 100%,rgba(72,200,240,0.05) 0%,transparent 60%);}
  nav{position:sticky;top:0;z-index:100;background:rgba(10,10,15,0.94);backdrop-filter:blur(14px);
    border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;height:56px;}
  .nav-brand{font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--text);margin-right:32px;}
  .nav-brand span{color:var(--accent);}
  .nav-tabs{display:flex;gap:4px;flex:1;}
  .nav-tab{padding:8px 18px;font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.12em;
    text-transform:uppercase;cursor:pointer;border:1px solid transparent;background:none;color:var(--muted);transition:all 0.18s;}
  .nav-tab:hover{color:var(--text);}
  .nav-tab.active{color:var(--accent);border-color:rgba(232,240,72,0.25);background:rgba(232,240,72,0.06);}
  .storage-status{font-size:0.65rem;color:var(--muted);display:flex;align-items:center;gap:6px;margin-left:auto;}
  .sdot{width:6px;height:6px;border-radius:50%;background:var(--muted);}
  .sdot.ok{background:var(--accent);}
  .page{display:none;}.page.active{display:block;}
  .container{max-width:960px;margin:0 auto;padding:40px 20px 100px;position:relative;z-index:1;}
  .page-title{font-family:'DM Serif Display',serif;font-size:clamp(1.8rem,4vw,2.8rem);margin-bottom:6px;line-height:1.1;}
  .page-sub{font-size:0.75rem;color:var(--muted);letter-spacing:0.05em;margin-bottom:40px;}
  .section-label{font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);
    margin-bottom:14px;display:flex;align-items:center;gap:12px;}
  .section-label::after{content:'';flex:1;height:1px;background:var(--border);}
  .section{margin-bottom:32px;}
  input[type="text"],input[type="password"]{width:100%;background:var(--surface);
    border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;
    padding:11px 14px;outline:none;transition:border-color 0.2s,background 0.2s;}
  input:focus{border-color:rgba(232,240,72,0.35);background:var(--surface2);}
  label{display:block;font-size:0.68rem;letter-spacing:0.1em;color:var(--muted);text-transform:uppercase;margin-bottom:7px;}

  /* PDF DROP */
  .pdf-drop{border:2px dashed var(--border);padding:36px 20px;text-align:center;cursor:pointer;
    transition:all 0.22s;background:var(--surface);position:relative;}
  .pdf-drop:hover,.pdf-drop.drag-over{border-color:rgba(232,240,72,0.5);background:rgba(232,240,72,0.04);}
  .pdf-drop.has-file{border-color:rgba(72,240,168,0.5);border-style:solid;background:rgba(72,240,168,0.04);}
  .pdf-drop input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
  .pdf-icon{font-size:2rem;margin-bottom:10px;}
  .pdf-label{font-size:0.78rem;color:var(--muted);line-height:1.7;}
  .pdf-label strong{color:var(--text);}
  .pdf-filename{font-size:0.73rem;color:var(--green);margin-top:8px;}

  /* DAY CARDS */
  .day-cards-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
  @media(max-width:560px){.day-cards-grid{grid-template-columns:1fr;}}
  .day-select-card{background:var(--surface);border:1px solid var(--border);padding:22px 18px;
    transition:all 0.22s;position:relative;overflow:hidden;min-height:140px;
    display:flex;flex-direction:column;justify-content:space-between;}
  .day-select-card.has-date{border-color:rgba(232,240,72,0.4);background:rgba(232,240,72,0.04);}
  .day-select-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
    background:linear-gradient(90deg,var(--accent),transparent);opacity:0;transition:opacity 0.22s;}
  .day-select-card.has-date::before{opacity:1;}
  .dcard-num{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
  .day-select-card.has-date .dcard-num{color:var(--accent);}
  .dcard-date{font-family:'DM Serif Display',serif;font-size:1.4rem;line-height:1;color:var(--muted);margin-bottom:4px;}
  .day-select-card.has-date .dcard-date{color:var(--text);}
  .dcard-weekday{font-size:0.7rem;color:var(--muted);margin-bottom:8px;min-height:1.1em;}
  .day-select-card.has-date .dcard-weekday{color:var(--accent);}
  .dcard-status{font-size:0.63rem;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;}
  .day-select-card.has-date .dcard-status{color:var(--green);}
  .dcard-input{width:100%;background:transparent;border:1px solid var(--border);color:var(--muted);
    font-family:'DM Mono',monospace;font-size:0.72rem;padding:7px 10px;outline:none;margin-top:8px;cursor:pointer;color-scheme:dark;}

  /* PREFS */
  .pref-group{margin-bottom:20px;}
  .pref-question{font-size:0.78rem;color:var(--text);margin-bottom:10px;}
  .pref-chips{display:flex;gap:8px;flex-wrap:wrap;}
  .pref-chip{padding:8px 16px;background:var(--surface);border:1px solid var(--border);color:var(--muted);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.18s;user-select:none;}
  .pref-chip:hover{border-color:rgba(232,240,72,0.3);color:var(--text);}
  .pref-chip.selected{background:rgba(232,240,72,0.08);border-color:rgba(232,240,72,0.5);color:var(--accent);}

  /* BUTTONS */
  .btn-primary{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;
    background:var(--accent);color:#0a0a0f;font-family:'DM Mono',monospace;font-size:0.84rem;font-weight:600;
    letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border:none;transition:all 0.18s;margin-top:24px;}
  .btn-primary:hover{background:#f0fa60;transform:translateY(-1px);}
  .btn-secondary{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:none;
    border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.72rem;
    letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
  .btn-secondary:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
  .btn-accent{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;
    background:rgba(232,240,72,0.08);border:1px solid rgba(232,240,72,0.3);color:var(--accent);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
  .btn-accent:hover{background:rgba(232,240,72,0.16);}
  .btn-cyan{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;
    background:rgba(72,200,240,0.08);border:1px solid rgba(72,200,240,0.3);color:var(--accent2);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;text-decoration:none;}
  .btn-cyan:hover{background:rgba(72,200,240,0.16);}

  /* LOADING */
  .loading-box{display:none;text-align:center;padding:48px 20px;border:1px solid var(--border);background:var(--surface);}
  .film-strip{display:flex;gap:4px;justify-content:center;margin-bottom:16px;}
  .film-frame{width:13px;height:19px;background:var(--surface2);border:1px solid var(--border);animation:filmroll 1.2s ease-in-out infinite;}
  .film-frame:nth-child(2){animation-delay:.1s}.film-frame:nth-child(3){animation-delay:.2s}
  .film-frame:nth-child(4){animation-delay:.3s}.film-frame:nth-child(5){animation-delay:.4s}
  @keyframes filmroll{0%,100%{background:var(--surface2)}50%{background:var(--accent)}}
  .loading-text{font-size:0.73rem;color:var(--muted);letter-spacing:0.1em;}
  .loading-sub{font-size:0.65rem;color:var(--muted);margin-top:8px;opacity:0.6;}
  .error-box{border:1px solid rgba(240,72,72,0.3);background:rgba(240,72,72,0.07);padding:16px;
    color:var(--red);font-size:0.78rem;line-height:1.6;display:none;margin-bottom:16px;}
  .note-box{background:rgba(232,240,72,0.04);border:1px solid rgba(232,240,72,0.14);
    padding:14px 18px;font-size:0.73rem;color:var(--muted);line-height:1.7;}
  .note-box strong{color:var(--accent);}

  /* FILM SELECTION LIST */
  .film-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
  .film-list-title{font-family:'DM Serif Display',serif;font-size:1.4rem;}
  .film-list-meta{font-size:0.7rem;color:var(--muted);}
  .film-list-actions{display:flex;gap:8px;align-items:center;}

  .day-group{margin-bottom:28px;}
  .day-group-label{font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);
    margin-bottom:12px;display:flex;align-items:center;gap:12px;}
  .day-group-label::after{content:'';flex:1;height:1px;background:var(--border);}

  .film-row{display:flex;align-items:flex-start;gap:0;border:1px solid var(--border);
    background:var(--surface);margin-bottom:8px;cursor:pointer;transition:all 0.18s;position:relative;}
  .film-row:hover{border-color:rgba(232,240,72,0.25);background:var(--surface2);}
  .film-row.selected{border-color:rgba(72,240,168,0.5);background:rgba(72,240,168,0.05);}
  .film-row.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);}
  .film-check{width:48px;flex-shrink:0;display:flex;align-items:center;justify-content:center;
    font-size:1.1rem;color:var(--muted);padding:16px 0;border-right:1px solid var(--border);transition:color 0.18s;}
  .film-row.selected .film-check{color:var(--green);}
  .film-info{flex:1;padding:14px 16px;}
  .film-time{font-family:'DM Serif Display',serif;font-style:italic;font-size:1rem;color:var(--accent);margin-bottom:2px;}
  .film-title{font-size:0.88rem;font-weight:500;margin-bottom:3px;line-height:1.3;}
  .film-meta{font-size:0.67rem;color:var(--muted);margin-bottom:5px;}
  .film-desc{font-size:0.72rem;color:var(--muted);line-height:1.6;}

  .sel-bar{position:sticky;bottom:0;z-index:50;background:rgba(10,10,15,0.96);backdrop-filter:blur(12px);
    border-top:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;
    justify-content:space-between;gap:12px;margin:0 -20px;flex-wrap:wrap;}
  .sel-count{font-size:0.75rem;color:var(--muted);}
  .sel-count strong{color:var(--accent);}

  /* OUTPUT */
  #output{display:none;animation:fadeIn 0.4s ease;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .output-actions{display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap;}

  .day-card{background:var(--surface);border:1px solid var(--border);margin-bottom:20px;overflow:hidden;}
  .day-card-header{padding:14px 22px;background:var(--surface2);border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;}
  .day-card-title{font-family:'DM Serif Display',serif;font-size:1.2rem;}
  .day-card-date{font-size:0.68rem;color:var(--accent);letter-spacing:0.1em;}
  .screening{padding:16px 22px;border-bottom:1px solid var(--border);}
  .screening:last-child{border-bottom:none;}
  .sc-time{font-family:'DM Serif Display',serif;font-style:italic;font-size:1.2rem;color:var(--accent);margin-bottom:2px;}
  .sc-title{font-size:0.9rem;margin-bottom:2px;font-weight:500;}
  .sc-venue{font-size:0.7rem;color:var(--muted);}
  .sc-dur{font-size:0.66rem;color:var(--muted);margin-top:1px;}
  .sc-desc{font-size:0.72rem;color:var(--muted);line-height:1.6;margin-top:7px;padding-top:7px;border-top:1px solid var(--border);}
  .sc-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:9px;align-items:center;}
  .btn-ticket{display:inline-flex;align-items:center;gap:5px;background:rgba(232,240,72,0.07);
    border:1px solid rgba(232,240,72,0.22);color:var(--accent);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;text-decoration:none;font-family:'DM Mono',monospace;transition:all 0.18s;}
  .btn-ticket:hover{background:rgba(232,240,72,0.14);}
  .btn-cafe{display:inline-flex;align-items:center;gap:5px;background:transparent;
    border:1px solid var(--border);color:var(--muted);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.18s;}
  .btn-cafe:hover{border-color:rgba(232,240,72,0.3);color:var(--accent);}
  .travel-badge{display:flex;align-items:center;gap:12px;padding:10px 22px;background:rgba(72,200,240,0.04);
    border-top:1px dashed rgba(72,200,240,0.18);border-bottom:1px dashed rgba(72,200,240,0.18);}
  .travel-info{font-size:0.7rem;color:var(--accent2);}
  .btn-maps{margin-left:auto;display:inline-flex;align-items:center;gap:5px;background:rgba(72,200,240,0.1);
    border:1px solid rgba(72,200,240,0.28);color:var(--accent2);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;text-decoration:none;font-family:'DM Mono',monospace;
    transition:all 0.18s;flex-shrink:0;}
  .btn-maps:hover{background:rgba(72,200,240,0.18);}

  /* MISSED FILMS SECTION */
  .missed-section{margin-top:28px;border:1px solid rgba(240,72,72,0.2);background:rgba(240,72,72,0.03);overflow:hidden;}
  .missed-header{padding:14px 22px;background:rgba(240,72,72,0.08);border-bottom:1px solid rgba(240,72,72,0.15);
    display:flex;align-items:center;gap:10px;}
  .missed-header h3{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--red);}
  .missed-header p{font-size:0.7rem;color:var(--muted);}
  .missed-film{padding:14px 22px;border-bottom:1px solid rgba(240,72,72,0.1);}
  .missed-film:last-child{border-bottom:none;}
  .missed-title{font-size:0.88rem;margin-bottom:4px;}
  .missed-showings{font-size:0.7rem;color:var(--muted);line-height:1.8;}
  .missed-showing-time{color:var(--accent2);}

  /* MODALS */
  .modal-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.78);
    align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .modal-box{background:var(--surface);border:1px solid rgba(232,240,72,0.2);
    max-width:480px;width:100%;max-height:85vh;overflow-y:auto;animation:fadeUp 0.25s ease;}
  .modal-head{padding:22px 26px 16px;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:flex-start;}
  .modal-head h2{font-family:'DM Serif Display',serif;font-size:1.25rem;}
  .modal-head-sub{font-size:0.68rem;color:var(--muted);margin-top:3px;}
  .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;padding:0 4px;line-height:1;}
  .modal-close:hover{color:var(--text);}
  .modal-body{padding:20px 26px 26px;}
  .cafe-card{background:var(--surface2);border:1px solid var(--border);padding:13px 16px;margin-bottom:10px;}
  .cafe-name{font-size:0.88rem;margin-bottom:3px;}
  .cafe-type{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-left:6px;}
  .cafe-meta{font-size:0.68rem;color:var(--muted);line-height:1.65;margin-top:3px;}
  .save-box{background:var(--surface);border:1px solid rgba(232,240,72,0.2);padding:32px;max-width:420px;width:100%;animation:fadeUp 0.25s ease;}
  .save-box h2{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:8px;}
  .save-box p{font-size:0.75rem;color:var(--muted);margin-bottom:20px;}
  .modal-btns{display:flex;gap:10px;margin-top:20px;}
  .btn-msave{flex:1;background:var(--accent);color:#0a0a0f;font-family:'DM Mono',monospace;font-size:0.78rem;letter-spacing:0.08em;text-transform:uppercase;padding:11px;cursor:pointer;border:none;font-weight:600;}
  .btn-msave:hover{background:#f0fa60;}
  .btn-mcancel{padding:11px 18px;background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.78rem;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;}
  .btn-mcancel:hover{color:var(--text);}

  /* ARCHIVE */
  .archive-empty{text-align:center;padding:60px 20px;border:1px solid var(--border);background:var(--surface);}
  .archive-empty p{font-size:0.8rem;color:var(--muted);line-height:1.7;}
  .archive-card{background:var(--surface);border:1px solid var(--border);padding:20px 22px;cursor:pointer;transition:all 0.18s;position:relative;margin-bottom:12px;}
  .archive-card:hover{border-color:rgba(232,240,72,0.25);background:var(--surface2);}
  .arc-name{font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:5px;}
  .arc-meta{font-size:0.7rem;color:var(--muted);line-height:1.6;}
  .arc-days{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
  .day-pill{font-size:0.65rem;padding:3px 9px;background:rgba(232,240,72,0.07);border:1px solid rgba(232,240,72,0.18);color:var(--accent);}
  .arc-del{position:absolute;top:14px;right:14px;background:none;border:1px solid var(--border);color:var(--muted);padding:5px 10px;font-size:0.7rem;cursor:pointer;font-family:'DM Mono',monospace;transition:all 0.18s;}
  .arc-del:hover{border-color:rgba(240,72,72,0.4);color:var(--red);}
  #archive-view{display:none;}
  .back-btn{display:inline-flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--muted);padding:8px 16px;font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;margin-bottom:28px;}
  .back-btn:hover{color:var(--text);}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border)}
</style>
</head>
<body>

<nav>
  <div class="nav-brand">CPH<span>:</span>DOX</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('planner')">Planl√¶gger</button>
    <button class="nav-tab" onclick="showPage('archive')">Mine planer</button>
  </div>
  <div class="storage-status">
    <div class="sdot" id="sdot"></div>
    <span id="slabel">...</span>
  </div>
</nav>

<div class="page active" id="page-planner">
<div class="container">

  <!-- SETUP -->
  <div id="screen-setup">
    <h1 class="page-title">Lav en festivalplan</h1>
    <p class="page-sub">// CPH:DOX 2026 ¬∑ 11‚Äì22. marts ¬∑ Upload PDF og v√¶lg film</p>

    <div class="section">
      <div class="section-label">01 ‚Äî API-n√∏gle</div>
      <div style="position:relative;">
        <input type="password" id="api-key" placeholder="sk-ant-..." style="padding-right:80px;" />
        <button onclick="toggleKey()" id="toggle-btn" style="position:absolute;right:0;top:0;bottom:0;background:var(--surface2);border:none;border-left:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;padding:0 13px;cursor:pointer;text-transform:uppercase;">Vis</button>
      </div>
      <div style="font-size:0.68rem;color:var(--muted);margin-top:7px;">Hent p√• <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a></div>
    </div>

    <div class="section">
      <div class="section-label">02 ‚Äî Program-PDF</div>
      <div class="pdf-drop" id="pdf-drop">
        <input type="file" id="pdf-input" accept=".pdf" onchange="onPdfSelected(this)">
        <div class="pdf-icon">üìÑ</div>
        <div class="pdf-label"><strong>Klik eller tr√¶k PDF hertil</strong><br>Claude l√¶ser alle film og tider direkte fra filen.</div>
        <div class="pdf-filename" id="pdf-filename"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-label">03 ‚Äî Festivaldage (11‚Äì22. marts 2026)</div>
      <div class="day-cards-grid">
        <div class="day-select-card" id="dcard-0">
          <div class="dcard-num">Dag 1</div>
          <div class="dcard-date" id="dcard-date-0">V√¶lg dato</div>
          <div class="dcard-weekday" id="dcard-weekday-0"></div>
          <div class="dcard-status" id="dcard-status-0">‚óã Ikke valgt</div>
          <input type="date" id="date1" class="dcard-input" min="2026-03-11" max="2026-03-22" onchange="onDateChange(0)" />
        </div>
        <div class="day-select-card" id="dcard-1">
          <div class="dcard-num">Dag 2</div>
          <div class="dcard-date" id="dcard-date-1">V√¶lg dato</div>
          <div class="dcard-weekday" id="dcard-weekday-1"></div>
          <div class="dcard-status" id="dcard-status-1">‚óã Ikke valgt</div>
          <input type="date" id="date2" class="dcard-input" min="2026-03-11" max="2026-03-22" onchange="onDateChange(1)" />
        </div>
        <div class="day-select-card" id="dcard-2">
          <div class="dcard-num">Dag 3</div>
          <div class="dcard-date" id="dcard-date-2">V√¶lg dato</div>
          <div class="dcard-weekday" id="dcard-weekday-2"></div>
          <div class="dcard-status" id="dcard-status-2">‚óã Ikke valgt</div>
          <input type="date" id="date3" class="dcard-input" min="2026-03-11" max="2026-03-22" onchange="onDateChange(2)" />
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-label">04 ‚Äî Dine pr√¶ferencer</div>
      <div class="pref-group">
        <div class="pref-question">Pauser mellem film?</div>
        <div class="pref-chips" id="pg-pauses">
          <div class="pref-chip" data-val="relaxed" onclick="pickChip('pg-pauses',this)">‚òï Tid til mad og kaffe</div>
          <div class="pref-chip" data-val="packed" onclick="pickChip('pg-pauses',this)">üé¨ Pak s√• meget ind som muligt</div>
        </div>
      </div>
      <div class="pref-group">
        <div class="pref-question">Hvor mange film om dagen?</div>
        <div class="pref-chips" id="pg-count">
          <div class="pref-chip" data-val="1-2" onclick="pickChip('pg-count',this)">1‚Äì2 film</div>
          <div class="pref-chip" data-val="3-4" onclick="pickChip('pg-count',this)">3‚Äì4 film</div>
          <div class="pref-chip" data-val="max" onclick="pickChip('pg-count',this)">S√• mange som muligt</div>
        </div>
      </div>
      <div class="pref-group">
        <div class="pref-question">Hvorn√•r starter du helst?</div>
        <div class="pref-chips" id="pg-start">
          <div class="pref-chip" data-val="morning" onclick="pickChip('pg-start',this)">üåÖ Fra kl. 10</div>
          <div class="pref-chip" data-val="midday" onclick="pickChip('pg-start',this)">‚òÄÔ∏è Fra kl. 12</div>
          <div class="pref-chip" data-val="afternoon" onclick="pickChip('pg-start',this)">üåá Fra kl. 15</div>
        </div>
      </div>
    </div>

    <div class="note-box">
      <strong>S√•dan virker det:</strong> Claude l√¶ser PDF'en og viser alle film for dine dage i en liste. Du s√¶tter flueben ved dem du vil se ‚Äî hver film kun √©n gang. Claude laver derefter den optimale plan og viser hvilke film der ikke kunne passe ind.
    </div>
    <button class="btn-primary" onclick="startPlanner()">‚ñ∂ Start ‚Äî hent film fra PDF</button>
  </div>

  <!-- FILM SELECTION SCREEN -->
  <div id="screen-select" style="display:none;">
    <div class="loading-box" id="loading-fetch">
      <div class="film-strip">
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div>
      </div>
      <div class="loading-text" id="loading-text">Claude l√¶ser PDF...</div>
      <div class="loading-sub" id="loading-sub">Udtr√¶kker filmprogram</div>
    </div>
    <div class="error-box" id="error-fetch"></div>

    <div id="film-list-container" style="display:none;">
      <div class="film-list-header">
        <div>
          <div class="film-list-title">V√¶lg film du vil se</div>
          <div class="film-list-meta" id="film-list-meta"></div>
        </div>
        <div class="film-list-actions">
          <button class="btn-secondary" style="font-size:0.65rem;padding:7px 14px;" onclick="selectAll()">V√¶lg alle</button>
          <button class="btn-secondary" style="font-size:0.65rem;padding:7px 14px;" onclick="selectNone()">Frav√¶lg alle</button>
        </div>
      </div>
      <div id="film-list"></div>
    </div>

    <div class="sel-bar">
      <div class="sel-count" id="sel-count">Ingen film valgt endnu</div>
      <div style="display:flex;gap:10px;">
        <button class="btn-secondary" onclick="goBackSetup()">‚Üê Tilbage</button>
        <button class="btn-accent" id="plan-btn" onclick="generatePlan()" disabled>Lav plan ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- LOADING PLAN -->
  <div class="loading-box" id="loading-plan" style="margin-top:40px;">
    <div class="film-strip">
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div>
    </div>
    <div class="loading-text" id="loading-plan-text">Sammens√¶tter din festivalplan...</div>
    <div class="loading-sub">Claude optimerer planen og finder hvad der ikke kan passe ind</div>
  </div>
  <div class="error-box" id="error-plan" style="margin-top:20px;"></div>

  <!-- OUTPUT -->
  <div id="output">
    <div class="output-actions">
      <button class="btn-secondary" onclick="restartPlanner()">‚Üê Ny plan</button>
      <button class="btn-accent" id="save-btn" onclick="openSaveModal()">üíæ Gem plan</button>
      <button class="btn-cyan" onclick="downloadICS()">üìÖ Tilf√∏j til kalender</button>
    </div>
    <div id="plan-cards"></div>
    <div id="missed-section"></div>
  </div>

</div>
</div>

<!-- ARCHIVE PAGE -->
<div class="page" id="page-archive">
<div class="container">
  <div id="archive-list">
    <h1 class="page-title">Mine planer</h1>
    <p class="page-sub">// Alle gemte festivalplaner</p>
    <div id="archive-cards"></div>
  </div>
  <div id="archive-view">
    <button class="back-btn" onclick="closeArchiveView()">‚Üê Alle planer</button>
    <h1 class="page-title" id="av-title"></h1>
    <p class="page-sub" id="av-sub"></p>
    <div class="output-actions" style="margin-top:16px;">
      <button class="btn-cyan" onclick="downloadICS()">üìÖ Tilf√∏j til kalender</button>
    </div>
    <div id="av-cards"></div>
    <div id="av-missed"></div>
  </div>
</div>
</div>

<!-- CAFE MODAL -->
<div class="modal-overlay" id="cafe-modal">
  <div class="modal-box">
    <div class="modal-head">
      <div><h2>Cafeer i n√¶rheden</h2><div class="modal-head-sub" id="cafe-modal-sub"></div></div>
      <button class="modal-close" onclick="closeCafeModal()">√ó</button>
    </div>
    <div class="modal-body" id="cafe-body"></div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="save-modal">
  <div class="save-box">
    <h2>Gem plan</h2>
    <p>Giv din plan et navn s√• du nemt kan finde den igen.</p>
    <label>Plannavn</label>
    <input type="text" id="plan-name-input" placeholder="fx DOX 2026..." maxlength="60" />
    <div class="modal-btns">
      <button class="btn-mcancel" onclick="closeSaveModal()">Annuller</button>
      <button class="btn-msave" onclick="confirmSave()">Gem ‚Üí</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let dates=[];
let allFilms=[];        // flat list: {title, time, venue, duration, description, date, ticketUrl}
let selectedTitles=new Set(); // unique titles selected
let currentPlanData=null;
let pdfBase64=null;
let prefs={pauses:'',count:'',start:''};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
async function sSet(k,v){if(window.storage){try{await window.storage.set(k,JSON.stringify(v));return;}catch{}}localStorage.setItem(k,JSON.stringify(v));}
async function sGet(k){if(window.storage){try{const r=await window.storage.get(k);return r?JSON.parse(r.value):null;}catch{return null;}}try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}}
async function sDel(k){if(window.storage){try{await window.storage.delete(k);}catch{}}else localStorage.removeItem(k);}
async function sList(p){if(window.storage){try{const r=await window.storage.list(p);return r?r.keys:[];}catch{return[];}}const ks=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith(p))ks.push(k);}return ks;}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',()=>{
  const ok=!!window.storage;
  document.getElementById('sdot').className='sdot'+(ok?' ok':'');
  document.getElementById('slabel').textContent=ok?'Cloud-lagring':'Lokal lagring';
  const drop=document.getElementById('pdf-drop');
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag-over');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag-over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag-over');
    const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')loadPdfFile(f);});
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeSaveModal();closeCafeModal();}
  if(e.key==='Enter'&&document.getElementById('save-modal').classList.contains('open'))confirmSave();
});

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+n).classList.add('active');
  document.querySelectorAll('.nav-tab')[n==='planner'?0:1].classList.add('active');
  if(n==='archive')renderArchive();
}

// ‚îÄ‚îÄ PDF ‚îÄ‚îÄ
function onPdfSelected(input){const f=input.files[0];if(f)loadPdfFile(f);}
function loadPdfFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    pdfBase64=e.target.result.split(',')[1];
    document.getElementById('pdf-drop').classList.add('has-file');
    document.getElementById('pdf-filename').textContent='‚úì '+file.name+' ('+Math.round(file.size/1024)+' KB)';
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function toggleKey(){const i=document.getElementById('api-key'),b=document.getElementById('toggle-btn');i.type=i.type==='password'?'text':'password';b.textContent=i.type==='password'?'Vis':'Skjul';}
function getKey(){return document.getElementById('api-key').value.trim();}
function getDates(){return['date1','date2','date3'].map(id=>document.getElementById(id).value).filter(Boolean);}
function fmtDate(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'long',day:'numeric',month:'long'});}
function fmtShort(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'short',day:'numeric',month:'short'});}

function onDateChange(idx){
  const ids=['date1','date2','date3'];
  const v=document.getElementById(ids[idx]).value;
  const card=document.getElementById('dcard-'+idx);
  if(v){
    const d=new Date(v);
    document.getElementById('dcard-date-'+idx).textContent=d.toLocaleDateString('da-DK',{day:'numeric',month:'long'});
    const wd=d.toLocaleDateString('da-DK',{weekday:'long'});
    document.getElementById('dcard-weekday-'+idx).textContent=wd.charAt(0).toUpperCase()+wd.slice(1);
    document.getElementById('dcard-status-'+idx).textContent='‚úì Valgt';
    card.classList.add('has-date');
  }else{
    document.getElementById('dcard-date-'+idx).textContent='V√¶lg dato';
    document.getElementById('dcard-weekday-'+idx).textContent='';
    document.getElementById('dcard-status-'+idx).textContent='‚óã Ikke valgt';
    card.classList.remove('has-date');
  }
}

function pickChip(gid,el){
  document.querySelectorAll('#'+gid+' .pref-chip').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  if(gid==='pg-pauses')prefs.pauses=el.dataset.val;
  if(gid==='pg-count')prefs.count=el.dataset.val;
  if(gid==='pg-start')prefs.start=el.dataset.val;
}

function prefsText(){
  const p=[];
  if(prefs.pauses==='relaxed')p.push('Vil have pauser til mad og kaffe ‚Äî mindst 60 min buffer');
  if(prefs.pauses==='packed')p.push('Vil se s√• mange film som muligt ‚Äî minimal pause (30 min buffer)');
  if(prefs.count==='1-2')p.push('Max 1-2 film om dagen');
  if(prefs.count==='3-4')p.push('Gerne 3-4 film om dagen');
  if(prefs.count==='max')p.push('S√• mange film som muligt');
  if(prefs.start==='morning')p.push('Starter gerne fra kl. 10');
  if(prefs.start==='midday')p.push('Foretr√¶kker at starte fra kl. 12');
  if(prefs.start==='afternoon')p.push('Foretr√¶kker at starte fra kl. 15');
  return p.join('. ')||'Ingen s√¶rlige pr√¶ferencer';
}

// ‚îÄ‚îÄ CLAUDE API ‚îÄ‚îÄ
async function callAI(messages, maxTokens=3000){
  const body={model:'claude-sonnet-4-20250514',max_tokens:maxTokens,messages};
  const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':getKey(),'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body:JSON.stringify(body)});
  const d=await res.json();
  if(d.error)throw new Error(d.error.message);
  return(d.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
}

function parseJSON(t){
  let c=t.replace(/```json|```/g,'').trim();
  try{return JSON.parse(c);}catch{}
  const m=c.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
  if(m){try{return JSON.parse(m[0]);}catch{}}
  throw new Error('Kunne ikke l√¶se svaret fra Claude. Pr√∏v igen.');
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
function startPlanner(){
  if(!getKey()){alert('Indtast din API-n√∏gle.');return;}
  if(!pdfBase64){alert('Upload program-PDF f√∏rst.');return;}
  dates=getDates();
  if(!dates.length){alert('V√¶lg mindst √©n festivaldato.');return;}

  allFilms=[]; selectedTitles=new Set();
  document.getElementById('screen-setup').style.display='none';
  document.getElementById('screen-select').style.display='block';
  document.getElementById('loading-fetch').style.display='block';
  document.getElementById('film-list-container').style.display='none';
  document.getElementById('error-fetch').style.display='none';
  document.getElementById('output').style.display='none';
  document.getElementById('error-plan').style.display='none';
  fetchFilms();
}

async function fetchFilms(){
  try{
    for(let i=0;i<dates.length;i++){
      const d=dates[i];
      document.getElementById('loading-text').textContent=`L√¶ser dag ${i+1} af ${dates.length}...`;
      document.getElementById('loading-sub').textContent=fmtDate(d);

      const raw=await callAI([{
        role:'user',
        content:[
          {type:'document',source:{type:'base64',media_type:'application/pdf',data:pdfBase64}},
          {type:'text',text:`CPH:DOX 2026 program-PDF.

Udtr√¶k KUN filmvisninger for datoen ${d} (${fmtDate(d)}).

Returner KUN et JSON array ‚Äî ingen markdown:
[{"title":"...","time":"14:00","venue":"...","duration":"85 min","description":"2 s√¶tninger dansk om filmens indhold","ticketUrl":"https://cphdox.dk/film/filmtitel-med-bindestreger"}]

Inkluder ALLE film der vises denne dag. Samme film med flere visninger = separate objekter. Svar starter med [`}
        ]
      }],8000);

      const films=parseJSON(raw);
      if(!Array.isArray(films))throw new Error(`Dag ${i+1}: uventet format`);
      films.forEach(f=>allFilms.push({...f,date:d}));
    }

    document.getElementById('loading-fetch').style.display='none';
    renderFilmList();
  }catch(err){
    document.getElementById('loading-fetch').style.display='none';
    const eb=document.getElementById('error-fetch');
    eb.style.display='block';
    eb.textContent='‚ö† '+err.message;
  }
}

// ‚îÄ‚îÄ FILM LIST ‚îÄ‚îÄ
function renderFilmList(){
  // Deduplicate by title for display ‚Äî group all showings under each unique title
  const byTitle={};
  allFilms.forEach(f=>{
    if(!byTitle[f.title])byTitle[f.title]={...f,showings:[]};
    byTitle[f.title].showings.push({date:f.date,time:f.time,venue:f.venue,duration:f.duration});
  });

  // Group by day
  const byDay={};
  dates.forEach(d=>{byDay[d]=[];});
  // For each unique title, assign it to the day of its first showing
  Object.values(byTitle).forEach(f=>{
    // Group showings by day
    const dayShowings={};
    f.showings.forEach(s=>{
      if(!dayShowings[s.date])dayShowings[s.date]=[];
      dayShowings[s.date].push(s);
    });
    // Assign to first matching selected day
    for(const d of dates){
      if(dayShowings[d]){
        byDay[d].push({...f,primaryDay:d,dayShowings});
        break;
      }
    }
  });

  // Sort each day by first showing time
  dates.forEach(d=>{
    byDay[d].sort((a,b)=>{
      const at=a.dayShowings[d]?.[0]?.time||'99:99';
      const bt=b.dayShowings[d]?.[0]?.time||'99:99';
      return at.localeCompare(bt);
    });
  });

  const totalUnique=Object.keys(byTitle).length;
  document.getElementById('film-list-meta').textContent=`${totalUnique} unikke film fundet ¬∑ Klik for at v√¶lge`;

  const listEl=document.getElementById('film-list');
  listEl.innerHTML='';

  dates.forEach(d=>{
    if(!byDay[d].length)return;
    const grp=document.createElement('div');
    grp.className='day-group';
    grp.innerHTML=`<div class="day-group-label">${fmtDate(d)}</div>`;

    byDay[d].forEach(f=>{
      const row=document.createElement('div');
      row.className='film-row';
      row.dataset.title=f.title;

      // Build showings summary across all days
      const allShowingsText=dates.flatMap(dd=>(f.dayShowings[dd]||[]).map(s=>
        `${fmtShort(dd)} ${s.time}${s.venue?' ¬∑ '+s.venue:''}`
      )).join(' &nbsp;|&nbsp; ');

      const primaryShowing=f.dayShowings[d]?.[0]||{};

      row.innerHTML=`
        <div class="film-check">‚óã</div>
        <div class="film-info">
          <div class="film-time">${primaryShowing.time||'?'}</div>
          <div class="film-title">${f.title}</div>
          <div class="film-meta">üìç ${primaryShowing.venue||''} ¬∑ ${primaryShowing.duration||''}</div>
          ${f.description?`<div class="film-desc">${f.description}</div>`:''}
          ${dates.length>1?`<div class="film-meta" style="margin-top:4px;opacity:0.7;">Alle visninger: ${allShowingsText}</div>`:''}
        </div>`;

      row.addEventListener('click',()=>toggleFilm(f.title,row));
      grp.appendChild(row);
    });

    listEl.appendChild(grp);
  });

  document.getElementById('film-list-container').style.display='block';
  updateSelBar();
}

function toggleFilm(title,row){
  if(selectedTitles.has(title)){
    selectedTitles.delete(title);
    row.classList.remove('selected');
    row.querySelector('.film-check').textContent='‚óã';
  }else{
    selectedTitles.add(title);
    row.classList.add('selected');
    row.querySelector('.film-check').textContent='‚úì';
  }
  updateSelBar();
}

function selectAll(){
  document.querySelectorAll('.film-row').forEach(row=>{
    const title=row.dataset.title;
    selectedTitles.add(title);
    row.classList.add('selected');
    row.querySelector('.film-check').textContent='‚úì';
  });
  updateSelBar();
}
function selectNone(){
  selectedTitles.clear();
  document.querySelectorAll('.film-row').forEach(row=>{
    row.classList.remove('selected');
    row.querySelector('.film-check').textContent='‚óã';
  });
  updateSelBar();
}

function updateSelBar(){
  const n=selectedTitles.size;
  document.getElementById('sel-count').innerHTML=n===0?'Ingen film valgt':`<strong>${n}</strong> film valgt`;
  document.getElementById('plan-btn').disabled=n===0;
}

function goBackSetup(){
  document.getElementById('screen-select').style.display='none';
  document.getElementById('screen-setup').style.display='block';
}
function restartPlanner(){
  document.getElementById('output').style.display='none';
  document.getElementById('screen-setup').style.display='block';
  currentPlanData=null;
}

// ‚îÄ‚îÄ GENERATE PLAN ‚îÄ‚îÄ
async function generatePlan(){
  if(!selectedTitles.size){alert('V√¶lg mindst √©n film.');return;}

  // Collect all showings for selected titles
  const selectedFilms=allFilms.filter(f=>selectedTitles.has(f.title));

  // Group by title with all showings
  const byTitle={};
  selectedFilms.forEach(f=>{
    if(!byTitle[f.title])byTitle[f.title]={title:f.title,description:f.description,ticketUrl:f.ticketUrl,showings:[]};
    byTitle[f.title].showings.push({date:f.date,dateLabel:fmtDate(f.date),time:f.time,venue:f.venue,duration:f.duration});
  });

  document.getElementById('screen-select').style.display='none';
  document.getElementById('loading-plan').style.display='block';
  document.getElementById('error-plan').style.display='none';
  document.getElementById('output').style.display='none';

  const msgs=['Analyserer dine valg...','Finder optimal fordeling...','Beregner gangtider...','Identificerer film der ikke passer...','N√¶sten klar...'];
  let mi=0;
  const lt=setInterval(()=>{document.getElementById('loading-plan-text').textContent=msgs[++mi%msgs.length];},2500);

  const filmList=Object.values(byTitle).map(f=>
    `${f.title}: ${f.showings.map(s=>`${s.dateLabel} ${s.time} @ ${s.venue} (${s.duration||'?'})`).join(', ')}`
  ).join('\n');

  try{
    const raw=await callAI([{
      role:'user',
      content:`Lav en optimal CPH:DOX festivalplan. Svar KUN med JSON.

VIGTIGE REGLER:
- Hver film m√• KUN forekomme √âN gang i planen ‚Äî selv om den vises flere dage
- V√¶lg den bedste visning af hver film baseret p√• pr√¶ferencer og logistik
- Film der ikke kan passes ind (overlap, for mange om dagen) samles i "missed_films"
- Beregn realistiske gangtider i K√∏benhavn (10-20 min mellem de fleste biografer)

Festivaldage: ${dates.map(d=>fmtDate(d)+' ('+d+')').join(', ')}
Pr√¶ferencer: ${prefsText()}

Valgte film med alle mulige visninger:
${filmList}

JSON format:
{
  "days": [
    {
      "date": "2026-03-14",
      "date_label": "L√∏rdag 14. marts",
      "screenings": [
        {
          "time": "13:00",
          "title": "...",
          "venue": "...",
          "duration": "90 min",
          "description": "...",
          "ticketUrl": "https://cphdox.dk/film/...",
          "distance_to_next": 1.2,
          "walk_minutes_to_next": 15
        }
      ]
    }
  ],
  "missed_films": [
    {
      "title": "...",
      "reason": "Kort forklaring p√• dansk hvorfor den ikke passede ind",
      "all_showings": [
        {"date_label": "L√∏rdag 14. marts", "time": "14:00", "venue": "Empire Bio"}
      ]
    }
  ],
  "notes": "Kort forklaring af planens logik"
}

Filmdata: ${JSON.stringify(Object.values(byTitle))}`
    }], 4000);

    const plan=parseJSON(raw);
    clearInterval(lt);
    currentPlanData=plan;
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('output').style.display='block';
    renderPlan(plan, document.getElementById('plan-cards'), document.getElementById('missed-section'));
  }catch(err){
    clearInterval(lt);
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('screen-select').style.display='block';
    document.getElementById('error-plan').style.display='block';
    document.getElementById('error-plan').textContent='‚ö† '+err.message;
  }
}

// ‚îÄ‚îÄ RENDER PLAN ‚îÄ‚îÄ
function renderPlan(data, planContainer, missedContainer){
  planContainer.innerHTML='';
  if(!data.days?.length){planContainer.innerHTML='<p style="color:var(--muted);">Ingen plan.</p>';return;}

  data.days.forEach(day=>{
    const card=document.createElement('div');
    card.className='day-card';
    const hdr=document.createElement('div');
    hdr.className='day-card-header';
    hdr.innerHTML=`<span class="day-card-title">${day.date_label||day.date}</span><span class="day-card-date">${day.date}</span>`;
    card.appendChild(hdr);

    (day.screenings||[]).forEach((s,i)=>{
      const sc=document.createElement('div');
      sc.className='screening';
      const tickUrl=s.ticketUrl||`https://cphdox.dk/film/${(s.title||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')}`;
      const venueEsc=(s.venue||'').replace(/'/g,"\\'");
      sc.innerHTML=`
        <div class="sc-time">${s.time}</div>
        <div class="sc-title">${s.title}</div>
        <div class="sc-venue">üìç ${s.venue||''}</div>
        ${s.duration?`<div class="sc-dur">${s.duration}</div>`:''}
        ${s.description?`<div class="sc-desc">${s.description}</div>`:''}
        <div class="sc-btns">
          <a href="${tickUrl}" target="_blank" class="btn-ticket">üéü K√∏b billet</a>
          <button class="btn-cafe" onclick="openCafeModal('${venueEsc}')">‚òï Cafeer</button>
        </div>`;
      card.appendChild(sc);

      const next=day.screenings[i+1];
      if(next){
        const t=document.createElement('div');t.className='travel-badge';
        if((s.venue||'')!==(next.venue||'')){
          const fr=encodeURIComponent((s.venue||'')+', Copenhagen');
          const to=encodeURIComponent((next.venue||'')+', Copenhagen');
          t.innerHTML=`<div class="travel-info">üö∂ ${s.distance_to_next||'?'} km ¬∑ ca. ${s.walk_minutes_to_next||'?'} min ‚Üí ${next.venue}</div>
            <a href="https://www.google.com/maps/dir/?api=1&origin=${fr}&destination=${to}&travelmode=walking" target="_blank" class="btn-maps">Maps ‚Üí</a>`;
        }else{
          t.innerHTML=`<div class="travel-info">üìç Bliv i ${s.venue||''}</div>`;
        }
        card.appendChild(t);
      }
    });
    planContainer.appendChild(card);
  });

  if(data.notes){
    const nb=document.createElement('div');nb.className='note-box';nb.style.marginTop='20px';
    nb.innerHTML=`<strong>Planens logik:</strong> ${data.notes}`;
    planContainer.appendChild(nb);
  }

  // Missed films
  missedContainer.innerHTML='';
  if(data.missed_films?.length){
    const sec=document.createElement('div');
    sec.className='missed-section';
    sec.innerHTML=`
      <div class="missed-header">
        <div>
          <h3>üé¨ Film der ikke kunne passes ind</h3>
          <p style="margin-top:4px;">${data.missed_films.length} film kunne ikke placeres i planen</p>
        </div>
      </div>`;
    data.missed_films.forEach(f=>{
      const mf=document.createElement('div');
      mf.className='missed-film';
      const showings=(f.all_showings||[]).map(s=>
        `<span class="missed-showing-time">${s.date_label} ${s.time}</span> ¬∑ ${s.venue||''}`
      ).join('<br>');
      mf.innerHTML=`
        <div class="missed-title">${f.title}</div>
        <div class="missed-showings" style="margin-top:4px;color:var(--muted);font-size:0.7rem;">${f.reason||''}</div>
        ${showings?`<div class="missed-showings" style="margin-top:6px;">Vises:<br>${showings}</div>`:''}`;
      sec.appendChild(mf);
    });
    missedContainer.appendChild(sec);
  }
}

// ‚îÄ‚îÄ CAFE MODAL ‚îÄ‚îÄ
function openCafeModal(venue){
  document.getElementById('cafe-modal-sub').textContent='T√¶t p√• '+venue;
  document.getElementById('cafe-body').innerHTML='<div style="text-align:center;padding:32px;font-size:0.75rem;color:var(--muted);">‚è≥ Finder cafeer...</div>';
  document.getElementById('cafe-modal').classList.add('open');
  callAI([{role:'user',content:`Find 5 cafeer eller restauranter t√¶t p√• ${venue} i K√∏benhavn. JSON kun:
[{"name":"...","type":"Caf√©","distance":"3 min gang","description":"1 linje","mapsUrl":"https://maps.google.com/?q=...+Copenhagen"}]`}])
  .then(raw=>{
    const cafes=parseJSON(raw);
    document.getElementById('cafe-body').innerHTML=cafes.map(c=>`
      <div class="cafe-card">
        <div class="cafe-name">${c.name}<span class="cafe-type">${c.type||''}</span></div>
        <div class="cafe-meta"><span style="color:var(--accent);">üìç ${c.distance||''}</span> ‚Äî ${c.description||''}
          ${c.mapsUrl?`<br><a href="${c.mapsUrl}" target="_blank" style="color:var(--accent2);font-size:0.67rem;text-decoration:none;">Google Maps ‚Üí</a>`:''}
        </div>
      </div>`).join('');
  }).catch(err=>{document.getElementById('cafe-body').innerHTML=`<p style="color:var(--red);font-size:0.78rem;">${err.message}</p>`;});
}
function closeCafeModal(){document.getElementById('cafe-modal').classList.remove('open');}

// ‚îÄ‚îÄ ICS EXPORT ‚îÄ‚îÄ
function downloadICS(){
  if(!currentPlanData?.days){alert('Ingen plan at eksportere.');return;}
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CPH:DOX Planner//DA','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
  currentPlanData.days.forEach(day=>{
    (day.screenings||[]).forEach((s,i)=>{
      const ds=day.date.replace(/-/g,'');
      const sh=parseInt(s.time?.split(':')?.[0]||12),sm=parseInt(s.time?.split(':')?.[1]||0);
      const dur=parseInt((s.duration||'90 min').match(/\d+/)?.[0]||90);
      const te=sh*60+sm+dur,eh=Math.floor(te/60),em=te%60;
      const dtS=`${ds}T${pad(sh)}${pad(sm)}00`,dtE=`${ds}T${pad(eh)}${pad(em)}00`;
      lines.push('BEGIN:VEVENT',`UID:cphdox26-${ds}-${i}@planner`,
        `DTSTART;TZID=Europe/Copenhagen:${dtS}`,`DTEND;TZID=Europe/Copenhagen:${dtE}`,
        `SUMMARY:üé¨ ${s.title}`,`LOCATION:${s.venue||''}`,
        `DESCRIPTION:${(s.description||'').replace(/\n/g,'\\n')}\\n\\nBillet: ${s.ticketUrl||'cphdox.dk'}`,
        'BEGIN:VALARM','TRIGGER:-PT30M','ACTION:DISPLAY',`DESCRIPTION:Om 30 min: ${s.title}`,'END:VALARM','END:VEVENT');
      const next=day.screenings[i+1];
      if(next&&(s.venue||'')!==(next.venue||'')&&s.walk_minutes_to_next){
        const tw=te+parseInt(s.walk_minutes_to_next);
        lines.push('BEGIN:VEVENT',`UID:travel-${ds}-${i}@planner`,
          `DTSTART;TZID=Europe/Copenhagen:${dtE}`,
          `DTEND;TZID=Europe/Copenhagen:${ds}T${pad(Math.floor(tw/60))}${pad(tw%60)}00`,
          `SUMMARY:üö∂ G√• til ${next.venue}`,`DESCRIPTION:Ca. ${s.walk_minutes_to_next} min fra ${s.venue} til ${next.venue}`,'END:VEVENT');
      }
    });
  });
  lines.push('END:VCALENDAR');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lines.join('\r\n')],{type:'text/calendar'}));
  a.download='cphdox-2026.ics';a.click();
}

// ‚îÄ‚îÄ SAVE / ARCHIVE ‚îÄ‚îÄ
function openSaveModal(){if(!currentPlanData)return;document.getElementById('plan-name-input').value='';document.getElementById('save-modal').classList.add('open');setTimeout(()=>document.getElementById('plan-name-input').focus(),100);}
function closeSaveModal(){document.getElementById('save-modal').classList.remove('open');}
async function confirmSave(){
  const name=document.getElementById('plan-name-input').value.trim();
  if(!name){alert('Giv planen et navn.');return;}
  const id='plan:'+Date.now();
  await sSet(id,{id,name,savedAt:new Date().toISOString(),data:currentPlanData});
  closeSaveModal();
  const btn=document.getElementById('save-btn');
  btn.textContent='‚úì Gemt!';
  btn.style.cssText+='background:rgba(72,240,168,0.12);border-color:rgba(72,240,168,0.3);color:#48f0a8;';
  setTimeout(()=>{btn.textContent='üíæ Gem plan';btn.style.cssText='';},2200);
}

async function renderArchive(){
  document.getElementById('archive-list').style.display='block';
  document.getElementById('archive-view').style.display='none';
  const keys=await sList('plan:');
  const container=document.getElementById('archive-cards');
  if(!keys.length){container.innerHTML='<div class="archive-empty"><p>Ingen gemte planer endnu.</p></div>';return;}
  const plans=(await Promise.all(keys.map(k=>sGet(k)))).filter(Boolean);
  plans.sort((a,b)=>new Date(b.savedAt)-new Date(a.savedAt));
  container.innerHTML='';
  plans.forEach(plan=>{
    const card=document.createElement('div');card.className='archive-card';
    const days=plan.data.days||[];
    const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
    const missed=(plan.data.missed_films||[]).length;
    const saved=new Date(plan.savedAt).toLocaleDateString('da-DK',{day:'numeric',month:'long',year:'numeric'});
    const pills=days.map(d=>`<span class="day-pill">${(d.date_label||d.date).split(' ').slice(0,2).join(' ')}</span>`).join('');
    card.innerHTML=`<button class="arc-del" onclick="delPlan(event,'${plan.id}')">Slet</button>
      <div class="arc-name">${plan.name}</div>
      <div class="arc-meta">Gemt ${saved} ¬∑ ${films.length} film i planen${missed?' ¬∑ '+missed+' ikke passet ind':''}</div>
      <div class="arc-days">${pills}</div>`;
    card.addEventListener('click',e=>{if(e.target.classList.contains('arc-del'))return;openAV(plan);});
    container.appendChild(card);
  });
}

function openAV(plan){
  document.getElementById('archive-list').style.display='none';
  document.getElementById('archive-view').style.display='block';
  const days=plan.data.days||[];
  const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
  document.getElementById('av-title').textContent=plan.name;
  document.getElementById('av-sub').textContent=`// ${films.length} film i planen`;
  currentPlanData=plan.data;
  renderPlan(plan.data,document.getElementById('av-cards'),document.getElementById('av-missed'));
}
function closeArchiveView(){document.getElementById('archive-list').style.display='block';document.getElementById('archive-view').style.display='none';}
async function delPlan(e,id){e.stopPropagation();if(!confirm('Slet denne plan?'))return;await sDel(id);renderArchive();}
</script>
</body>
</html>
