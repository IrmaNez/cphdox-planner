<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPH:DOX Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: rgba(255,255,255,0.08);
    --accent: #e8f048;
    --accent2: #48c8f0;
    --text: #f0ede8;
    --muted: #7a7a8a;
    --red: #f04848;
    --green: #48f0a8;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background:var(--bg); color:var(--text);
    font-family:'DM Mono',monospace; min-height:100vh;
  }

  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 0%, rgba(232,240,72,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(72,200,240,0.05) 0%, transparent 60%);
  }

  /* â”€â”€ NAV â”€â”€ */
  nav {
    position:sticky; top:0; z-index:100;
    background:rgba(10,10,15,0.94); backdrop-filter:blur(14px);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; padding:0 24px; height:56px;
  }
  .nav-brand { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--text); margin-right:32px; }
  .nav-brand span { color:var(--accent); }
  .nav-tabs { display:flex; gap:4px; flex:1; }
  .nav-tab {
    padding:8px 18px; font-family:'DM Mono',monospace; font-size:0.72rem;
    letter-spacing:0.12em; text-transform:uppercase; cursor:pointer;
    border:1px solid transparent; background:none; color:var(--muted); transition:all 0.18s;
  }
  .nav-tab:hover { color:var(--text); }
  .nav-tab.active { color:var(--accent); border-color:rgba(232,240,72,0.25); background:rgba(232,240,72,0.06); }
  .storage-status { font-size:0.65rem; color:var(--muted); display:flex; align-items:center; gap:6px; margin-left:auto; }
  .sdot { width:6px; height:6px; border-radius:50%; background:var(--muted); }
  .sdot.ok { background:var(--accent); }

  /* â”€â”€ PAGES â”€â”€ */
  .page { display:none; }
  .page.active { display:block; }
  .container { max-width:900px; margin:0 auto; padding:40px 20px 100px; position:relative; z-index:1; }

  .page-title { font-family:'DM Serif Display',serif; font-size:clamp(1.8rem,4vw,2.8rem); margin-bottom:6px; line-height:1.1; }
  .page-sub { font-size:0.75rem; color:var(--muted); letter-spacing:0.05em; margin-bottom:40px; }

  .section-label {
    font-size:0.62rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--accent);
    margin-bottom:14px; display:flex; align-items:center; gap:12px;
  }
  .section-label::after { content:''; flex:1; height:1px; background:var(--border); }
  .section { margin-bottom:32px; }

  /* â”€â”€ FORM â”€â”€ */
  label { display:block; font-size:0.68rem; letter-spacing:0.1em; color:var(--muted); text-transform:uppercase; margin-bottom:7px; margin-top:16px; }
  label:first-child { margin-top:0; }
  input[type="text"], input[type="date"], input[type="password"], textarea {
    width:100%; background:var(--surface); border:1px solid var(--border);
    color:var(--text); font-family:'DM Mono',monospace; font-size:0.85rem;
    padding:11px 14px; outline:none; transition:border-color 0.2s, background 0.2s;
  }
  input:focus, textarea:focus { border-color:rgba(232,240,72,0.35); background:var(--surface2); }
  textarea { resize:vertical; min-height:70px; line-height:1.6; }
  .pref-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media(max-width:560px) { .pref-row { grid-template-columns:1fr; } }

  /* â”€â”€ DAY SELECT CARDS â”€â”€ */
  .day-cards-grid {
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;
  }
  @media(max-width:560px) { .day-cards-grid { grid-template-columns:1fr; } }

  .day-select-card {
    background:var(--surface); border:1px solid var(--border);
    padding:24px 20px; cursor:pointer; transition:all 0.22s;
    position:relative; overflow:hidden; min-height:140px;
    display:flex; flex-direction:column; justify-content:space-between;
  }
  .day-select-card:hover { border-color:rgba(232,240,72,0.3); background:var(--surface2); }
  .day-select-card.has-date { border-color:rgba(232,240,72,0.4); background:rgba(232,240,72,0.04); }
  .day-select-card.has-date:hover { border-color:rgba(232,240,72,0.6); background:rgba(232,240,72,0.08); }

  .day-select-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg, var(--accent), transparent);
    opacity:0; transition:opacity 0.22s;
  }
  .day-select-card.has-date::before { opacity:1; }

  .dcard-num {
    font-size:0.6rem; letter-spacing:0.2em; text-transform:uppercase;
    color:var(--muted); margin-bottom:12px;
  }
  .day-select-card.has-date .dcard-num { color:var(--accent); }

  .dcard-date {
    font-family:'DM Serif Display',serif; font-size:1.6rem; line-height:1;
    color:var(--muted); margin-bottom:4px; transition:color 0.22s;
  }
  .day-select-card.has-date .dcard-date { color:var(--text); }

  .dcard-weekday {
    font-size:0.72rem; color:var(--muted); letter-spacing:0.05em;
    margin-bottom:16px; min-height:1em;
  }
  .day-select-card.has-date .dcard-weekday { color:var(--accent); }

  .dcard-status {
    font-size:0.65rem; color:var(--muted); letter-spacing:0.08em;
    text-transform:uppercase;
  }
  .day-select-card.has-date .dcard-status { color:var(--green); }

  .dcard-hidden-input {
    position:absolute; opacity:0; pointer-events:none;
    width:1px; height:1px; top:0; left:0;
  }

  /* â”€â”€ PROGRESS STEPPER â”€â”€ */
  .stepper {
    display:flex; margin-bottom:36px; overflow:hidden;
    border:1px solid var(--border);
  }
  .step-item {
    flex:1; padding:12px 10px; text-align:center;
    font-size:0.6rem; letter-spacing:0.12em; text-transform:uppercase;
    color:var(--muted); background:var(--surface); border-right:1px solid var(--border);
    transition:all 0.3s; position:relative;
  }
  .step-item:last-child { border-right:none; }
  .step-item.active { color:var(--accent); background:rgba(232,240,72,0.06); }
  .step-item.done { color:var(--green); background:rgba(72,240,168,0.04); }
  .step-num { font-size:1rem; display:block; margin-bottom:3px; font-family:'DM Serif Display',serif; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn-primary {
    display:flex; align-items:center; justify-content:center; gap:8px;
    width:100%; padding:14px; background:var(--accent); color:#0a0a0f;
    font-family:'DM Mono',monospace; font-size:0.84rem; font-weight:600;
    letter-spacing:0.08em; text-transform:uppercase; cursor:pointer; border:none;
    transition:all 0.18s; margin-top:24px;
  }
  .btn-primary:hover { background:#f0fa60; transform:translateY(-1px); }
  .btn-primary:disabled { background:var(--surface2); color:var(--muted); cursor:not-allowed; transform:none; }

  .btn-secondary {
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 20px; background:none; border:1px solid var(--border); color:var(--muted);
    font-family:'DM Mono',monospace; font-size:0.72rem; letter-spacing:0.1em;
    text-transform:uppercase; cursor:pointer; transition:all 0.18s;
  }
  .btn-secondary:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  .btn-accent {
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 20px; background:rgba(232,240,72,0.08); border:1px solid rgba(232,240,72,0.3);
    color:var(--accent); font-family:'DM Mono',monospace; font-size:0.72rem;
    letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.18s;
  }
  .btn-accent:hover { background:rgba(232,240,72,0.16); }

  /* â”€â”€ DAY HEADER IN PICKER â”€â”€ */
  .day-header-bar {
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; background:var(--surface2); border:1px solid var(--border);
    margin-bottom:16px;
  }
  .day-header-bar h2 { font-family:'DM Serif Display',serif; font-size:1.4rem; }
  .day-progress { font-size:0.68rem; color:var(--accent); letter-spacing:0.1em; }

  /* â”€â”€ FILM CARDS â”€â”€ */
  .film-grid { display:grid; gap:10px; }

  .film-card {
    background:var(--surface); border:1px solid var(--border);
    display:grid; grid-template-columns:auto 1fr; gap:14px;
    padding:16px 18px; cursor:pointer; transition:all 0.18s; align-items:start;
  }
  .film-card:hover { border-color:rgba(232,240,72,0.2); background:var(--surface2); }
  .film-card.selected { border-color:rgba(232,240,72,0.5); background:rgba(232,240,72,0.05); }

  .film-check {
    width:18px; height:18px; border:1px solid var(--border);
    background:var(--surface2); display:flex; align-items:center; justify-content:center;
    flex-shrink:0; margin-top:2px; transition:all 0.18s;
  }
  .film-card.selected .film-check { background:var(--accent); border-color:var(--accent); }
  .check-inner { width:10px; height:10px; background:var(--bg); display:none; }
  .film-card.selected .check-inner { display:block; }

  .film-title { font-size:0.92rem; margin-bottom:3px; }
  .film-times { font-size:0.68rem; color:var(--accent); letter-spacing:0.06em; margin-bottom:6px; }
  .film-desc { font-size:0.72rem; color:var(--muted); line-height:1.65; margin-bottom:8px; }

  .btn-trailer {
    display:inline-flex; align-items:center; gap:5px;
    padding:5px 11px; background:rgba(72,200,240,0.08); border:1px solid rgba(72,200,240,0.22);
    color:var(--accent2); font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase;
    text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s;
  }
  .btn-trailer:hover { background:rgba(72,200,240,0.16); }

  /* â”€â”€ SELECTION FOOTER â”€â”€ */
  .selection-bar {
    position:sticky; bottom:0; z-index:50;
    background:rgba(10,10,15,0.96); backdrop-filter:blur(12px);
    border-top:1px solid var(--border); padding:14px 20px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    margin:0 -20px;
  }
  .sel-count { font-size:0.75rem; color:var(--muted); }
  .sel-count strong { color:var(--accent); }
  .sel-btns { display:flex; gap:10px; }

  /* â”€â”€ LOADING â”€â”€ */
  .loading-box {
    display:none; text-align:center; padding:48px 20px;
    border:1px solid var(--border); background:var(--surface);
  }
  .film-strip { display:flex; gap:4px; justify-content:center; margin-bottom:16px; }
  .film-frame { width:13px; height:19px; background:var(--surface2); border:1px solid var(--border); animation:filmroll 1.2s ease-in-out infinite; }
  .film-frame:nth-child(2){animation-delay:.1s} .film-frame:nth-child(3){animation-delay:.2s}
  .film-frame:nth-child(4){animation-delay:.3s} .film-frame:nth-child(5){animation-delay:.4s}
  @keyframes filmroll{0%,100%{background:var(--surface2);border-color:var(--border)}50%{background:var(--accent);border-color:var(--accent)}}
  .loading-text { font-size:0.73rem; color:var(--muted); letter-spacing:0.1em; }
  .loading-sub { font-size:0.65rem; color:var(--muted); margin-top:8px; opacity:0.6; }

  /* â”€â”€ ERROR / NOTE â”€â”€ */
  .error-box { border:1px solid rgba(240,72,72,0.3); background:rgba(240,72,72,0.07); padding:16px; color:var(--red); font-size:0.78rem; line-height:1.6; display:none; margin-bottom:16px; }
  .note-box { background:rgba(232,240,72,0.04); border:1px solid rgba(232,240,72,0.14); padding:14px 18px; font-size:0.73rem; color:var(--muted); line-height:1.7; }
  .note-box strong { color:var(--accent); }
  .note-box a { color:var(--accent); text-decoration:none; }

  /* â”€â”€ OUTPUT / PLAN â”€â”€ */
  #output { display:none; animation:fadeIn 0.4s ease; }
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .output-actions { display:flex; gap:10px; margin-bottom:24px; flex-wrap:wrap; }

  .day-card { background:var(--surface); border:1px solid var(--border); margin-bottom:20px; overflow:hidden; }
  .day-card-header { padding:14px 22px; background:var(--surface2); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .day-card-title { font-family:'DM Serif Display',serif; font-size:1.2rem; }
  .day-card-date { font-size:0.68rem; color:var(--accent); letter-spacing:0.1em; }

  .screening { padding:18px 22px; border-bottom:1px solid var(--border); }
  .screening:last-child { border-bottom:none; }
  .sc-time { font-family:'DM Serif Display',serif; font-style:italic; font-size:1.25rem; color:var(--accent); margin-bottom:3px; }
  .sc-title { font-size:0.92rem; margin-bottom:3px; font-weight:500; }
  .sc-venue { font-size:0.72rem; color:var(--muted); }
  .sc-dur { font-size:0.67rem; color:var(--muted); margin-top:2px; }
  .sc-desc { font-size:0.73rem; color:var(--muted); line-height:1.65; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
  .sc-btns { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

  .btn-ticket {
    display:inline-flex; align-items:center; gap:5px;
    background:rgba(232,240,72,0.07); border:1px solid rgba(232,240,72,0.22);
    color:var(--accent); padding:6px 13px; font-size:0.67rem; letter-spacing:0.1em;
    text-transform:uppercase; text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s;
  }
  .btn-ticket:hover { background:rgba(232,240,72,0.14); }
  .btn-trailer-sm {
    display:inline-flex; align-items:center; gap:5px;
    background:rgba(72,200,240,0.08); border:1px solid rgba(72,200,240,0.22);
    color:var(--accent2); padding:6px 13px; font-size:0.67rem; letter-spacing:0.1em;
    text-transform:uppercase; text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s;
  }
  .btn-trailer-sm:hover { background:rgba(72,200,240,0.16); }

  .travel-badge {
    display:flex; align-items:center; gap:12px; padding:11px 22px;
    background:rgba(72,200,240,0.04);
    border-top:1px dashed rgba(72,200,240,0.18); border-bottom:1px dashed rgba(72,200,240,0.18);
  }
  .travel-info { font-size:0.72rem; color:var(--accent2); }
  .btn-maps {
    margin-left:auto; display:inline-flex; align-items:center; gap:5px;
    background:rgba(72,200,240,0.1); border:1px solid rgba(72,200,240,0.28);
    color:var(--accent2); padding:6px 13px; font-size:0.67rem; letter-spacing:0.1em;
    text-transform:uppercase; text-decoration:none; font-family:'DM Mono',monospace;
    transition:all 0.18s; flex-shrink:0;
  }
  .btn-maps:hover { background:rgba(72,200,240,0.18); }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.78); align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid rgba(232,240,72,0.2); padding:32px; max-width:420px; width:90%; animation:fadeUp 0.25s ease; }
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .modal h2 { font-family:'DM Serif Display',serif; font-size:1.4rem; margin-bottom:8px; }
  .modal p { font-size:0.75rem; color:var(--muted); margin-bottom:20px; }
  .modal-btns { display:flex; gap:10px; margin-top:20px; }
  .btn-modal-save { flex:1; background:var(--accent); color:#0a0a0f; font-family:'DM Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; padding:11px; cursor:pointer; border:none; font-weight:600; transition:background 0.18s; }
  .btn-modal-save:hover { background:#f0fa60; }
  .btn-modal-cancel { padding:11px 18px; background:none; border:1px solid var(--border); color:var(--muted); font-family:'DM Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; }
  .btn-modal-cancel:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  /* â”€â”€ ARCHIVE â”€â”€ */
  .archive-empty { text-align:center; padding:60px 20px; border:1px solid var(--border); background:var(--surface); }
  .archive-empty p { font-size:0.8rem; color:var(--muted); line-height:1.7; }
  .archive-card { background:var(--surface); border:1px solid var(--border); padding:20px 22px; cursor:pointer; transition:all 0.18s; position:relative; margin-bottom:12px; }
  .archive-card:hover { border-color:rgba(232,240,72,0.25); background:var(--surface2); }
  .arc-name { font-family:'DM Serif Display',serif; font-size:1.15rem; margin-bottom:5px; }
  .arc-meta { font-size:0.7rem; color:var(--muted); line-height:1.6; }
  .arc-days { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
  .day-pill { font-size:0.65rem; padding:3px 9px; background:rgba(232,240,72,0.07); border:1px solid rgba(232,240,72,0.18); color:var(--accent); }
  .arc-actions { position:absolute; top:14px; right:14px; }
  .btn-del { background:none; border:1px solid var(--border); color:var(--muted); padding:5px 10px; font-size:0.7rem; cursor:pointer; font-family:'DM Mono',monospace; transition:all 0.18s; }
  .btn-del:hover { border-color:rgba(240,72,72,0.4); color:var(--red); }
  #archive-view { display:none; }
  .back-btn { display:inline-flex; align-items:center; gap:8px; background:none; border:1px solid var(--border); color:var(--muted); padding:8px 16px; font-family:'DM Mono',monospace; font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; margin-bottom:28px; }
  .back-btn:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  ::-webkit-scrollbar{width:4px} ::-webkit-scrollbar-track{background:var(--bg)} ::-webkit-scrollbar-thumb{background:var(--border)}
</style>
</head>
<body>

<nav>
  <div class="nav-brand">CPH<span>:</span>DOX</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('planner')">PlanlÃ¦gger</button>
    <button class="nav-tab" onclick="showPage('archive')">Mine planer</button>
  </div>
  <div class="storage-status">
    <div class="sdot" id="sdot"></div>
    <span id="slabel">...</span>
  </div>
</nav>

<!-- â•â• PLANNER PAGE â•â• -->
<div class="page active" id="page-planner">
<div class="container">

  <!-- SETUP SCREEN -->
  <div id="screen-setup">
    <h1 class="page-title">Lav en festivalplan</h1>
    <p class="page-sub">// VÃ¦lg dine tre dage â€” programmet hentes Ã©n dag ad gangen</p>

    <div class="section">
      <div class="section-label">01 â€” API-nÃ¸gle</div>
      <div style="position:relative;">
        <input type="password" id="api-key" placeholder="sk-ant-..." style="padding-right:80px;" />
        <button onclick="toggleKey()" id="toggle-btn" style="position:absolute;right:0;top:0;bottom:0;background:var(--surface2);border:none;border-left:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;padding:0 13px;cursor:pointer;text-transform:uppercase;">Vis</button>
      </div>
      <div style="font-size:0.68rem;color:var(--muted);margin-top:7px;line-height:1.6;">Hent den pÃ¥ <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a></div>
    </div>

    <div class="section">
      <div class="section-label">02 â€” Festivaldage (vÃ¦lg op til 3)</div>
      <div class="day-cards-grid">
        <div class="day-select-card" id="dcard-0" onclick="openDatePicker(0)">
          <div class="dcard-num">Dag 1</div>
          <div class="dcard-date" id="dcard-date-0">Klik for at vÃ¦lge</div>
          <div class="dcard-weekday" id="dcard-weekday-0"></div>
          <div class="dcard-status" id="dcard-status-0">â—‹ Ikke valgt</div>
          <input type="date" id="date1" class="dcard-hidden-input" onchange="onDateChange(0)" />
        </div>
        <div class="day-select-card" id="dcard-1" onclick="openDatePicker(1)">
          <div class="dcard-num">Dag 2</div>
          <div class="dcard-date" id="dcard-date-1">Klik for at vÃ¦lge</div>
          <div class="dcard-weekday" id="dcard-weekday-1"></div>
          <div class="dcard-status" id="dcard-status-1">â—‹ Ikke valgt</div>
          <input type="date" id="date2" class="dcard-hidden-input" onchange="onDateChange(1)" />
        </div>
        <div class="day-select-card" id="dcard-2" onclick="openDatePicker(2)">
          <div class="dcard-num">Dag 3</div>
          <div class="dcard-date" id="dcard-date-2">Klik for at vÃ¦lge</div>
          <div class="dcard-weekday" id="dcard-weekday-2"></div>
          <div class="dcard-status" id="dcard-status-2">â—‹ Ikke valgt</div>
          <input type="date" id="date3" class="dcard-hidden-input" onchange="onDateChange(2)" />
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-label">03 â€” PrÃ¦ferencer (valgfrit)</div>
      <div class="pref-row">
        <div><label>Tidligste start</label><input type="text" id="pref-start" placeholder="fx ikke fÃ¸r 11:00" /></div>
        <div><label>Seneste slut</label><input type="text" id="pref-end" placeholder="fx ikke efter 22:00" /></div>
      </div>
      <label>Ã˜vrige Ã¸nsker</label>
      <textarea id="pref-notes" placeholder="fx max 2 film om dagen, undgÃ¥ Palads..."></textarea>
    </div>

    <div class="note-box">
      <strong>SÃ¥dan virker det:</strong> Programmet hentes Ã©n dag ad gangen mens du vÃ¦lger film. Til sidst laver Claude den optimale plan pÃ¥ tvÃ¦rs af alle dine dage â€” inkl. trailere, beskrivelser og gangtider.
    </div>

    <button class="btn-primary" onclick="startPlanner()">â–¶ Hent program og vÃ¦lg film</button>
  </div>

  <!-- PICKER SCREEN (one day at a time) -->
  <div id="screen-picker" style="display:none;">

    <div class="stepper" id="stepper"></div>

    <div class="error-box" id="error-fetch"></div>

    <div class="loading-box" id="loading-fetch">
      <div class="film-strip">
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div>
      </div>
      <div class="loading-text" id="loading-fetch-text">Henter filmprogram...</div>
      <div class="loading-sub" id="loading-fetch-sub"></div>
    </div>

    <div id="picker-content" style="display:none;">
      <div class="day-header-bar">
        <h2 id="picker-day-title"></h2>
        <span class="day-progress" id="picker-day-progress"></span>
      </div>
      <div class="film-grid" id="film-grid"></div>
    </div>

    <div class="selection-bar">
      <div class="sel-count" id="sel-count">Ingen film valgt</div>
      <div class="sel-btns">
        <button class="btn-secondary" onclick="goBackSetup()">â† Tilbage</button>
        <button class="btn-primary" style="margin-top:0;width:auto;padding:10px 24px;" id="next-btn" onclick="nextDay()">NÃ¦ste dag â†’</button>
      </div>
    </div>

  </div>

  <!-- LOADING PLAN -->
  <div class="loading-box" id="loading-plan" style="margin-top:40px;">
    <div class="film-strip">
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div>
    </div>
    <div class="loading-text" id="loading-plan-text">SammensÃ¦tter din festivalplan...</div>
    <div class="loading-sub">Analyserer alle valgte film pÃ¥ tvÃ¦rs af dagene</div>
  </div>

  <div class="error-box" id="error-plan" style="margin-top:20px;"></div>

  <!-- OUTPUT -->
  <div id="output">
    <div class="output-actions">
      <button class="btn-secondary" onclick="restartPlanner()">â† Lav ny plan</button>
      <button class="btn-accent" id="save-btn" onclick="openSaveModal()">ğŸ’¾ Gem plan</button>
    </div>
    <div id="plan-cards"></div>
  </div>

</div>
</div>

<!-- â•â• ARCHIVE PAGE â•â• -->
<div class="page" id="page-archive">
<div class="container">
  <div id="archive-list">
    <h1 class="page-title">Mine planer</h1>
    <p class="page-sub">// Alle gemte festivalplaner â€” klik for at Ã¥bne</p>
    <div id="archive-cards"></div>
  </div>
  <div id="archive-view">
    <button class="back-btn" onclick="closeArchiveView()">â† Alle planer</button>
    <h1 class="page-title" id="av-title"></h1>
    <p class="page-sub" id="av-sub"></p>
    <div id="av-cards"></div>
  </div>
</div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="save-modal">
  <div class="modal">
    <h2>Gem plan</h2>
    <p>Giv din plan et navn sÃ¥ du nemt kan finde den igen.</p>
    <label>Plannavn</label>
    <input type="text" id="plan-name-input" placeholder="fx DOX 2025..." maxlength="60" />
    <div class="modal-btns">
      <button class="btn-modal-cancel" onclick="closeSaveModal()">Annuller</button>
      <button class="btn-modal-save" onclick="confirmSave()">Gem â†’</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dates = [];           // selected dates ["2025-03-10", ...]
let currentDayIdx = 0;    // which day we're currently on
let fetchedDays = {};     // { date: [filmObj, ...] }
let selectedFilms = {};   // { date: [filmObj, ...] }
let currentPlanData = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function storageSet(k,v) {
  if(window.storage){try{await window.storage.set(k,JSON.stringify(v));return;}catch{}}
  localStorage.setItem(k,JSON.stringify(v));
}
async function storageGet(k) {
  if(window.storage){try{const r=await window.storage.get(k);return r?JSON.parse(r.value):null;}catch{return null;}}
  try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}
}
async function storageDelete(k) {
  if(window.storage){try{await window.storage.delete(k);}catch{}}
  else localStorage.removeItem(k);
}
async function storageList(prefix) {
  if(window.storage){try{const r=await window.storage.list(prefix);return r?r.keys:[];}catch{return[];}}
  const keys=[];
  for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith(prefix))keys.push(k);}
  return keys;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  const ok=!!window.storage;
  document.getElementById('sdot').className='sdot'+(ok?' ok':'');
  document.getElementById('slabel').textContent=ok?'Cloud-lagring':'Lokal lagring';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab')[name==='planner'?0:1].classList.add('active');
  if(name==='archive')renderArchive();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleKey(){
  const i=document.getElementById('api-key');
  const b=document.getElementById('toggle-btn');
  i.type=i.type==='password'?'text':'password';
  b.textContent=i.type==='password'?'Vis':'Skjul';
}
function getKey(){return document.getElementById('api-key').value.trim();}
function getDates(){return['date1','date2','date3'].map(id=>document.getElementById(id).value).filter(Boolean);}

// â”€â”€ DAY CARDS â”€â”€
function openDatePicker(idx){
  const input=document.getElementById(['date1','date2','date3'][idx]);
  input.showPicker?.();
  input.click();
}

function onDateChange(idx){
  const ids=['date1','date2','date3'];
  const val=document.getElementById(ids[idx]).value;
  const card=document.getElementById('dcard-'+idx);
  const dateEl=document.getElementById('dcard-date-'+idx);
  const weekdayEl=document.getElementById('dcard-weekday-'+idx);
  const statusEl=document.getElementById('dcard-status-'+idx);

  if(val){
    const d=new Date(val);
    const day=d.toLocaleDateString('da-DK',{day:'numeric'});
    const month=d.toLocaleDateString('da-DK',{month:'long'});
    const weekday=d.toLocaleDateString('da-DK',{weekday:'long'});
    dateEl.textContent=day+'. '+month;
    weekdayEl.textContent=weekday.charAt(0).toUpperCase()+weekday.slice(1);
    statusEl.textContent='âœ“ Valgt';
    card.classList.add('has-date');
  } else {
    dateEl.textContent='Klik for at vÃ¦lge';
    weekdayEl.textContent='';
    statusEl.textContent='â—‹ Ikke valgt';
    card.classList.remove('has-date');
  }
}
function fmtDate(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'long',day:'numeric',month:'long'});}
function fmtDateShort(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'short',day:'numeric',month:'short'});}

async function callClaude(prompt){
  const key=getKey();
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':key,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:2000,
      tools:[{type:'web_search_20250305',name:'web_search'}],
      messages:[{role:'user',content:prompt}]
    })
  });
  const data=await res.json();
  if(data.error)throw new Error(data.error.message);
  return(data.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
}

async function callClaudeNoSearch(prompt){
  const key=getKey();
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':key,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:3000,
      messages:[{role:'user',content:prompt}]
    })
  });
  const data=await res.json();
  if(data.error)throw new Error(data.error.message);
  return(data.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
}

function parseJSON(text){
  const clean=text.replace(/```json|```/g,'').trim();
  const match=clean.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
  if(!match)throw new Error('Ingen JSON i svaret');
  return JSON.parse(match[0]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEPPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildStepper(){
  const el=document.getElementById('stepper');
  el.innerHTML='';
  dates.forEach((d,i)=>{
    const div=document.createElement('div');
    div.className='step-item'+(i<currentDayIdx?' done':i===currentDayIdx?' active':'');
    const selCount=(selectedFilms[d]||[]).length;
    const subtext=i<currentDayIdx?(selCount>0?selCount+' film valgt':'Ingen valgt'):fmtDateShort(d);
    div.innerHTML=`<span class="step-num">${i<currentDayIdx?'âœ“':i+1}</span>${subtext}`;
    el.appendChild(div);
  });
  const planStep=document.createElement('div');
  planStep.className='step-item'+(currentDayIdx>=dates.length?' active':'');
  planStep.innerHTML=`<span class="step-num">${currentDayIdx>=dates.length?'â†’':dates.length+1}</span>Lav plan`;
  el.appendChild(planStep);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPlanner(){
  if(!getKey()){alert('Indtast din API-nÃ¸gle.');return;}
  dates=getDates();
  if(!dates.length){alert('VÃ¦lg mindst Ã©n festivaldato.');return;}

  currentDayIdx=0;
  fetchedDays={};
  selectedFilms={};
  dates.forEach(d=>{selectedFilms[d]=[];});

  document.getElementById('screen-setup').style.display='none';
  document.getElementById('screen-picker').style.display='block';
  document.getElementById('output').style.display='none';
  document.getElementById('error-plan').style.display='none';

  buildStepper();
  loadCurrentDay();
}

function goBackSetup(){
  document.getElementById('screen-picker').style.display='none';
  document.getElementById('screen-setup').style.display='block';
}

function restartPlanner(){
  document.getElementById('output').style.display='none';
  document.getElementById('screen-setup').style.display='block';
  currentPlanData=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD ONE DAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCurrentDay(){
  const date=dates[currentDayIdx];
  buildStepper();
  updateNextBtn();

  // Already fetched?
  if(fetchedDays[date]){
    renderFilmGrid(date);
    return;
  }

  // Show loader
  document.getElementById('loading-fetch').style.display='block';
  document.getElementById('picker-content').style.display='none';
  document.getElementById('error-fetch').style.display='none';
  document.getElementById('loading-fetch-text').textContent=`Henter program for ${fmtDate(date)}...`;
  document.getElementById('loading-fetch-sub').textContent='';

  const prompt=`Find CPH:DOX film ${date}. SÃ¸g cphdox.dk/program.
JSON array kun (ingen markdown):
[{"title":"...","screenings":[{"time":"14:00","venue":"...","duration":"85 min"}],"description":"2 sÃ¦tninger dansk","trailerUrl":"youtube-url eller null"}]`;

  try {
    const raw=await callClaude(prompt);
    let films;
    try{films=parseJSON(raw);}catch(e){throw new Error('Parse fejl: '+e.message);}
    if(!Array.isArray(films))throw new Error('Uventet format');

    fetchedDays[date]=films;
    document.getElementById('loading-fetch').style.display='none';
    renderFilmGrid(date);

  } catch(err) {
    document.getElementById('loading-fetch').style.display='none';
    const eb=document.getElementById('error-fetch');
    eb.style.display='block';
    eb.textContent='âš  '+err.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER FILM GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFilmGrid(date){
  const films=fetchedDays[date]||[];
  const selected=selectedFilms[date]||[];

  document.getElementById('picker-day-title').textContent=fmtDate(date);
  document.getElementById('picker-day-progress').textContent=`Dag ${currentDayIdx+1} / ${dates.length}`;

  const grid=document.getElementById('film-grid');
  grid.innerHTML='';

  if(!films.length){
    grid.innerHTML='<p style="color:var(--muted);font-size:0.8rem;padding:20px 0;">Ingen film fundet for denne dag.</p>';
  } else {
    films.forEach((film,idx)=>{
      const isSel=selected.some(f=>f.title===film.title);
      const card=document.createElement('div');
      card.className='film-card'+(isSel?' selected':'');
      const times=(film.screenings||[]).map(s=>`${s.time}${s.venue?' Â· '+s.venue:''}${s.duration?' ('+s.duration+')':''}`).join('  |  ');
      const trailer=film.trailerUrl?`<a href="${film.trailerUrl}" target="_blank" class="btn-trailer" onclick="event.stopPropagation()">â–¶ Trailer</a>`:'';
      card.innerHTML=`
        <div class="film-check"><div class="check-inner"></div></div>
        <div>
          <div class="film-title">${film.title}</div>
          <div class="film-times">${times||'Tidspunkt ikke fundet'}</div>
          <div class="film-desc">${film.description||''}</div>
          ${trailer}
        </div>`;
      card.addEventListener('click',()=>toggleFilm(date,idx,film,card));
      grid.appendChild(card);
    });
  }

  document.getElementById('picker-content').style.display='block';
  updateSelCount();
  updateNextBtn();
}

function toggleFilm(date,idx,film,card){
  if(!selectedFilms[date])selectedFilms[date]=[];
  const i=selectedFilms[date].findIndex(f=>f.title===film.title);
  if(i>=0){selectedFilms[date].splice(i,1);card.classList.remove('selected');}
  else{selectedFilms[date].push({...film,date});card.classList.add('selected');}
  updateSelCount();
  updateNextBtn();
}

function updateSelCount(){
  const total=Object.values(selectedFilms).reduce((s,a)=>s+a.length,0);
  const el=document.getElementById('sel-count');
  el.innerHTML=total===0?'Ingen film valgt endnu':`<strong>${total}</strong> film valgt i alt`;
}

function updateNextBtn(){
  const btn=document.getElementById('next-btn');
  const isLastDay=currentDayIdx>=dates.length-1;
  const totalSel=Object.values(selectedFilms).reduce((s,a)=>s+a.length,0);

  if(isLastDay){
    btn.textContent=totalSel>0?'â–¶ Lav plan':'VÃ¦lg mindst Ã©n film';
    btn.disabled=totalSel===0;
  } else {
    btn.textContent=`NÃ¦ste dag â†’`;
    btn.disabled=false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEXT DAY / GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function nextDay(){
  const isLastDay=currentDayIdx>=dates.length-1;

  if(isLastDay){
    await generatePlan();
  } else {
    currentDayIdx++;
    loadCurrentDay();
    // Scroll to top of picker
    document.getElementById('screen-picker').scrollIntoView({behavior:'smooth'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generatePlan(){
  const allSelected=Object.values(selectedFilms).flat();
  if(!allSelected.length){alert('VÃ¦lg mindst Ã©n film.');return;}

  const prefStart=document.getElementById('pref-start').value.trim();
  const prefEnd=document.getElementById('pref-end').value.trim();
  const prefNotes=document.getElementById('pref-notes').value.trim();

  document.getElementById('screen-picker').style.display='none';
  document.getElementById('loading-plan').style.display='block';
  document.getElementById('error-plan').style.display='none';
  document.getElementById('output').style.display='none';

  const msgs=['Analyserer alle valgte film...','Finder den optimale fordeling...','Beregner gangtider og afstande...','FÃ¦rdiggÃ¸r din plan...'];
  let mi=0;
  const lt=setInterval(()=>{document.getElementById('loading-plan-text').textContent=msgs[++mi%msgs.length];},2500);

  // Build rich film summary grouped by title with all available screenings
  const byTitle={};
  allSelected.forEach(f=>{
    if(!byTitle[f.title])byTitle[f.title]={title:f.title,description:f.description,trailerUrl:f.trailerUrl,screenings:[]};
    (f.screenings||[]).forEach(s=>byTitle[f.title].screenings.push({date:f.date,dateLabel:fmtDate(f.date),time:s.time,venue:s.venue,duration:s.duration}));
  });

  const filmList=Object.values(byTitle).map(f=>{
    const sc=f.screenings.map(s=>`  ${s.dateLabel} ${s.time} @ ${s.venue}${s.duration?' ('+s.duration+')':''}`).join('\n');
    return `${f.title}:\n${sc}`;
  }).join('\n\n');

  const prompt=`CPH:DOX festivalplanlÃ¦gger. Lav OPTIMAL plan pÃ¥ tvÃ¦rs af alle dage.

Festivaldage: ${dates.map(d=>fmtDate(d)+' ('+d+')').join(', ')}
${prefStart?'Tidligste start: '+prefStart:''}
${prefEnd?'Seneste slut: '+prefEnd:''}
${prefNotes?'PrÃ¦ferencer: '+prefNotes:''}

Valgte film med ALLE mulige visningstidspunkter:
${filmList}

Regler:
- Fordel film klogt pÃ¥ tvÃ¦rs af dage â€” samme film kan vises flere dage, vÃ¦lg den bedste dag
- UndgÃ¥ overlap â€” mindst 30 min buffer inkl. transport mellem film
- Balancer dagene â€” ikke alle film pÃ¥ Ã©n dag
- VÃ¦lg optimalt tidspunkt per film ift. andre film samme dag
- Beregn km og minutter til fods mellem biografer pÃ¥ samme dag

Svar KUN JSON:
{"days":[{"date":"YYYY-MM-DD","date_label":"Mandag 10. marts","screenings":[{"time":"13:00","title":"...","venue":"...","duration":"90 min","description":"...","trailerUrl":"...eller null","ticketUrl":"https://cphdox.dk/program/?s=TITEL","distance_to_next":1.2,"walk_minutes_to_next":15}]}],"notes":"Forklar fordelingen"}

Filmdata: ${JSON.stringify(Object.values(byTitle))}`;

  try {
    const raw=await callClaudeNoSearch(prompt);
    let plan;
    try{plan=parseJSON(raw);}catch(e){throw new Error('Parse fejl: '+e.message);}

    clearInterval(lt);
    currentPlanData=plan;
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('output').style.display='block';
    renderPlanCards(plan,document.getElementById('plan-cards'));

  } catch(err) {
    clearInterval(lt);
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('screen-picker').style.display='block';
    const eb=document.getElementById('error-plan');
    eb.style.display='block';
    eb.textContent='âš  Fejl: '+err.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER PLAN CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlanCards(data,container){
  container.innerHTML='';
  if(!data.days||!data.days.length){
    container.innerHTML='<p style="color:var(--muted);font-size:0.8rem;">Ingen plan genereret.</p>';
    return;
  }

  data.days.forEach(day=>{
    const card=document.createElement('div');
    card.className='day-card';

    const hdr=document.createElement('div');
    hdr.className='day-card-header';
    hdr.innerHTML=`<span class="day-card-title">${day.date_label||day.date}</span><span class="day-card-date">${day.date}</span>`;
    card.appendChild(hdr);

    (day.screenings||[]).forEach((s,idx)=>{
      const sc=document.createElement('div');
      sc.className='screening';
      const ticketUrl=s.ticketUrl||`https://cphdox.dk/program/?s=${encodeURIComponent(s.title)}`;
      const trailer=s.trailerUrl?`<a href="${s.trailerUrl}" target="_blank" class="btn-trailer-sm">â–¶ Trailer</a>`:'';
      sc.innerHTML=`
        <div class="sc-time">${s.time}</div>
        <div class="sc-title">${s.title}</div>
        <div class="sc-venue">ğŸ“ ${s.venue}</div>
        ${s.duration?`<div class="sc-dur">Varighed: ${s.duration}</div>`:''}
        ${s.description?`<div class="sc-desc">${s.description}</div>`:''}
        <div class="sc-btns">
          <a href="${ticketUrl}" target="_blank" class="btn-ticket">ğŸŸ KÃ¸b billet</a>
          ${trailer}
        </div>`;
      card.appendChild(sc);

      const next=day.screenings[idx+1];
      if(next){
        const travel=document.createElement('div');
        travel.className='travel-badge';
        if(s.venue!==next.venue){
          const from=encodeURIComponent(s.venue+', Copenhagen');
          const to=encodeURIComponent(next.venue+', Copenhagen');
          const murl=`https://www.google.com/maps/dir/?api=1&origin=${from}&destination=${to}&travelmode=walking`;
          travel.innerHTML=`<div class="travel-info">ğŸš¶ ${s.distance_to_next||'?'} km Â· ca. ${s.walk_minutes_to_next||'?'} min â†’ ${next.venue}</div><a href="${murl}" target="_blank" class="btn-maps">Ã…bn Maps â†’</a>`;
        } else {
          travel.innerHTML=`<div class="travel-info">ğŸ“ Bliv i ${s.venue}</div>`;
        }
        card.appendChild(travel);
      }
    });

    container.appendChild(card);
  });

  if(data.notes){
    const nb=document.createElement('div');
    nb.className='note-box';
    nb.style.marginTop='20px';
    nb.innerHTML=`<strong>Planens logik:</strong> ${data.notes}`;
    container.appendChild(nb);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSaveModal(){
  if(!currentPlanData)return;
  document.getElementById('plan-name-input').value='';
  document.getElementById('save-modal').classList.add('open');
  setTimeout(()=>document.getElementById('plan-name-input').focus(),100);
}
function closeSaveModal(){document.getElementById('save-modal').classList.remove('open');}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closeSaveModal();
  if(e.key==='Enter'&&document.getElementById('save-modal').classList.contains('open'))confirmSave();
});
async function confirmSave(){
  const name=document.getElementById('plan-name-input').value.trim();
  if(!name){alert('Giv planen et navn.');return;}
  const id='plan:'+Date.now();
  await storageSet(id,{id,name,savedAt:new Date().toISOString(),data:currentPlanData});
  closeSaveModal();
  const btn=document.getElementById('save-btn');
  const orig=btn.textContent;
  btn.textContent='âœ“ Gemt!';
  btn.style.cssText+='background:rgba(72,240,168,0.12);border-color:rgba(72,240,168,0.3);color:#48f0a8;';
  setTimeout(()=>{btn.textContent=orig;btn.style.cssText='';},2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARCHIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderArchive(){
  document.getElementById('archive-list').style.display='block';
  document.getElementById('archive-view').style.display='none';
  const keys=await storageList('plan:');
  const container=document.getElementById('archive-cards');

  if(!keys.length){
    container.innerHTML='<div class="archive-empty"><p>Ingen gemte planer endnu.<br>Lav en plan og tryk <em>Gem plan</em>.</p></div>';
    return;
  }

  container.innerHTML='<p style="font-size:0.73rem;color:var(--muted);margin-bottom:16px;">IndlÃ¦ser...</p>';
  const plans=(await Promise.all(keys.map(k=>storageGet(k)))).filter(Boolean);
  plans.sort((a,b)=>new Date(b.savedAt)-new Date(a.savedAt));
  container.innerHTML='';

  plans.forEach(plan=>{
    const card=document.createElement('div');
    card.className='archive-card';
    const days=plan.data.days||[];
    const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
    const saved=new Date(plan.savedAt).toLocaleDateString('da-DK',{day:'numeric',month:'long',year:'numeric'});
    const pills=days.map(d=>`<span class="day-pill">${(d.date_label||d.date).split(' ').slice(0,2).join(' ')}</span>`).join('');
    card.innerHTML=`
      <div class="arc-actions"><button class="btn-del" onclick="deletePlan(event,'${plan.id}')">Slet</button></div>
      <div class="arc-name">${plan.name}</div>
      <div class="arc-meta">Gemt ${saved} Â· ${films.length} film over ${days.length} dag${days.length!==1?'e':''}</div>
      <div class="arc-days">${pills}</div>`;
    card.addEventListener('click',e=>{if(e.target.classList.contains('btn-del'))return;openArchiveView(plan);});
    container.appendChild(card);
  });
}

function openArchiveView(plan){
  document.getElementById('archive-list').style.display='none';
  document.getElementById('archive-view').style.display='block';
  const days=plan.data.days||[];
  const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
  const saved=new Date(plan.savedAt).toLocaleDateString('da-DK',{day:'numeric',month:'long',year:'numeric'});
  document.getElementById('av-title').textContent=plan.name;
  document.getElementById('av-sub').textContent=`// Gemt ${saved} Â· ${films.length} film over ${days.length} dage`;
  renderPlanCards(plan.data,document.getElementById('av-cards'));
}

function closeArchiveView(){
  document.getElementById('archive-list').style.display='block';
  document.getElementById('archive-view').style.display='none';
}

async function deletePlan(e,id){
  e.stopPropagation();
  if(!confirm('Slet denne plan?'))return;
  await storageDelete(id);
  renderArchive();
}
</script>
</body>
</html>
