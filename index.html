<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPH:DOX Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0f; --surface:#12121a; --surface2:#1a1a26;
    --border:rgba(255,255,255,0.08); --accent:#e8f048; --accent2:#48c8f0;
    --text:#f0ede8; --muted:#7a7a8a; --red:#f04848; --green:#48f0a8;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
    background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(232,240,72,0.07) 0%,transparent 60%),
               radial-gradient(ellipse 60% 40% at 80% 100%,rgba(72,200,240,0.05) 0%,transparent 60%);}
  nav{position:sticky;top:0;z-index:100;background:rgba(10,10,15,0.94);backdrop-filter:blur(14px);
    border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;height:56px;}
  .nav-brand{font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--text);margin-right:32px;}
  .nav-brand span{color:var(--accent);}
  .nav-tabs{display:flex;gap:4px;flex:1;}
  .nav-tab{padding:8px 18px;font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.12em;
    text-transform:uppercase;cursor:pointer;border:1px solid transparent;background:none;color:var(--muted);transition:all 0.18s;}
  .nav-tab:hover{color:var(--text);}
  .nav-tab.active{color:var(--accent);border-color:rgba(232,240,72,0.25);background:rgba(232,240,72,0.06);}
  .storage-status{font-size:0.65rem;color:var(--muted);display:flex;align-items:center;gap:6px;margin-left:auto;}
  .sdot{width:6px;height:6px;border-radius:50%;background:var(--muted);}
  .sdot.ok{background:var(--accent);}
  .page{display:none;}.page.active{display:block;}
  .container{max-width:960px;margin:0 auto;padding:40px 20px 100px;position:relative;z-index:1;}
  .page-title{font-family:'DM Serif Display',serif;font-size:clamp(1.8rem,4vw,2.8rem);margin-bottom:6px;line-height:1.1;}
  .page-sub{font-size:0.75rem;color:var(--muted);letter-spacing:0.05em;margin-bottom:40px;}
  .section-label{font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);
    margin-bottom:14px;display:flex;align-items:center;gap:12px;}
  .section-label::after{content:'';flex:1;height:1px;background:var(--border);}
  .section{margin-bottom:32px;}
  input[type="text"],input[type="password"]{width:100%;background:var(--surface);
    border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;
    padding:11px 14px;outline:none;transition:border-color 0.2s,background 0.2s;}
  input:focus{border-color:rgba(232,240,72,0.35);background:var(--surface2);}
  label{display:block;font-size:0.68rem;letter-spacing:0.1em;color:var(--muted);text-transform:uppercase;margin-bottom:7px;}

  /* PDF upload removed ‚Äî film data is hardcoded */

  /* Day card CSS removed ‚Äî dates hardcoded */

  /* PREFS */
  .pref-group{margin-bottom:20px;}
  .pref-question{font-size:0.78rem;color:var(--text);margin-bottom:10px;}
  .pref-chips{display:flex;gap:8px;flex-wrap:wrap;}
  .pref-chip{padding:8px 16px;background:var(--surface);border:1px solid var(--border);color:var(--muted);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.18s;user-select:none;}
  .pref-chip:hover{border-color:rgba(232,240,72,0.3);color:var(--text);}
  .pref-chip.selected{background:rgba(232,240,72,0.08);border-color:rgba(232,240,72,0.5);color:var(--accent);}

  /* BUTTONS */
  .btn-primary{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;
    background:var(--accent);color:#0a0a0f;font-family:'DM Mono',monospace;font-size:0.84rem;font-weight:600;
    letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border:none;transition:all 0.18s;margin-top:24px;}
  .btn-primary:hover{background:#f0fa60;transform:translateY(-1px);}
  .btn-secondary{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:none;
    border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.72rem;
    letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
  .btn-secondary:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
  .btn-accent{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;
    background:rgba(232,240,72,0.08);border:1px solid rgba(232,240,72,0.3);color:var(--accent);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
  .btn-accent:hover{background:rgba(232,240,72,0.16);}
  .btn-cyan{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;
    background:rgba(72,200,240,0.08);border:1px solid rgba(72,200,240,0.3);color:var(--accent2);
    font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;text-decoration:none;}
  .btn-cyan:hover{background:rgba(72,200,240,0.16);}

  /* LOADING */
  .loading-box{display:none;text-align:center;padding:48px 20px;border:1px solid var(--border);background:var(--surface);}
  .film-strip{display:flex;gap:4px;justify-content:center;margin-bottom:16px;}
  .film-frame{width:13px;height:19px;background:var(--surface2);border:1px solid var(--border);animation:filmroll 1.2s ease-in-out infinite;}
  .film-frame:nth-child(2){animation-delay:.1s}.film-frame:nth-child(3){animation-delay:.2s}
  .film-frame:nth-child(4){animation-delay:.3s}.film-frame:nth-child(5){animation-delay:.4s}
  @keyframes filmroll{0%,100%{background:var(--surface2)}50%{background:var(--accent)}}
  .loading-text{font-size:0.73rem;color:var(--muted);letter-spacing:0.1em;}
  .loading-sub{font-size:0.65rem;color:var(--muted);margin-top:8px;opacity:0.6;}
  .error-box{border:1px solid rgba(240,72,72,0.3);background:rgba(240,72,72,0.07);padding:16px;
    color:var(--red);font-size:0.78rem;line-height:1.6;display:none;margin-bottom:16px;}
  .note-box{background:rgba(232,240,72,0.04);border:1px solid rgba(232,240,72,0.14);
    padding:14px 18px;font-size:0.73rem;color:var(--muted);line-height:1.7;}
  .note-box strong{color:var(--accent);}

  /* GRID LAYOUT */
  .grid-wrapper{overflow-x:auto;margin:0 -20px;padding:0 20px 80px;}
  .time-grid{display:grid;min-width:700px;}
  .grid-header{display:grid;gap:10px;margin-bottom:6px;padding-left:56px;}
  .grid-col-head{background:var(--surface2);border:1px solid var(--border);padding:10px 14px;
    font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);text-align:center;}
  .time-row{display:grid;gap:10px;margin-bottom:4px;align-items:start;}
  .time-label{width:46px;flex-shrink:0;font-family:'DM Serif Display',serif;font-style:italic;
    font-size:0.95rem;color:var(--muted);padding-top:11px;text-align:right;padding-right:10px;}
  .grid-cell{min-height:8px;}
  .film-card{background:var(--surface);border:1px solid var(--border);padding:10px 12px;
    cursor:pointer;transition:all 0.18s;position:relative;margin-bottom:6px;}
  .film-card:hover{border-color:rgba(232,240,72,0.3);background:var(--surface2);}
  .film-card.selected{border-color:rgba(72,240,168,0.5);background:rgba(72,240,168,0.04);}
  .film-card.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);}
  .fc-check{position:absolute;top:9px;right:9px;font-size:0.75rem;color:var(--muted);transition:color 0.18s;}
  .film-card.selected .fc-check{color:var(--green);}
  .fc-time{font-size:0.68rem;color:var(--accent);margin-bottom:2px;font-family:'DM Serif Display',serif;font-style:italic;}
  .fc-title{font-size:0.78rem;font-weight:500;line-height:1.3;margin-bottom:3px;padding-right:18px;}
  .fc-venue{font-size:0.63rem;color:var(--muted);}
  .fc-dur{font-size:0.62rem;color:var(--muted);margin-top:1px;}
  .fc-desc{font-size:0.67rem;color:var(--muted);line-height:1.55;margin-top:5px;padding-top:5px;
    border-top:1px solid var(--border);display:none;}
  .film-card:hover .fc-desc,.film-card.selected .fc-desc{display:block;}
  .fc-multi{font-size:0.6rem;color:var(--accent2);margin-top:3px;}
  .dp-option{display:flex;align-items:center;gap:14px;padding:12px 16px;background:var(--surface2);
    border:1px solid var(--border);margin-bottom:8px;cursor:pointer;transition:all 0.18s;}
  .dp-option:hover{border-color:rgba(232,240,72,0.4);background:rgba(232,240,72,0.05);}
  .dp-option.dp-taken{opacity:0.35;cursor:not-allowed;pointer-events:none;}
  .dp-option.dp-taken::after{content:'optaget';font-size:0.6rem;color:var(--red);margin-left:auto;
    letter-spacing:0.1em;text-transform:uppercase;}
  .dp-day{font-family:'DM Serif Display',serif;font-style:italic;font-size:1.1rem;color:var(--accent);min-width:52px;}
  .dp-meta{flex:1;}
  .dp-time{font-size:0.82rem;font-weight:500;}
  .dp-venue{font-size:0.68rem;color:var(--muted);margin-top:2px;}
  .fc-chosen-day{font-size:0.6rem;color:var(--green);margin-top:3px;letter-spacing:0.05em;}
  .film-card.dimmed{opacity:0.28;filter:saturate(0.2);}
  .film-card.dimmed:hover{opacity:0.7;filter:saturate(0.5);}
  .time-divider{grid-column:1/-1;height:1px;background:var(--border);margin:6px 0 2px;opacity:0.5;}

  /* FILM SELECTION LIST */
  .film-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
  .film-list-title{font-family:'DM Serif Display',serif;font-size:1.4rem;}
  .film-list-meta{font-size:0.7rem;color:var(--muted);}
  .film-list-actions{display:flex;gap:8px;align-items:center;}

  .day-group{margin-bottom:28px;}
  .day-group-label{font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);
    margin-bottom:12px;display:flex;align-items:center;gap:12px;}
  .day-group-label::after{content:'';flex:1;height:1px;background:var(--border);}

  .film-row{display:flex;align-items:flex-start;gap:0;border:1px solid var(--border);
    background:var(--surface);margin-bottom:8px;cursor:pointer;transition:all 0.18s;position:relative;}
  .film-row:hover{border-color:rgba(232,240,72,0.25);background:var(--surface2);}
  .film-row.selected{border-color:rgba(72,240,168,0.5);background:rgba(72,240,168,0.05);}
  .film-row.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);}
  .film-check{width:48px;flex-shrink:0;display:flex;align-items:center;justify-content:center;
    font-size:1.1rem;color:var(--muted);padding:16px 0;border-right:1px solid var(--border);transition:color 0.18s;}
  .film-row.selected .film-check{color:var(--green);}
  .film-info{flex:1;padding:14px 16px;}
  .film-time{font-family:'DM Serif Display',serif;font-style:italic;font-size:1rem;color:var(--accent);margin-bottom:2px;}
  .film-title{font-size:0.88rem;font-weight:500;margin-bottom:3px;line-height:1.3;}
  .film-meta{font-size:0.67rem;color:var(--muted);margin-bottom:5px;}
  .film-desc{font-size:0.72rem;color:var(--muted);line-height:1.6;}

  .sel-bar{position:sticky;bottom:0;z-index:50;background:rgba(10,10,15,0.96);backdrop-filter:blur(12px);
    border-top:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;
    justify-content:space-between;gap:12px;margin:0 -20px;flex-wrap:wrap;}
  .sel-count{font-size:0.75rem;color:var(--muted);}
  .sel-count strong{color:var(--accent);}

  /* OUTPUT */
  #output{display:none;animation:fadeIn 0.4s ease;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .output-actions{display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap;}

  .day-card{background:var(--surface);border:1px solid var(--border);margin-bottom:20px;overflow:hidden;}
  .day-card-header{padding:14px 22px;background:var(--surface2);border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;}
  .day-card-title{font-family:'DM Serif Display',serif;font-size:1.2rem;}
  .day-card-date{font-size:0.68rem;color:var(--accent);letter-spacing:0.1em;}
  .screening{padding:16px 22px;border-bottom:1px solid var(--border);}
  .screening:last-child{border-bottom:none;}
  .sc-time{font-family:'DM Serif Display',serif;font-style:italic;font-size:1.2rem;color:var(--accent);margin-bottom:2px;}
  .sc-title{font-size:0.9rem;margin-bottom:2px;font-weight:500;}
  .sc-venue{font-size:0.7rem;color:var(--muted);}
  .sc-dur{font-size:0.66rem;color:var(--muted);margin-top:1px;}
  .sc-desc{font-size:0.72rem;color:var(--muted);line-height:1.6;margin-top:7px;padding-top:7px;border-top:1px solid var(--border);}
  .sc-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:9px;align-items:center;}
  .btn-ticket{display:inline-flex;align-items:center;gap:5px;background:rgba(232,240,72,0.07);
    border:1px solid rgba(232,240,72,0.22);color:var(--accent);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;text-decoration:none;font-family:'DM Mono',monospace;transition:all 0.18s;}
  .btn-ticket:hover{background:rgba(232,240,72,0.14);}
  .btn-cafe{display:inline-flex;align-items:center;gap:5px;background:transparent;
    border:1px solid var(--border);color:var(--muted);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.18s;}
  .btn-cafe:hover{border-color:rgba(232,240,72,0.3);color:var(--accent);}
  .travel-badge{display:flex;align-items:center;gap:12px;padding:10px 22px;background:rgba(72,200,240,0.04);
    border-top:1px dashed rgba(72,200,240,0.18);border-bottom:1px dashed rgba(72,200,240,0.18);}
  .travel-info{font-size:0.7rem;color:var(--accent2);}
  .btn-maps{margin-left:auto;display:inline-flex;align-items:center;gap:5px;background:rgba(72,200,240,0.1);
    border:1px solid rgba(72,200,240,0.28);color:var(--accent2);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;text-decoration:none;font-family:'DM Mono',monospace;
    transition:all 0.18s;flex-shrink:0;}
  .btn-maps:hover{background:rgba(72,200,240,0.18);}

  /* MISSED FILMS SECTION */
  .missed-section{margin-top:28px;border:1px solid rgba(240,72,72,0.2);background:rgba(240,72,72,0.03);overflow:hidden;}
  .missed-header{padding:14px 22px;background:rgba(240,72,72,0.08);border-bottom:1px solid rgba(240,72,72,0.15);
    display:flex;align-items:center;gap:10px;}
  .missed-header h3{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--red);}
  .missed-header p{font-size:0.7rem;color:var(--muted);}
  .missed-film{padding:14px 22px;border-bottom:1px solid rgba(240,72,72,0.1);}
  .missed-film:last-child{border-bottom:none;}
  .missed-title{font-size:0.88rem;margin-bottom:4px;}
  .missed-showings{font-size:0.7rem;color:var(--muted);line-height:1.8;}
  .missed-showing-time{color:var(--accent2);}

  /* MODALS */
  .modal-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.78);
    align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .modal-box{background:var(--surface);border:1px solid rgba(232,240,72,0.2);
    max-width:480px;width:100%;max-height:85vh;overflow-y:auto;animation:fadeUp 0.25s ease;}
  .modal-head{padding:22px 26px 16px;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:flex-start;}
  .modal-head h2{font-family:'DM Serif Display',serif;font-size:1.25rem;}
  .modal-head-sub{font-size:0.68rem;color:var(--muted);margin-top:3px;}
  .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;padding:0 4px;line-height:1;}
  .modal-close:hover{color:var(--text);}
  .modal-body{padding:20px 26px 26px;}
  .cafe-card{background:var(--surface2);border:1px solid var(--border);padding:13px 16px;margin-bottom:10px;}
  .cafe-name{font-size:0.88rem;margin-bottom:3px;}
  .cafe-type{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-left:6px;}
  .cafe-meta{font-size:0.68rem;color:var(--muted);line-height:1.65;margin-top:3px;}
  .save-box{background:var(--surface);border:1px solid rgba(232,240,72,0.2);padding:32px;max-width:420px;width:100%;animation:fadeUp 0.25s ease;}
  .save-box h2{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:8px;}
  .save-box p{font-size:0.75rem;color:var(--muted);margin-bottom:20px;}
  .modal-btns{display:flex;gap:10px;margin-top:20px;}
  .btn-msave{flex:1;background:var(--accent);color:#0a0a0f;font-family:'DM Mono',monospace;font-size:0.78rem;letter-spacing:0.08em;text-transform:uppercase;padding:11px;cursor:pointer;border:none;font-weight:600;}
  .btn-msave:hover{background:#f0fa60;}
  .btn-mcancel{padding:11px 18px;background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.78rem;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;}
  .btn-mcancel:hover{color:var(--text);}

  /* ARCHIVE */
  .archive-empty{text-align:center;padding:60px 20px;border:1px solid var(--border);background:var(--surface);}
  .archive-empty p{font-size:0.8rem;color:var(--muted);line-height:1.7;}
  .archive-card{background:var(--surface);border:1px solid var(--border);padding:20px 22px;cursor:pointer;transition:all 0.18s;position:relative;margin-bottom:12px;}
  .archive-card:hover{border-color:rgba(232,240,72,0.25);background:var(--surface2);}
  .arc-name{font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:5px;}
  .arc-meta{font-size:0.7rem;color:var(--muted);line-height:1.6;}
  .arc-days{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
  .day-pill{font-size:0.65rem;padding:3px 9px;background:rgba(232,240,72,0.07);border:1px solid rgba(232,240,72,0.18);color:var(--accent);}
  .arc-del{position:absolute;top:14px;right:14px;background:none;border:1px solid var(--border);color:var(--muted);padding:5px 10px;font-size:0.7rem;cursor:pointer;font-family:'DM Mono',monospace;transition:all 0.18s;}
  .arc-del:hover{border-color:rgba(240,72,72,0.4);color:var(--red);}
  #archive-view{display:none;}
  .back-btn{display:inline-flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--muted);padding:8px 16px;font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;margin-bottom:28px;}
  .back-btn:hover{color:var(--text);}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border)}

  /* SWAP MODAL */
  .swap-film-item{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;background:var(--surface2);
    border:1px solid var(--border);margin-bottom:8px;cursor:pointer;transition:all 0.18s;}
  .swap-film-item:hover{border-color:rgba(232,240,72,0.35);background:rgba(232,240,72,0.05);}
  .swap-film-meta{flex:1;}
  .swap-film-title{font-size:0.85rem;margin-bottom:3px;}
  .swap-film-times{font-size:0.68rem;color:var(--muted);line-height:1.7;}
  .swap-arrow{font-size:1.2rem;color:var(--accent);align-self:center;flex-shrink:0;}
  .btn-replace{display:inline-flex;align-items:center;gap:5px;background:rgba(232,240,72,0.07);
    border:1px solid rgba(232,240,72,0.22);color:var(--accent);padding:5px 12px;font-size:0.66rem;
    letter-spacing:0.1em;text-transform:uppercase;font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.18s;}
  .btn-replace:hover{background:rgba(232,240,72,0.16);}

  /* SUMMARY SECTION */
  .summary-section{margin-top:28px;border:1px solid var(--border);background:var(--surface);overflow:hidden;}
  .summary-header{padding:14px 22px;background:var(--surface2);border-bottom:1px solid var(--border);}
  .summary-header h3{font-family:'DM Serif Display',serif;font-size:1.1rem;}
  .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;}
  @media(max-width:600px){.summary-grid{grid-template-columns:1fr;}}
  .summary-col{padding:16px 22px;}
  .summary-col:first-child{border-right:1px solid var(--border);}
  .summary-col-label{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;margin-bottom:10px;}
  .summary-col:first-child .summary-col-label{color:var(--green);}
  .summary-col:last-child .summary-col-label{color:var(--red);}
  .summary-film{font-size:0.75rem;padding:5px 0;border-bottom:1px solid var(--border);display:flex;
    align-items:baseline;gap:6px;color:var(--muted);}
  .summary-film:last-child{border-bottom:none;}
  .summary-film-title{flex:1;color:var(--text);}
  .summary-film-when{font-size:0.65rem;color:var(--muted);}

  /* ERROR LOG */
  .error-log{background:rgba(0,0,0,0.4);border:1px solid rgba(240,72,72,0.2);padding:10px 14px;
    font-size:0.62rem;font-family:'DM Mono',monospace;color:rgba(240,72,72,0.7);
    white-space:pre-wrap;word-break:break-all;max-height:220px;overflow-y:auto;margin-top:10px;line-height:1.6;}
  .copy-log-btn{display:inline-flex;align-items:center;gap:5px;margin-top:8px;padding:5px 12px;
    background:none;border:1px solid rgba(240,72,72,0.3);color:var(--red);font-family:'DM Mono',monospace;
    font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.18s;}
  .copy-log-btn:hover{background:rgba(240,72,72,0.1);}
</style>
</head>
<body>

<nav>
  <div class="nav-brand">CPH<span>:</span>DOX</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('planner')">Planl√¶gger</button>
    <button class="nav-tab" onclick="showPage('archive')">Mine planer</button>
  </div>
  <div class="storage-status">
    <div class="sdot" id="sdot"></div>
    <span id="slabel">...</span>
  </div>
</nav>

<div class="page active" id="page-planner">
<div class="container">

  <!-- SETUP -->
  <div id="screen-setup">
    <h1 class="page-title">Lav en festivalplan</h1>
    <p class="page-sub">// CPH:DOX 2026 ¬∑ 11‚Äì22. marts ¬∑ Upload PDF og v√¶lg film</p>

    <div class="section">
      <div class="section-label">01 ‚Äî API-n√∏gle</div>
      <div style="position:relative;">
        <input type="password" id="api-key" placeholder="sk-ant-..." style="padding-right:80px;" />
        <button onclick="toggleKey()" id="toggle-btn" style="position:absolute;right:0;top:0;bottom:0;background:var(--surface2);border:none;border-left:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;padding:0 13px;cursor:pointer;text-transform:uppercase;">Vis</button>
      </div>
      <div style="font-size:0.68rem;color:var(--muted);margin-top:7px;">Hent p√• <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a></div>
    </div>

    <div class="section">
      <div class="section-label">02 ‚Äî Dine pr√¶ferencer</div>
      <div class="pref-group">
        <div class="pref-question">Pauser mellem film?</div>
        <div class="pref-chips" id="pg-pauses">
          <div class="pref-chip" data-val="relaxed" onclick="pickChip('pg-pauses',this)">‚òï Tid til mad og kaffe</div>
          <div class="pref-chip" data-val="packed" onclick="pickChip('pg-pauses',this)">üé¨ Pak s√• meget ind som muligt</div>
        </div>
      </div>
      <div class="pref-group">
        <div class="pref-question">Hvor mange film om dagen?</div>
        <div class="pref-chips" id="pg-count">
          <div class="pref-chip" data-val="1-2" onclick="pickChip('pg-count',this)">1‚Äì2 film</div>
          <div class="pref-chip" data-val="3-4" onclick="pickChip('pg-count',this)">3‚Äì4 film</div>
          <div class="pref-chip" data-val="max" onclick="pickChip('pg-count',this)">S√• mange som muligt</div>
        </div>
      </div>
      <div class="pref-group">
        <div class="pref-question">Hvorn√•r starter du helst?</div>
        <div class="pref-chips" id="pg-start">
          <div class="pref-chip" data-val="morning" onclick="pickChip('pg-start',this)">üåÖ Fra kl. 10</div>
          <div class="pref-chip" data-val="midday" onclick="pickChip('pg-start',this)">‚òÄÔ∏è Fra kl. 12</div>
          <div class="pref-chip" data-val="afternoon" onclick="pickChip('pg-start',this)">üåá Fra kl. 15</div>
        </div>
      </div>
    </div>

    <div class="note-box">
      <strong>S√•dan virker det:</strong> Programmet for alle tre dage (20.‚Äì22. marts) er klar. S√¶t flueben ved de film du vil se ‚Äî Claude laver derefter den optimale plan og viser hvilke film der ikke kunne passe ind.
    </div>
    <button class="btn-primary" onclick="startPlanner()">‚ñ∂ Vis hele festivalprogrammet</button>
  </div>

  <!-- FILM SELECTION SCREEN -->
  <div id="screen-select" style="display:none;">
    <div class="loading-box" id="loading-fetch">
      <div class="film-strip">
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div>
      </div>
      <div class="loading-text" id="loading-text">Claude l√¶ser PDF...</div>
      <div class="loading-sub" id="loading-sub">Udtr√¶kker filmprogram</div>
    </div>
    <div class="error-box" id="error-fetch"></div>

    <div id="film-list-container" style="display:none;"><div class="grid-wrapper">
      <div class="film-list-header">
        <div>
          <div class="film-list-title">V√¶lg film du vil se</div>
          <div class="film-list-meta" id="film-list-meta"></div>
        </div>
        <div class="film-list-actions">
          <button class="btn-secondary" style="font-size:0.65rem;padding:7px 14px;" onclick="selectAll()">V√¶lg alle</button>
          <button class="btn-secondary" style="font-size:0.65rem;padding:7px 14px;" onclick="selectNone()">Frav√¶lg alle</button>
        </div>
      </div>
      <div id="film-list"></div>
    </div>

    </div></div>
    <div class="sel-bar">
      <div class="sel-count" id="sel-count">Ingen film valgt endnu</div>
      <div style="display:flex;gap:10px;">
        <button class="btn-secondary" onclick="goBackSetup()">‚Üê Tilbage</button>
        <button class="btn-accent" id="plan-btn" onclick="generatePlan()" disabled>Lav plan ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- LOADING PLAN -->
  <div class="loading-box" id="loading-plan" style="margin-top:40px;">
    <div class="film-strip">
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div>
    </div>
    <div class="loading-text" id="loading-plan-text">Sammens√¶tter din festivalplan...</div>
    <div class="loading-sub">Claude optimerer planen og finder hvad der ikke kan passe ind</div>
  </div>
  <div class="error-box" id="error-plan" style="margin-top:20px;"></div>

  <!-- OUTPUT -->
  <div id="output">
    <div class="output-actions">
      <button class="btn-secondary" onclick="restartPlanner()">‚Üê Ny plan</button>
      <button class="btn-accent" id="save-btn" onclick="openSaveModal()">üíæ Gem plan</button>
      <button class="btn-cyan" onclick="downloadICS()">üìÖ Tilf√∏j til kalender</button>
    </div>
    <div id="plan-cards"></div>
    <div id="missed-section"></div>
    <div id="summary-section"></div>
  </div>

</div>
</div>

<!-- ARCHIVE PAGE -->
<div class="page" id="page-archive">
<div class="container">
  <div id="archive-list">
    <h1 class="page-title">Mine planer</h1>
    <p class="page-sub">// Alle gemte festivalplaner</p>
    <div id="archive-cards"></div>
  </div>
  <div id="archive-view">
    <button class="back-btn" onclick="closeArchiveView()">‚Üê Alle planer</button>
    <h1 class="page-title" id="av-title"></h1>
    <p class="page-sub" id="av-sub"></p>
    <div class="output-actions" style="margin-top:16px;">
      <button class="btn-cyan" onclick="downloadICS()">üìÖ Tilf√∏j til kalender</button>
    </div>
    <div id="av-cards"></div>
    <div id="av-missed"></div>
    <div id="av-summary"></div>
  </div>
</div>
</div>

<!-- CAFE MODAL -->
<div class="modal-overlay" id="cafe-modal">
  <div class="modal-box">
    <div class="modal-head">
      <div><h2>Cafeer i n√¶rheden</h2><div class="modal-head-sub" id="cafe-modal-sub"></div></div>
      <button class="modal-close" onclick="closeCafeModal()">√ó</button>
    </div>
    <div class="modal-body" id="cafe-body"></div>
  </div>
</div>

<!-- SWAP MODAL -->
<div class="modal-overlay" id="swap-modal">
  <div class="modal-box" style="max-width:540px;">
    <div class="modal-head">
      <div><h2>Erstat film</h2><div class="modal-head-sub" id="swap-modal-sub"></div></div>
      <button class="modal-close" onclick="closeSwapModal()">√ó</button>
    </div>
    <div class="modal-body" id="swap-body"></div>
  </div>
</div>

<!-- DAY PICKER MODAL -->
<div class="modal-overlay" id="day-picker-modal">
  <div class="modal-box" style="max-width:440px;">
    <div class="modal-head">
      <div><h2 id="dp-title"></h2><div class="modal-head-sub">V√¶lg hvilken dag og tid du vil se filmen</div></div>
      <button class="modal-close" onclick="closeDayPicker()">√ó</button>
    </div>
    <div class="modal-body" id="dp-body"></div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="save-modal">
  <div class="save-box">
    <h2>Gem plan</h2>
    <p>Giv din plan et navn s√• du nemt kan finde den igen.</p>
    <label>Plannavn</label>
    <input type="text" id="plan-name-input" placeholder="fx DOX 2026..." maxlength="60" />
    <div class="modal-btns">
      <button class="btn-mcancel" onclick="closeSaveModal()">Annuller</button>
      <button class="btn-msave" onclick="confirmSave()">Gem ‚Üí</button>
    </div>
  </div>
</div>

<script>
// CPH:DOX 2026 ‚Äî Hardkodet filmdata fra officielt program
// Fredag 20. marts, L√∏rdag 21. marts, S√∏ndag 22. marts

const FILM_DATA = {
  "2026-03-20": [
    {title:"KNIFE: THE ATTEMPTED MURDER OF SALMAN RUSHDIE",time:"10:15",venue:"DFI / CINEMATEKET",duration:"107 min",description:"Den verdenskendte forfatter, der overlevede et brutalt attentatfors√∏g, konfronterer b√•de sin fortid og fremtid i en dybt personlig fort√¶lling om kampen for ytringsfrihed.",ticketUrl:"https://cphdox.dk/film/knife-the-attempted-murder-of-salman-rushdie"},
    {title:"AMADOU & MARIAM ‚Äì THE BLIND COUPLE FROM MALI",time:"12:15",venue:"GRAND TEATRET",duration:"82 min",description:"Den usandsynlige k√¶rlighedsfort√¶lling om de to blinde, maliske musikere Amadou og Mariam. Nu tager de hjem til Mali for at spille en stor koncert og indspille et sidste album.",ticketUrl:"https://cphdox.dk/film/amadou-mariam-the-blind-couple-from-mali"},
    {title:"SILENCED",time:"12:15",venue:"DFI / CINEMATEKET",duration:"97 min",description:"#MeToo br√∏d den kulturelle tavshed om k√∏nsbaseret vold. Nu k√¶mper menneskerettighedsadvokat Jennifer Robinson mod brugen af √¶reskr√¶nkelseslove som v√•ben til at bringe overlevere til tavshed.",ticketUrl:"https://cphdox.dk/film/silenced"},
    {title:"ARCTIC LINK",time:"13:00",venue:"DFI / CINEMATEKET",duration:"82 min",description:"Et fjernt hj√∏rne af Alaska bliver omsider koblet p√• internettet. En episk debutfilm om teknologi og forandringer, hvor alt er enormt ‚Äî fra kabler til billede og lyd.",ticketUrl:"https://cphdox.dk/film/arctic-link"},
    {title:"SOCIAL LANDSCAPES",time:"13:00",venue:"DAGMAR TEATRET",duration:"78 min",description:"En virtuel jordomrejse, udelukkende kommenteret af TripAdvisor. En dybt original film, som med n√•desl√∏s humor konfronterer os med en verden, hvor masseturismen har sejret.",ticketUrl:"https://cphdox.dk/film/social-landscapes"},
    {title:"THE GREAT EXPERIMENT",time:"14:15",venue:"GRAND TEATRET",duration:"100 min",description:"Det store, amerikanske eksperiment og dets dybe krise skildret i cinematisk sort-hvid. En politisk film til nuet og en tidskapsel til fremtiden.",ticketUrl:"https://cphdox.dk/film/the-great-experiment"},
    {title:"PHANTOMS + FALLEN NOON + THE FUTORA + COMPACT DISC",time:"14:30",venue:"DFI / CINEMATEKET",duration:"80 min",description:"Fire kortfilm om sp√∏gelser, teknologi og det skr√∏belige forhold mellem krop og billede af bl.a. Apichatpong Weerasethakul.",ticketUrl:"https://cphdox.dk/film/phantoms-fallen-noon-the-futora-compact-disc"},
    {title:"THE OLDEST PERSON IN THE WORLD",time:"14:30",venue:"GLORIA BIOGRAF",duration:"87 min",description:"Varm og underfundig film om livet, d√∏den og alt det ind imellem. Is√¶r ikke hvis man er et af verdens √¶ldste mennesker.",ticketUrl:"https://cphdox.dk/film/the-oldest-person-in-the-world"},
    {title:"POWWOW PEOPLE",time:"15:00",venue:"DFI / CINEMATEKET",duration:"88 min",description:"Fra morgengry til m√∏rket falder skildrer filmkunstneren Sky Hopinka en powwow, hvor USAs oprindelige folk m√∏des for at fejre f√¶llesskabet.",ticketUrl:"https://cphdox.dk/film/powwow-people"},
    {title:"GAZA'S TWINS, COME BACK TO ME",time:"15:00",venue:"DAGMAR TEATRET",duration:"96 min",description:"En kvinde adskilles fra sine nyf√∏dte tvillinger under krigen i Gaza. En lokal dokumentarist f√∏lger hende i 16 lange m√•neder, mens krig og kaos raser.",ticketUrl:"https://cphdox.dk/film/gazas-twins-come-back-to-me"},
    {title:"BELOW THE CLOUDS",time:"16:30",venue:"DAGMAR TEATRET",duration:"115 min",description:"I skyggen af Vesuv f√∏lger Gianfranco Rosi hverdagslivet for napolitanerne. Den sidste film i den prisvindende Italien-trilogi, fortalt i sublime sort-hvide billeder.",ticketUrl:"https://cphdox.dk/film/below-the-clouds"},
    {title:"SOMETHING FAMILIAR",time:"16:30",venue:"GLORIA BIOGRAF",duration:"90 min",description:"En britisk kvinde s√∏ger tilbage til sin families ophav i Rum√¶nien og opdager chokerende m√∏nstre i s√∏skendeflokken. Modigt, medrivende og med mere end et enkelt twist.",ticketUrl:"https://cphdox.dk/film/something-familiar"},
    {title:"DOUBLE TROUBLE",time:"16:30",venue:"FALKONER BIOGRAF",duration:"70 min",description:"Hvad f√•r man, hvis man overlader to aldrende, polske enker og slyngveninder i hinandens selskab i en landsby i Rum√¶nien? Double trouble!",ticketUrl:"https://cphdox.dk/film/double-trouble"},
    {title:"AMAZOMANIA",time:"16:45",venue:"EMPIRE BIO",duration:"93 min",description:"En farefuld ekspedition i Amazonas bliver til et moralsk minefelt om den hvide mands blik, da projektet vender kameraet mod sig selv og den koloniale arv.",ticketUrl:"https://cphdox.dk/film/amazomania"},
    {title:"CONSCIOUS",time:"16:45",venue:"DAGMAR TEATRET",duration:"80 min",description:"Kan vores subjektive bevidsthed unders√∏ges objektivt? Et filosofisk og videnskabeligt dilemma i en gribende film om hjernens mysterier, hvor livet selv indhenter en neuroforsker.",ticketUrl:"https://cphdox.dk/film/conscious"},
    {title:"BOUCHRA",time:"17:00",venue:"EMPIRE BIO",duration:"82 min",description:"En af √•rets mest originale film ‚Äî animeret autofiktion fra Marokko, hvor en queer filmskaber ringer hjem fra NYC til sin mor i Casablanca for at tale ud.",ticketUrl:"https://cphdox.dk/film/bouchra"},
    {title:"TO HOLD A MOUNTAIN",time:"17:00",venue:"DFI / CINEMATEKET",duration:"105 min",description:"√Örets Sundance-vinder er en sanselig og jordn√¶r skildring af livets gang hos en kvinde og en ung pige i Montenegros bjerge, som er i fare for at blive et tr√¶ningsomr√•de for NATO.",ticketUrl:"https://cphdox.dk/film/to-hold-a-mountain"},
    {title:"THE MUSICIAN AND THE WHALE",time:"17:00",venue:"BIG BIO NORDHAVN",duration:"83 min",description:"En elektronisk komponist drager ud mod det √•bne hav, hvor hans musik v√¶kker en dyb, poetisk resonans i en pukkelhval. Kan man kommunikere med havets dyr gennem musik?",ticketUrl:"https://cphdox.dk/film/the-musician-and-the-whale"},
    {title:"TRACES",time:"17:00",venue:"DAGMAR TEATRET",duration:"85 min",description:"Ukrainske kvinder, som har overlevet seksuel vold under Ruslands krig, n√¶gter at tie. Et brutalt √¶rligt vidnebyrd fra krigens kvindelige ofre.",ticketUrl:"https://cphdox.dk/film/traces"},
    {title:"THE BALLAD OF JUDAS PRIEST",time:"19:00",venue:"VALBY KINO SAL 1",duration:"98 min",description:"50 √•rs underholdende rockhistorie med de ikoniske heavy metal-legender for fuld spade ‚Äî med Tom Morello fra Rage Against the Machine som co-instrukt√∏r.",ticketUrl:"https://cphdox.dk/film/the-ballad-of-judas-priest"},
    {title:"BURNING VOICE",time:"19:00",venue:"EMPIRE BIO",duration:"84 min",description:"35-√•rige Tamara Amer k√¶mper en ind√¶dt kamp mod negativ social kontrol, tavshedskultur og undertrykkelse af kvinder i Irak, hvor hun selv er vokset op.",ticketUrl:"https://cphdox.dk/film/burning-voice"},
    {title:"PALESTINIAN UNWANTED",time:"19:00",venue:"FALKONER BIOGRAF",duration:"73 min",description:"Under bombardementerne af Gaza fors√∏ger en dansk-pal√¶stinensisk filmskaber at r√•be den danske offentlighed op. En dybt personlig film med en mission.",ticketUrl:"https://cphdox.dk/film/palestinian-unwanted"},
    {title:"DESIRE LINES",time:"19:00",venue:"DFI / CINEMATEKET",duration:"107 min",description:"Enigmatisk queerfabel om en s√∏vnl√∏s mand, der f√∏lger efter sin bror p√• cruising gennem Beograds dunkle n√¶tter. En elliptisk film om kroppe i bev√¶gelse.",ticketUrl:"https://cphdox.dk/film/desire-lines"},
    {title:"STORMBOUND",time:"19:00",venue:"VUE FISKETORVET",duration:"95 min",description:"Visuelt storsl√•et IMAX-film om verdens mest kraftfulde tornadoer og orkaner ‚Äî skildret indefra af en fotograf, der selv lever p√• l√•nt tid. Med en uventet k√¶rlighedshistorie.",ticketUrl:"https://cphdox.dk/film/stormbound"},
    {title:"MERCKX ‚Äì RACE OF A CHAMPION",time:"19:00",venue:"DAGMAR TEATRET",duration:"84 min",description:"Eddy Merckx er den st√∏rste cykelrytter nogensinde. Et stilfuldt portr√¶t af en uovervindelig mester i medgang og modgang.",ticketUrl:"https://cphdox.dk/film/merckx-race-of-a-champion"},
    {title:"INTELLIGENCE RISING",time:"19:00",venue:"VUE FISKETORVET",duration:"73 min",description:"T√¶nkere som Yuval Harari og ledere fra EU, Kina og USA deltager i et geopolitisk krigsspil om AI, konfronteret med scenarier for fremtidens mulige kriser.",ticketUrl:"https://cphdox.dk/film/intelligence-rising"},
    {title:"REDOUBT",time:"19:00",venue:"GRAND TEATRET",duration:"81 min",description:"En mand bygger en bunker af skrammel p√• en pl√∏jemark i Sk√•ne for at v√¶re klar, n√•r fjenden kommer. En moderne myte baseret p√• virkeligheden.",ticketUrl:"https://cphdox.dk/film/redoubt"},
    {title:"YUGO GOES TO AMERICA",time:"19:15",venue:"GLORIA BIOGRAF",duration:"87 min",description:"Tre unge venner fra Beograd k√∏rer fra New York til Los Angeles i Yugo ‚Äî et kultdyrket levn af en bil fra 80'erne. En livlig doku-komedie og et rabalder af et roadtrip.",ticketUrl:"https://cphdox.dk/film/yugo-goes-to-america"},
    {title:"WHERE THE SILENCE IS HEARD",time:"19:15",venue:"DFI / CINEMATEKET",duration:"94 min",description:"En ung chilensk kvinde flytter ind i et forladt hus i Valpara√≠so for at samle stumperne i sin egen families historie, farvet af diktatur, eksil og stilhed.",ticketUrl:"https://cphdox.dk/film/where-the-silence-is-heard"},
    {title:"CONSTRUCTION SITE",time:"19:15",venue:"DAGMAR TEATRET",duration:"94 min",description:"Stjerne-arkitekten Renzo Pianos projekt med at renovere en biograf midt i Paris ‚Äî et sp√¶ndende studie i at f√• visioner og praktiske realiteter til at g√• op.",ticketUrl:"https://cphdox.dk/film/construction-site"},
    {title:"KABUL BETWEEN PRAYERS",time:"19:30",venue:"BIG BIO NORDHAVN",duration:"112 min",description:"En ung Taliban-kriger viser sig at v√¶re et sammensat menneske, men de nedarvede ideologier er en tung bagage i et overd√•digt cinematisk festivalhit.",ticketUrl:"https://cphdox.dk/film/kabul-between-prayers"},
    {title:"TINGBJERG-EKSPERIMENTET",time:"19:30",venue:"DAGMAR TEATRET",duration:"75 min",description:"Hvad sker der, n√•r en udvalgt gruppe af unge, idealistiske familier fra middelklassen sl√•r sig ned i en k√∏benhavnsk 'ghetto' med en dr√∏m om at udvikle en ny bydel?",ticketUrl:"https://cphdox.dk/film/tingbjerg-eksperimentet"},
    {title:"THE AI DOC: HOW I BECAME AN APOCALOPTIMIST",time:"20:00",venue:"BREMEN TEATER",duration:"104 min",description:"AI √¶ndrer verden, som vi kender den. En Oscar-vindende instrukt√∏r stiller alle de sp√∏rgsm√•l, der holder ham v√•gen om natten, i en medrivende og foruroligende film.",ticketUrl:"https://cphdox.dk/film/the-ai-doc-how-i-became-an-apocaloptimist"},
    {title:"THE LIVES OF MY FATHER",time:"20:00",venue:"PARK BIO",duration:"86 min",description:"Han troede, at hans norske far var journalist. I virkeligheden var han spion for CIA. Nu skal sandheden frem, og den er vildere end fiktion.",ticketUrl:"https://cphdox.dk/film/the-lives-of-my-father"},
    {title:"KENNY DALGLISH",time:"21:00",venue:"EMPIRE BIO",duration:"103 min",description:"F√¶ngslende portr√¶t af den legendariske Liverpool-spiller Sir Kenny Dalglish, iscenesat af den Oscar-vindende instrukt√∏r bag 'Amy' og 'Maradona'.",ticketUrl:"https://cphdox.dk/film/kenny-dalglish"},
    {title:"SIRI HUSTVEDT ‚Äì DANCE AROUND THE SELF",time:"21:00",venue:"DAGMAR TEATRET",duration:"110 min",description:"Den norsk-amerikanske forfatter opruller sit livs rejse fra sit og √¶gtemanden Paul Austers smukke hjem i New York. En vellykket film om at v√¶lge et liv med litteratur og kunst.",ticketUrl:"https://cphdox.dk/film/siri-hustvedt-dance-around-the-self"},
    {title:"BOY GEORGE & CULTURE CLUB",time:"21:30",venue:"GLORIA BIOGRAF",duration:"96 min",description:"Historien om et af 80'ernes mest banebrydende popbands ‚Äî en dramatisk rejse fyldt med intern forelskelse, hemmelig homoseksualitet og destruktivt heroinmisbrug.",ticketUrl:"https://cphdox.dk/film/boy-george-culture-club"},
    {title:"LA BELLE ANN√âE",time:"21:30",venue:"DAGMAR TEATRET",duration:"90 min",description:"Som teenager var hun forelsket i sin l√¶rerinde. Nu vender en fransk-svensk filmskaber tilbage til sin ungdoms bes√¶ttelse i en smuk dagbogsfilm om beg√¶r og vampyrer.",ticketUrl:"https://cphdox.dk/film/la-belle-annee"},
    {title:"THE WAY ELSEWHERE",time:"21:30",venue:"DFI / CINEMATEKET",duration:"82 min",description:"Tre rutinerede taxachauff√∏rer k√∏rer rundt i Athens gader og dr√∏mmer om kunst og nye begyndelser i en finurlig og poetisk film for natteravne.",ticketUrl:"https://cphdox.dk/film/the-way-elsewhere"},
    {title:"OUR LAND",time:"21:30",venue:"DAGMAR TEATRET",duration:"91 min",description:"Har alle ret til at f√¶rdes frit i naturen? Ikke i England, hvor excentriske rigm√¶nd og naturelskere brydes om jorden.",ticketUrl:"https://cphdox.dk/film/our-land"},
    {title:"ALL ABOUT THE MONEY",time:"21:30",venue:"GRAND TEATRET",duration:"96 min",description:"Pengenes forbandelse og fortidens skygger hjems√∏ger en ung og ultrarig anti-kapitalist fra en af USAs rigeste familier.",ticketUrl:"https://cphdox.dk/film/all-about-the-money"},
    {title:"NOVA '78",time:"21:45",venue:"DFI / CINEMATEKET",duration:"78 min",description:"En aldrig f√∏r set tidskapsel fra William S. Burroughs' legendariske Nova Convention i New York, hvor ikoner som Patti Smith og Frank Zappa m√∏dtes.",ticketUrl:"https://cphdox.dk/film/nova-78"},
    {title:"NICK CAVE'S VEILED WORLD",time:"21:45",venue:"EMPIRE BIO",duration:"65 min",description:"Venner og kolleger tegner et intimt portr√¶t af Nick Cave ‚Äî en kunstner i forvandling, formet af sorg og jagten p√• mening efter tabet af sin s√∏n.",ticketUrl:"https://cphdox.dk/film/nick-caves-veiled-world"}
  ],
  "2026-03-21": [
    {title:"THE OLDEST PERSON IN THE WORLD",time:"10:00",venue:"DFI / CINEMATEKET",duration:"87 min",description:"Varm og underfundig film om livet, d√∏den og alt det ind imellem. Is√¶r ikke hvis man er et af verdens √¶ldste mennesker.",ticketUrl:"https://cphdox.dk/film/the-oldest-person-in-the-world"},
    {title:"WAX & GOLD",time:"12:00",venue:"DFI / CINEMATEKET",duration:"97 min",description:"Den √∏striske doku-veteran Ruth Beckermann er taget til Addis Ababa for at n√¶rme sig en historisk sandhed om Etiopiens splittede fortid.",ticketUrl:"https://cphdox.dk/film/wax-gold"},
    {title:"HOLDING LIAT",time:"12:00",venue:"DAGMAR TEATRET",duration:"97 min",description:"Vinderen af bedste dokumentar p√• Berlinale ‚Äî et komplekst portr√¶t af, hvordan en j√∏disk families tragedie den 7. oktober forvandles til en skakbrik i et geopolitisk spil.",ticketUrl:"https://cphdox.dk/film/holding-liat"},
    {title:"MOLLY VS THE MACHINES",time:"12:00",venue:"EMPIRE BIO",duration:"83 min",description:"Tech-giganternes ansvar for unge menneskers mentale sundhed s√¶ttes p√• pr√∏ve, da en tragedie i en britisk familie f√∏rer til retssag.",ticketUrl:"https://cphdox.dk/film/molly-vs-the-machines"},
    {title:"WATCHING PEOPLE WATCHING BIRDS",time:"12:30",venue:"EMPIRE BIO",duration:"90 min",description:"Himlens fugle er en truet dyreart, men verdens fuglekiggere er p√• sagen. En charmerende film om hobbyornitologer med Jonathan Franzen.",ticketUrl:"https://cphdox.dk/film/watching-people-watching-birds"},
    {title:"I WANT HER DEAD",time:"12:30",venue:"GRAND TEATRET",duration:"85 min",description:"I en calabrisk landsby trues freden af to svigerinders √•relange familiefejde. Et tragikomisk portr√¶t af familiehad, hvor det √¶rke-italienske melodrama lever.",ticketUrl:"https://cphdox.dk/film/i-want-her-dead"},
    {title:"COLLAPSE",time:"13:15",venue:"KUNSTHAL CHARLOTTENBORG",duration:"78 min",description:"Kort efter 7. oktober 2023 vender en israelsk filmskaber hjem til sin √∏delagte kibbutz. Et essayistisk vidnesbyrd om krig og tab.",ticketUrl:"https://cphdox.dk/film/collapse"},
    {title:"DRY LEAF",time:"14:00",venue:"EMPIRE BIO",duration:"186 min",description:"Et moderne eventyr, hvor virkelighedens verden (gen)fortrylles med en fabelagtig filmkunstnerisk opfindsomhed af den georgiske filmkunstner Alexandre Koberidze.",ticketUrl:"https://cphdox.dk/film/dry-leaf"},
    {title:"TUTU",time:"14:00",venue:"DAGMAR TEATRET",duration:"101 min",description:"Et historisk og inspirerende portr√¶t af den sydafrikanske Nobelprisvinder og √¶rkebiskop Desmond Tutu, der samlede en hel generation i kampen mod apartheid.",ticketUrl:"https://cphdox.dk/film/tutu"},
    {title:"LITTLE SINNER",time:"14:15",venue:"DFI / CINEMATEKET",duration:"90 min",description:"20 √•rs dybt personlige optagelser er samlet i en r√• og ufiltreret rejse fra Damaskus til Danmark og skildrer en syrisk kvindes kamp mod vold og svigt.",ticketUrl:"https://cphdox.dk/film/little-sinner"},
    {title:"A WORLD GONE MAD ‚Äì THE WAR DIARIES OF ASTRID LINDGREN",time:"14:30",venue:"PARK BIO",duration:"98 min",description:"Den svenske forfatters unge √•r under 2. verdenskrig, fortalt gennem hendes egne dagb√∏ger i en smuk film om livet og kunsten i krigens skygge.",ticketUrl:"https://cphdox.dk/film/a-world-gone-mad-the-war-diaries-of-astrid-lindgren"},
    {title:"THE CYCLE OF LOVE",time:"14:30",venue:"GRAND TEATRET",duration:"98 min",description:"En ung, indisk mand cykler 10.000 km fra Delhi til Sverige for at genfinde sit livs k√¶rlighed. En episk eventyrfilm og et af √•rets st√∏rste romantiske publikums-hits.",ticketUrl:"https://cphdox.dk/film/the-cycle-of-love"},
    {title:"FINDING CONNECTION",time:"14:30",venue:"DFI / CINEMATEKET",duration:"86 min",description:"Hvad er et forhold egentlig? N√•r mennesker forelsker sig i robotter, starter en lavine af eksistentielle sp√∏rgsm√•l. Engang var det sci-fi, nu er det hverdag.",ticketUrl:"https://cphdox.dk/film/finding-connection"},
    {title:"JASON'S BOX",time:"14:30",venue:"EMPIRE BIO",duration:"89 min",description:"Hvad sker der, n√•r en erfaren klimaforsker springer ud som aktivist? I Gr√∏nland starter forskeren Jason Box et radikalt projekt, der skal r√•be verden op.",ticketUrl:"https://cphdox.dk/film/jasons-box"},
    {title:"DRACULA",time:"15:00",venue:"GLORIA BIOGRAF",duration:"170 min",description:"Rum√¶nske Radu Jude v√¶lter Dracula ud af kisten i en kulsort komedie fra Transsylvanien. Ingen piller ved nationale myter med samme fandenivoldskhed.",ticketUrl:"https://cphdox.dk/film/dracula"},
    {title:"THE CALF DOLL",time:"15:00",venue:"KUNSTHAL CHARLOTTENBORG",duration:"90 min",description:"Billedsk√∏n fabel fra Indien, hvor beboerne i en lille landsby spiller sig selv i en enkel og g√•defuld fort√¶lling om en mand og hans ko.",ticketUrl:"https://cphdox.dk/film/the-calf-doll"},
    {title:"THE AI DOC: HOW I BECAME AN APOCALOPTIMIST",time:"15:00",venue:"BREMEN TEATER",duration:"104 min",description:"AI √¶ndrer verden, som vi kender den. En Oscar-vindende instrukt√∏r stiller alle de sp√∏rgsm√•l, der holder ham v√•gen om natten.",ticketUrl:"https://cphdox.dk/film/the-ai-doc-how-i-became-an-apocaloptimist"},
    {title:"WAKING HOURS",time:"16:15",venue:"DAGMAR TEATRET",duration:"78 min",description:"Smuglere f√∏rer mennesker over gr√¶nsen til Europa i en endel√∏s, s√∏vnl√∏s nat. En cinematisk film optaget i b√¶lgm√∏rke, som for alt i verden skal ses i biografen.",ticketUrl:"https://cphdox.dk/film/waking-hours"},
    {title:"ADAM'S APPLE",time:"16:30",venue:"FALKONER BIOGRAF",duration:"97 min",description:"En mor har fulgt sin transk√∏nnede teenager gennem en kameralinse over to √•rtier. En r√∏rende og √∏jen√•bnende beretning om for√¶ldre og b√∏rn.",ticketUrl:"https://cphdox.dk/film/adams-apple"},
    {title:"MATTER OF BRITAIN",time:"16:30",venue:"DFI / CINEMATEKET",duration:"103 min",description:"En hel britisk landsby genspiller myten om Den Hellige Gral som en kollektiv performance over et helt √•r. En enest√•ende debutfilm med enorm forestillingskraft.",ticketUrl:"https://cphdox.dk/film/matter-of-britain"},
    {title:"√òLPARADISET",time:"16:30",venue:"DAGMAR TEATRET",duration:"80 min",description:"Hvad sker der med mennesker, etik og moral, n√•r alkohol og kapitalisme slippes l√∏s i et fattigt og korrupt land med f√• restriktioner?",ticketUrl:"https://cphdox.dk/film/oelparadiset"},
    {title:"ARCTIC LINK",time:"16:30",venue:"EMPIRE BIO",duration:"82 min",description:"Et fjernt hj√∏rne af Alaska bliver omsider koblet p√• internettet. En episk debutfilm om teknologi og forandringer, hvor alt er enormt.",ticketUrl:"https://cphdox.dk/film/arctic-link"},
    {title:"A CHILD OF MY OWN",time:"16:45",venue:"GRAND TEATRET",duration:"93 min",description:"En ung, mexicansk kvinde faker sin egen graviditet, men bliver snart et gidsel af sine historier. En utrolig historie fortalt af Oscar-nominerede Maite Alberdi.",ticketUrl:"https://cphdox.dk/film/a-child-of-my-own"},
    {title:"80 ANGRY JOURNALISTS",time:"16:45",venue:"DAGMAR TEATRET",duration:"94 min",description:"Da Ungarns st√∏rste nyhedsredaktion kollapser under politisk pres, fanger en journalist historien bag en kollektiv kamp for pressefrihed.",ticketUrl:"https://cphdox.dk/film/80-angry-journalists"},
    {title:"LIKE ANY OTHER MORTAL",time:"16:45",venue:"DFI / CINEMATEKET",duration:"92 min",description:"En ensom robot k√∏rer rundt p√• en fjern planet for at finde tegn p√• liv, mens forskere leder efter ukendte livsformer i et Marslandskab i Andalusien.",ticketUrl:"https://cphdox.dk/film/like-any-other-mortal"},
    {title:"ELON MUSK UNVEILED ‚Äì THE TESLA EXPERIMENT",time:"17:00",venue:"PARK BIO",duration:"90 min",description:"Elon Musk √∏nsker at komme f√∏rst i kapl√∏bet om selvk√∏rende biler, men det har en pris. En doku-thriller om Teslas fatale sikkerhedsbrist.",ticketUrl:"https://cphdox.dk/film/elon-musk-unveiled-the-tesla-experiment"},
    {title:"KAMPEN OM LYNETTEHOLM",time:"17:30",venue:"EMPIRE BIO",duration:"58 min",description:"Klimabev√¶gelsen og deres to advokater udfordrer den danske stat i en h√∏jsp√¶ndt retssag for at standse Lynetteholm.",ticketUrl:"https://cphdox.dk/film/kampen-om-lynetteholm"},
    {title:"DOUBLE TROUBLE",time:"18:00",venue:"DAGMAR TEATRET",duration:"70 min",description:"Hvad f√•r man, hvis man overlader to aldrende, polske enker og slyngveninder i hinandens selskab i en landsby i Rum√¶nien?",ticketUrl:"https://cphdox.dk/film/double-trouble"},
    {title:"PATRIARKEN",time:"18:00",venue:"BREMEN TEATER",duration:"55 min",description:"Filmproducer Peter Aalb√¶k er selverkl√¶ret patriark. Nu bliver han sendt i terapi af sine d√∏tre. Et k√¶rligt, sjovt og n√•desl√∏st portr√¶t af en truet art.",ticketUrl:"https://cphdox.dk/film/patriarken"},
    {title:"HJEMS√òGT",time:"19:00",venue:"GLORIA BIOGRAF",duration:"90 min",description:"Instrukt√∏rens rejse som adopteret fra Sydkoreas bjerge til Danmarks vestkyst, hvor en konfrontation med adoptionssystemet forbinder en dysfunktionel jysk familie med et udslettet koreansk ophav.",ticketUrl:"https://cphdox.dk/film/hjems√∏gt"},
    {title:"MARIINKA",time:"19:00",venue:"GRAND TEATRET",duration:"94 min",description:"Unge ukrainere fra byen Mariinka st√•r over for et √•rti med krig, der splitter deres familier. Et episk og vision√¶rt mesterv√¶rk filmet over 10 √•r.",ticketUrl:"https://cphdox.dk/film/mariinka"},
    {title:"WE WANT THE FUNK",time:"19:00",venue:"FALKONER BIOGRAF",duration:"84 min",description:"G√∏r dig klar til at blive ramt af ren funk-eksplosion! Vilde historier fra 70'erne tilsat svedige basgange, elektriske grooves og den slags rytmer, der g√•r lige i kroppen.",ticketUrl:"https://cphdox.dk/film/we-want-the-funk"},
    {title:"KING HAMLET",time:"19:00",venue:"VUE FISKETORVET",duration:"89 min",description:"Den danske dokumentarist Elvira Linds vender tilbage med et dybt personligt portr√¶t af sin mand, skuespilleren Oscar Isaac, der st√•r over for sit livs sv√¶reste rolle.",ticketUrl:"https://cphdox.dk/film/king-hamlet"},
    {title:"STORMBOUND",time:"19:00",venue:"EMPIRE BIO",duration:"95 min",description:"Visuelt storsl√•et IMAX-film om verdens mest kraftfulde tornadoer og orkaner ‚Äî skildret indefra af en fotograf, der selv lever p√• l√•nt tid.",ticketUrl:"https://cphdox.dk/film/stormbound"},
    {title:"QAJAQ MAN",time:"19:00",venue:"DAGMAR TEATRET",duration:"67 min",description:"En britisk kok padler 3.000 kilometer langs Gr√∏nlands vestkyst, overlever p√• naturens n√•de og opdager f√¶llesskabets styrke.",ticketUrl:"https://cphdox.dk/film/qajaq-man"},
    {title:"THE SANDBOX",time:"19:00",venue:"DFI / CINEMATEKET",duration:"90 min",description:"Klarsynet kortl√¶gning af brudfladerne i det 21. √•rhundredes verdenskort. Magtpolitik, migration og overv√•gning skildret med skarphed og kunstnerisk vision.",ticketUrl:"https://cphdox.dk/film/the-sandbox"},
    {title:"THE HISTORY OF CONCRETE",time:"19:15",venue:"DFI / CINEMATEKET",duration:"101 min",description:"Manden bag HBO-serien 'How To with John Wilson' debuterer med sin f√∏rste spillefilm ‚Äî en hylemorsom og sk√¶v unders√∏gelse af beton som fundamentalt element i bylivet.",ticketUrl:"https://cphdox.dk/film/the-history-of-concrete"},
    {title:"MOUNTAIN OF GOLD",time:"19:15",venue:"DAGMAR TEATRET",duration:"85 min",description:"Med dollartegn i √∏jnene begiver guldgravere sig ud i et goldt √∏rkenlandskab i Niger. En intens doku-thriller om guldfeberens rasen.",ticketUrl:"https://cphdox.dk/film/mountain-of-gold"},
    {title:"PETROLHEADS",time:"19:30",venue:"BIG BIO NORDHAVN",duration:"77 min",description:"To helt s√¶rlige venner k√∏rer de danske landeveje tynde for at finde en brugt Honda Civic. En film, der g√•r lige i hjertet.",ticketUrl:"https://cphdox.dk/film/petrolheads"},
    {title:"A LIFE ILLUMINATED",time:"19:30",venue:"DAGMAR TEATRET",duration:"89 min",description:"P√• ekspedition i dybhavet med marinebiologen Edie Widder p√• mission: at dokumentere de selvlysende livsformer i det t√¶tteste m√∏rke.",ticketUrl:"https://cphdox.dk/film/a-life-illuminated"},
    {title:"ALL ABOUT THE MONEY",time:"20:00",venue:"PARK BIO",duration:"96 min",description:"Pengenes forbandelse og fortidens skygger hjems√∏ger en ung og ultrarig anti-kapitalist fra en af USAs rigeste familier.",ticketUrl:"https://cphdox.dk/film/all-about-the-money"},
    {title:"THE BALLAD OF JUDAS PRIEST",time:"21:00",venue:"EMPIRE BIO",duration:"98 min",description:"50 √•rs underholdende rockhistorie med de ikoniske heavy metal-legender for fuld spade ‚Äî med Tom Morello som co-instrukt√∏r.",ticketUrl:"https://cphdox.dk/film/the-ballad-of-judas-priest"},
    {title:"IN-I IN MOTION",time:"21:00",venue:"DAGMAR TEATRET",duration:"127 min",description:"Juliette Binoche bes√∏ger CPH:DOX med sin debutfilm som instrukt√∏r: en intim film om den kr√¶vende og kreative proces med at udvikle en danseforestilling.",ticketUrl:"https://cphdox.dk/film/in-i-in-motion"},
    {title:"BARRIO TRISTE",time:"21:15",venue:"DFI / CINEMATEKET",duration:"89 min",description:"√Örets vildeste banger! H√¶sbl√¶sende og trippet sensation af en hybridfilm fra colombianske Medell√≠n. Produceret af Harmony Korine med score af Arca.",ticketUrl:"https://cphdox.dk/film/barrio-triste"},
    {title:"BETTER GO MAD IN THE WILD",time:"21:15",venue:"DAGMAR TEATRET",duration:"83 min",description:"Tjekkisk festivalhit om to aldrende tvillinger med revolution√¶rt blod i √•rene, der har skabt sig en magisk verden p√• en g√•rd uden for samfundet.",ticketUrl:"https://cphdox.dk/film/better-go-mad-in-the-wild"},
    {title:"SUMMER TOUR",time:"21:15",venue:"EMPIRE BIO",duration:"82 min",description:"Hop ombord i syresl√¶den p√• roadtrip gennem sommeren med to vanvittigt s√∏de 'Deadheads', n√•r de triller i h√¶lene p√• Grateful Dead p√• deres sidste turne.",ticketUrl:"https://cphdox.dk/film/summer-tour"},
    {title:"MARE'S NEST",time:"21:30",venue:"GLORIA BIOGRAF",duration:"98 min",description:"CPH:DOX-vinderen Ben Rivers er tilbage med en trippet og magisk hybridfilm baseret p√• et stykke af Don DeLillo om en piges rejse fra stenalderen til fremtiden.",ticketUrl:"https://cphdox.dk/film/mares-nest"},
    {title:"FANTASY",time:"21:30",venue:"DAGMAR TEATRET",duration:"79 min",description:"Seksualitet, kropslighed og m√∏rke lyster er drivkraften i en original, fransk hybridfilm om en ung kvinde, der mister en notesbog med alle sine hemmeligheder.",ticketUrl:"https://cphdox.dk/film/fantasy"},
    {title:"WHISPERS IN MAY",time:"21:30",venue:"DFI / CINEMATEKET",duration:"95 min",description:"Tre kinesiske piger tager p√• et eventyrligt roadtrip gennem de barske bjerge i Sichuan-provinsen i en enest√•ende debutfilm.",ticketUrl:"https://cphdox.dk/film/whispers-in-may"},
    {title:"WE WANT THE FUNK",time:"21:30",venue:"GRAND TEATRET",duration:"84 min",description:"G√∏r dig klar til at blive ramt af ren funk-eksplosion! Vilde historier fra 70'erne tilsat svedige basgange og elektriske grooves.",ticketUrl:"https://cphdox.dk/film/we-want-the-funk"}
  ],
  "2026-03-22": [
    {title:"KNIFE: THE ATTEMPTED MURDER OF SALMAN RUSHDIE",time:"12:15",venue:"BREMEN TEATER",duration:"107 min",description:"Den verdenskendte forfatter, der overlevede et brutalt attentatfors√∏g, konfronterer b√•de sin fortid og fremtid.",ticketUrl:"https://cphdox.dk/film/knife-the-attempted-murder-of-salman-rushdie"},
    {title:"THE HISTORY OF CONCRETE",time:"12:15",venue:"GRAND TEATRET",duration:"101 min",description:"Manden bag HBO-serien 'How To with John Wilson' debuterer med sin f√∏rste spillefilm ‚Äî en hylemorsom og sk√¶v unders√∏gelse af beton.",ticketUrl:"https://cphdox.dk/film/the-history-of-concrete"},
    {title:"PHENOMENA",time:"12:15",venue:"EMPIRE BIO",duration:"86 min",description:"En psykedelisk odyss√© ind i universets struktur, guidet af en filmskabers eksperimenter i hans garage. Til et score af Nils Frahm og River Consoles.",ticketUrl:"https://cphdox.dk/film/phenomena"},
    {title:"CELTIC UTOPIA",time:"12:30",venue:"DAGMAR TEATRET",duration:"90 min",description:"Hvordan lyder den irske folkemusik anno 2026? Sangen holdes i live over hele Irland p√• de utallige pubs, hvor genren stadig blomstrer.",ticketUrl:"https://cphdox.dk/film/celtic-utopia"},
    {title:"TINGBJERG-EKSPERIMENTET",time:"12:30",venue:"EMPIRE BIO",duration:"75 min",description:"Hvad sker der, n√•r unge, idealistiske familier fra middelklassen sl√•r sig ned i en k√∏benhavnsk 'ghetto' med en dr√∏m om at udvikle en ny bydel?",ticketUrl:"https://cphdox.dk/film/tingbjerg-eksperimentet"},
    {title:"THE PHANTOM PAIN OF ROJAVA",time:"13:00",venue:"KUNSTHAL CHARLOTTENBORG",duration:"81 min",description:"I et hemmeligt hus i det nordlige Syrien lever s√•rede, kurdiske guerillasoldater med fantomsmerter i skyggen af en svigtet revolution.",ticketUrl:"https://cphdox.dk/film/the-phantom-pain-of-rojava"},
    {title:"POWWOW PEOPLE",time:"13:15",venue:"KUNSTHAL CHARLOTTENBORG",duration:"88 min",description:"Fra morgengry til m√∏rket falder skildrer filmkunstneren Sky Hopinka en powwow, hvor USAs oprindelige folk m√∏des for at fejre f√¶llesskabet.",ticketUrl:"https://cphdox.dk/film/powwow-people"},
    {title:"DAUGHTERS OF THE FOREST",time:"14:15",venue:"EMPIRE BIO",duration:"95 min",description:"Science fiction m√∏der gamle praksisser dybt inde i Mexicos svamperige skove, hvor to kvindelige mykologer s√∏ger at forene fortid og nutid.",ticketUrl:"https://cphdox.dk/film/daughters-of-the-forest"},
    {title:"WHERE THE SILENCE IS HEARD",time:"14:30",venue:"EMPIRE BIO",duration:"94 min",description:"En ung chilensk kvinde flytter ind i et forladt hus i Valpara√≠so for at samle stumperne i sin families historie, farvet af diktatur og eksil.",ticketUrl:"https://cphdox.dk/film/where-the-silence-is-heard"},
    {title:"MERCKX ‚Äì RACE OF A CHAMPION",time:"14:30",venue:"GRAND TEATRET",duration:"84 min",description:"Eddy Merckx er den st√∏rste cykelrytter nogensinde. Et stilfuldt portr√¶t af en uovervindelig mester i medgang og modgang.",ticketUrl:"https://cphdox.dk/film/merckx-race-of-a-champion"},
    {title:"AMADOU & MARIAM ‚Äì THE BLIND COUPLE FROM MALI",time:"14:30",venue:"DAGMAR TEATRET",duration:"82 min",description:"Den usandsynlige k√¶rlighedsfort√¶lling om de to blinde, maliske musikere Amadou og Mariam, der nu tager hjem til Mali.",ticketUrl:"https://cphdox.dk/film/amadou-mariam-the-blind-couple-from-mali"},
    {title:"SILENCED",time:"14:30",venue:"PARK BIO",duration:"97 min",description:"#MeToo br√∏d den kulturelle tavshed om k√∏nsbaseret vold. Jennifer Robinson k√¶mper mod brugen af √¶reskr√¶nkelseslove som v√•ben.",ticketUrl:"https://cphdox.dk/film/silenced"},
    {title:"AM√çLCAR",time:"14:30",venue:"GRAND TEATRET",duration:"84 min",description:"Bl√¶ndende smukt portr√¶t af anti-kolonialismens mest ikoniske karakter, Am√≠lcar Cabral ‚Äî guerillaleder, poet og agronom.",ticketUrl:"https://cphdox.dk/film/amilcar"},
    {title:"GAZA'S TWINS, COME BACK TO ME",time:"15:00",venue:"DFI / CINEMATEKET",duration:"96 min",description:"En kvinde adskilles fra sine nyf√∏dte tvillinger under krigen i Gaza. En lokal dokumentarist f√∏lger hende i 16 lange m√•neder.",ticketUrl:"https://cphdox.dk/film/gazas-twins-come-back-to-me"},
    {title:"THIS IS NOT A FRENCH FILM",time:"15:15",venue:"KUNSTHAL CHARLOTTENBORG",duration:"80 min",description:"En ung, racialiseret instrukt√∏rs b√∏vl med at lave sin debutfilm bliver til en doku-satire med politisk punch, der tager √©n ved n√¶sen.",ticketUrl:"https://cphdox.dk/film/this-is-not-a-french-film"},
    {title:"THE OLIGARCH AND THE ART DEALER",time:"15:30",venue:"KUNSTHAL CHARLOTTENBORG",duration:"174 min",description:"Den utrolige historien om en af det 21. √•rhundredes mest opsigtsv√¶kkende kunstskandaler ‚Äî en 10 √•r lang krig om milliarder.",ticketUrl:"https://cphdox.dk/film/the-oligarch-and-the-art-dealer"},
    {title:"MARIINKA",time:"15:30",venue:"BREMEN TEATER",duration:"94 min",description:"Unge ukrainere fra byen Mariinka st√•r over for et √•rti med krig, der splitter deres familier. Et episk mesterv√¶rk filmet over 10 √•r.",ticketUrl:"https://cphdox.dk/film/mariinka"},
    {title:"HELL'S ARMY",time:"16:15",venue:"DAGMAR TEATRET",duration:"92 min",description:"En russisk dissident-journalist afd√¶kker verdens mest frygtede lejeh√¶r, Wagner-gruppen. Under d√∏dstrusler k√¶mper hun for at afsl√∏re dem.",ticketUrl:"https://cphdox.dk/film/hells-army"},
    {title:"I HEARD THAT THEY ARE NOT GOING TO SEE EACH OTHER ANYMORE",time:"16:15",venue:"EMPIRE BIO",duration:"86 min",description:"Ung k√¶rlighed og forbundne liv i Taipei i en romantisk og charmerende debutfilm, der opl√∏ser gr√¶nsen mellem fiktion og virkelighed.",ticketUrl:"https://cphdox.dk/film/i-heard-that-they-are-not-going-to-see-each-other-anymore"},
    {title:"OPEN MY MIND",time:"16:30",venue:"FALKONER BIOGRAF",duration:"95 min",description:"Den eksperimentelle, psykedeliske terapi s√¶ttes p√• pr√∏ve i en lige dele videnskabelig og dybt personlig film, hvor hovedpersonen selv er fors√∏gskanin.",ticketUrl:"https://cphdox.dk/film/open-my-mind"},
    {title:"IN DEFENSE OF SELF",time:"16:30",venue:"DAGMAR TEATRET",duration:"87 min",description:"Et tragisk drab p√• en norsk mand med akut brug for psykiatrisk hj√¶lp rulles op i en film, der sp√∏rger hvad der skete ‚Äî og hvordan det kunne undg√•s.",ticketUrl:"https://cphdox.dk/film/in-defense-of-self"},
    {title:"A LITTLE GRAY WOLF WILL COME",time:"16:30",venue:"EMPIRE BIO",duration:"90 min",description:"En russisk journalist og hendes unge, vestligtsindede datter rejser tv√¶rs gennem Putins Rusland for at konfrontere sig selv med deres politiske uenigheder.",ticketUrl:"https://cphdox.dk/film/a-little-gray-wolf-will-come"},
    {title:"MEMORY OF PRINCESS MUMBI",time:"16:30",venue:"GRAND TEATRET",duration:"79 min",description:"I et futuristisk Afrika forelsker en filmskaber sig i sin hovedperson og mister kontrollen over sin film. Et legesygt og originalt sci-fi-mockumentary.",ticketUrl:"https://cphdox.dk/film/memory-of-princess-mumbi"},
    {title:"THE SANDBOX",time:"16:30",venue:"GRAND TEATRET",duration:"90 min",description:"Klarsynet kortl√¶gning af brudfladerne i det 21. √•rhundredes verdenskort. Magtpolitik, migration og overv√•gning.",ticketUrl:"https://cphdox.dk/film/the-sandbox"},
    {title:"MYSTERIET OM MENOPAUSEN",time:"16:45",venue:"PARK BIO",duration:"74 min",description:"En personlig og unders√∏gende dokumentarfilm om en livsfase, som halvdelen af verdens befolkning gennemlever, og som vi ved forbl√∏ffende lidt om.",ticketUrl:"https://cphdox.dk/film/mysteriet-om-menopausen"},
    {title:"THE SALISBURY POISONINGS: A SPY NEXT DOOR",time:"16:45",venue:"DAGMAR TEATRET",duration:"79 min",description:"Nervegift-angrebet p√• en russisk spion i en idyllisk, engelsk provinsby t√¶nder alle r√∏de alarmer i Downing Street. En virkelig doku-thriller.",ticketUrl:"https://cphdox.dk/film/the-salisbury-poisonings-a-spy-next-door"},
    {title:"THE ARCTIC CIRCLE OF LUST",time:"17:00",venue:"BIG BIO NORDHAVN",duration:"97 min",description:"Langt oppe i Finland skal et midaldrende √¶gtepar af kartoffelavlere enes om reglerne for at leve sammen p√• ny, da mandens biseksualitet s√¶tter k√¶rlighedens gr√¶nser p√• pr√∏ve.",ticketUrl:"https://cphdox.dk/film/the-arctic-circle-of-lust"},
    {title:"CINEMA KAWAKEB",time:"17:00",venue:"KUNSTHAL CHARLOTTENBORG",duration:"78 min",description:"Et charmerende og opfindsomt bes√∏g i en slidt bagg√•rdsbiograf i Jordan, hvor de to ansatte og deres eneste stamg√¶st er hovedpersoner.",ticketUrl:"https://cphdox.dk/film/cinema-kawakeb"},
    {title:"BAUHAUS FOREVER.",time:"18:30",venue:"PARK BIO",duration:"96 min",description:"Et cinematisk manifest dedikeret til Bauhaus-bev√¶gelsen, der revolutionerede moderne kunst, design og arkitektur.",ticketUrl:"https://cphdox.dk/film/bauhaus-forever"},
    {title:"LANDMARKS",time:"18:30",venue:"DFI / CINEMATEKET",duration:"122 min",description:"Mordet p√• en forsvarsl√∏s leder af et oprindeligt folk tr√¶kker tr√•de til √•rtiers tyverier af land og kolonialisme ‚Äî Lucrecia Martels doku-debut.",ticketUrl:"https://cphdox.dk/film/landmarks"},
    {title:"ALL RIVERS SPILL THEIR STORIES TO THE SEA",time:"18:30",venue:"DAGMAR TEATRET",duration:"90 min",description:"En b√∏lge af bibelske plager i det nord√∏stlige England, hvor fiskere, √∏ko-aktivister og erhvervsfolk k√¶mper om fremtiden efter Brexit.",ticketUrl:"https://cphdox.dk/film/all-rivers-spill-their-stories-to-the-sea"},
    {title:"TO HOLD A MOUNTAIN",time:"18:30",venue:"EMPIRE BIO",duration:"105 min",description:"√Örets Sundance-vinder er en sanselig og jordn√¶r skildring af livets gang i Montenegros bjerge, som er i fare for at blive et NATO-tr√¶ningsomr√•de.",ticketUrl:"https://cphdox.dk/film/to-hold-a-mountain"},
    {title:"KENNY DALGLISH",time:"19:00",venue:"FALKONER BIOGRAF",duration:"103 min",description:"F√¶ngslende portr√¶t af den legendariske Liverpool-spiller Sir Kenny Dalglish, iscenesat af den Oscar-vindende instrukt√∏r bag 'Amy' og 'Maradona'.",ticketUrl:"https://cphdox.dk/film/kenny-dalglish"},
    {title:"BOUCHRA",time:"19:00",venue:"GLORIA BIOGRAF",duration:"82 min",description:"En af √•rets mest originale film ‚Äî animeret autofiktion fra Marokko, hvor en queer filmskaber ringer hjem fra NYC til sin mor i Casablanca.",ticketUrl:"https://cphdox.dk/film/bouchra"},
    {title:"THE AI DOC: HOW I BECAME AN APOCALOPTIMIST",time:"19:00",venue:"VUE FISKETORVET",duration:"104 min",description:"AI √¶ndrer verden, som vi kender den. En Oscar-vindende instrukt√∏r stiller alle de sp√∏rgsm√•l, der holder ham v√•gen om natten.",ticketUrl:"https://cphdox.dk/film/the-ai-doc-how-i-became-an-apocaloptimist"},
    {title:"WAX & GOLD",time:"19:00",venue:"KUNSTHAL CHARLOTTENBORG",duration:"97 min",description:"Den √∏striske doku-veteran Ruth Beckermann er taget til Addis Ababa for at n√¶rme sig en historisk sandhed om Etiopiens splittede fortid.",ticketUrl:"https://cphdox.dk/film/wax-gold"},
    {title:"TIME AND WATER",time:"19:00",venue:"GRAND TEATRET",duration:"90 min",description:"Islands urgamle landskaber er i forandring, og det s√¶tter tankerne i gang hos forfatteren Andri Sn√¶r Magnason. Fra instrukt√∏ren af 'Fire of Love'.",ticketUrl:"https://cphdox.dk/film/time-and-water"},
    {title:"KING HAMLET",time:"19:00",venue:"DAGMAR TEATRET",duration:"89 min",description:"Den danske dokumentarist Elvira Linds vender tilbage med et dybt personligt portr√¶t af sin mand, skuespilleren Oscar Isaac.",ticketUrl:"https://cphdox.dk/film/king-hamlet"},
    {title:"LITTLE SINNER",time:"19:00",venue:"EMPIRE BIO",duration:"90 min",description:"20 √•rs dybt personlige optagelser fra Damaskus til Danmark ‚Äî en syrisk kvindes uafrystelige kamp mod vold og arven fra fortiden.",ticketUrl:"https://cphdox.dk/film/little-sinner"},
    {title:"YUGO GOES TO AMERICA",time:"19:15",venue:"DAGMAR TEATRET",duration:"87 min",description:"Tre unge venner fra Beograd k√∏rer fra New York til Los Angeles i Yugo ‚Äî en livlig doku-komedie og et rabalder af et roadtrip.",ticketUrl:"https://cphdox.dk/film/yugo-goes-to-america"},
    {title:"A SWEETNESS FROM NOWHERE",time:"19:30",venue:"KUNSTHAL CHARLOTTENBORG",duration:"86 min",description:"En performativ og visuelt eksplosiv forvandlingskugle af en film, hvor levede erfaringer tager form i en konstant tilblivelse.",ticketUrl:"https://cphdox.dk/film/a-sweetness-from-nowhere"},
    {title:"KIKUYU LAND",time:"19:30",venue:"BIG BIO NORDHAVN",duration:"95 min",description:"En kenyansk journalist vender tilbage til sine forf√¶dres hjem for at d√¶kke en juridisk kamp ‚Äî men m√• forholde sig til sin egen families usk√∏nne rolle.",ticketUrl:"https://cphdox.dk/film/kikuyu-land"},
    {title:"THE GREAT EXPERIMENT",time:"20:30",venue:"PARK BIO",duration:"100 min",description:"Det store, amerikanske eksperiment og dets dybe krise skildret i cinematisk sort-hvid. En politisk film til nuet og en tidskapsel til fremtiden.",ticketUrl:"https://cphdox.dk/film/the-great-experiment"},
    {title:"BELLEVILLE BEATS",time:"20:45",venue:"DAGMAR TEATRET",duration:"87 min",description:"Det er sommer i Paris, og i en ungdomsklub i Belleville-kvarteret har de unge f√•et en id√©: De vil arrangere en musikfestival i en park.",ticketUrl:"https://cphdox.dk/film/belleville-beats"},
    {title:"JARIPEO",time:"21:00",venue:"GRAND TEATRET",duration:"71 min",description:"Bag et mexicansk rodeo-shows hypermaskuline ritualer pulserer et skjult queer-beg√¶r. Et festival-hit om performativ maskulinitet.",ticketUrl:"https://cphdox.dk/film/jaripeo"},
    {title:"EVERYONE IS LYING TO YOU FOR MONEY",time:"21:00",venue:"DAGMAR TEATRET",duration:"90 min",description:"Filmstjernen Ben McKenzies underholdende og √∏jen√•bnende debutfilm ‚Äî for kryptovaluta, hvad 'The Big Short' var for finanskrisen.",ticketUrl:"https://cphdox.dk/film/everyone-is-lying-to-you-for-money"},
    {title:"THE CORD",time:"21:00",venue:"EMPIRE BIO",duration:"95 min",description:"I Venezuelas √∏delagte sundhedssystem henter moderskabs-aktivisten Carolina styrke fra en fortid som bandeleder for at hj√¶lpe gravide kvinder.",ticketUrl:"https://cphdox.dk/film/the-cord"},
    {title:"REDOUBT",time:"21:00",venue:"GLORIA BIOGRAF",duration:"81 min",description:"En mand bygger en bunker af skrammel p√• en pl√∏jemark i Sk√•ne for at v√¶re klar, n√•r fjenden kommer. En moderne myte baseret p√• virkeligheden.",ticketUrl:"https://cphdox.dk/film/redoubt"},
    {title:"LA BELLE ANN√âE",time:"21:15",venue:"DAGMAR TEATRET",duration:"90 min",description:"Som teenager var hun forelsket i sin l√¶rerinde. Nu vender en fransk-svensk filmskaber tilbage i en smuk dagbogsfilm om beg√¶r og vampyrer.",ticketUrl:"https://cphdox.dk/film/la-belle-annee"},
    {title:"UNDERLAND",time:"21:15",venue:"EMPIRE BIO",duration:"79 min",description:"Tre undergrunds-astronauter g√•r p√• opdagelse i underverdenen. Baseret p√• Robert Macfarlanes bestseller med Sandra H√ºller som fort√¶ller.",ticketUrl:"https://cphdox.dk/film/underland"},
    {title:"WHISPERS IN THE WOODS",time:"21:15",venue:"DFI / CINEMATEKET",duration:"94 min",description:"Filmsensationen der har solgt over en million biografbilletter i Frankrig ‚Äî en enest√•ende smuk og sanselig naturoplevelse med musik af Warren Ellis.",ticketUrl:"https://cphdox.dk/film/whispers-in-the-woods"}
  ]
};


// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let dates=[];
let allFilms=[];        // flat list: {title, time, venue, duration, description, date, ticketUrl}
let selectedTitles=new Set(); // unique titles selected
let selectedShowings={}; // title ‚Üí {date, time, venue, duration, slotId}
let currentPlanData=null;
// pdfBase64 removed ‚Äî using hardcoded data
let prefs={pauses:'',count:'',start:''};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
async function sSet(k,v){if(window.storage){try{await window.storage.set(k,JSON.stringify(v));return;}catch{}}localStorage.setItem(k,JSON.stringify(v));}
async function sGet(k){if(window.storage){try{const r=await window.storage.get(k);return r?JSON.parse(r.value):null;}catch{return null;}}try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}}
async function sDel(k){if(window.storage){try{await window.storage.delete(k);}catch{}}else localStorage.removeItem(k);}
async function sList(p){if(window.storage){try{const r=await window.storage.list(p);return r?r.keys:[];}catch{return[];}}const ks=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith(p))ks.push(k);}return ks;}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',()=>{
  const ok=!!window.storage;
  document.getElementById('sdot').className='sdot'+(ok?' ok':'');
  document.getElementById('slabel').textContent=ok?'Cloud-lagring':'Lokal lagring';

});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeSaveModal();closeCafeModal();closeSwapModal();closeDayPicker();}
  if(e.key==='Enter'&&document.getElementById('save-modal').classList.contains('open'))confirmSave();
});

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+n).classList.add('active');
  document.querySelectorAll('.nav-tab')[n==='planner'?0:1].classList.add('active');
  if(n==='archive')renderArchive();
}

// PDF upload removed ‚Äî film data is hardcoded

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function toggleKey(){const i=document.getElementById('api-key'),b=document.getElementById('toggle-btn');i.type=i.type==='password'?'text':'password';b.textContent=i.type==='password'?'Vis':'Skjul';}
function getKey(){return document.getElementById('api-key').value.trim();}
function fmtDate(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'long',day:'numeric',month:'long'});}
function fmtShort(s){if(!s)return'';return new Date(s).toLocaleDateString('da-DK',{weekday:'short',day:'numeric',month:'short'});}


function pickChip(gid,el){
  document.querySelectorAll('#'+gid+' .pref-chip').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  if(gid==='pg-pauses')prefs.pauses=el.dataset.val;
  if(gid==='pg-count')prefs.count=el.dataset.val;
  if(gid==='pg-start')prefs.start=el.dataset.val;
}

function prefsText(){
  const p=[];
  if(prefs.pauses==='relaxed')p.push('Vil have pauser til mad og kaffe ‚Äî mindst 60 min buffer');
  if(prefs.pauses==='packed')p.push('Vil se s√• mange film som muligt ‚Äî minimal pause (30 min buffer)');
  if(prefs.count==='1-2')p.push('Max 1-2 film om dagen');
  if(prefs.count==='3-4')p.push('Gerne 3-4 film om dagen');
  if(prefs.count==='max')p.push('S√• mange film som muligt');
  if(prefs.start==='morning')p.push('Starter gerne fra kl. 10');
  if(prefs.start==='midday')p.push('Foretr√¶kker at starte fra kl. 12');
  if(prefs.start==='afternoon')p.push('Foretr√¶kker at starte fra kl. 15');
  return p.join('. ')||'Ingen s√¶rlige pr√¶ferencer';
}

// ‚îÄ‚îÄ CLAUDE API ‚îÄ‚îÄ
async function callAI(messages, maxTokens=3000){
  const body={model:'claude-sonnet-4-20250514',max_tokens:maxTokens,messages};
  const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':getKey(),'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body:JSON.stringify(body)});
  const d=await res.json();
  if(d.error)throw new Error(d.error.message);
  return(d.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
}

function parseJSON(t){
  let c=t.replace(/```json|```/g,'').trim();
  try{return JSON.parse(c);}catch{}
  const m=c.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
  if(m){try{return JSON.parse(m[0]);}catch{}}
  throw new Error('Kunne ikke l√¶se svaret fra Claude. Pr√∏v igen.');
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
function startPlanner(){
  if(!getKey()){alert('Indtast din API-n√∏gle.');return;}
  dates=['2026-03-20','2026-03-21','2026-03-22'];

  allFilms=[]; selectedTitles=new Set(); selectedShowings={};
  document.getElementById('screen-setup').style.display='none';
  document.getElementById('screen-select').style.display='block';
  document.getElementById('loading-fetch').style.display='none';
  document.getElementById('film-list-container').style.display='none';
  document.getElementById('error-fetch').style.display='none';
  document.getElementById('output').style.display='none';
  document.getElementById('error-plan').style.display='none';
  fetchFilms();  // synchronous ‚Äî hardcoded data
}

function fetchFilms(){
  // Film data is hardcoded ‚Äî no API call needed here
  dates.forEach(d=>{
    const films=FILM_DATA[d]||[];
    films.forEach(f=>allFilms.push({...f,date:d}));
  });

  if(!allFilms.length){
    const eb=document.getElementById('error-fetch');
    document.getElementById('loading-fetch').style.display='none';
    eb.style.display='block';
    eb.textContent='‚ö† Ingen film fundet for de valgte dage. V√¶lg 20., 21. eller 22. marts 2026.';
    return;
  }

  document.getElementById('loading-fetch').style.display='none';
  renderFilmList();
}

// ‚îÄ‚îÄ FILM LIST ‚Äî OVERLAP-BASED TIME GRID ‚îÄ‚îÄ
function timeToMin(t){if(!t)return 0;const[h,m]=(t||'').split(':');return parseInt(h||0)*60+parseInt(m||0);}

function renderFilmList(){
  // Build lookup: title ‚Üí {film, dayShowings{date:[showings]}}
  const byTitle={};
  allFilms.forEach(f=>{
    if(!byTitle[f.title])byTitle[f.title]={...f,dayShowings:{}};
    const ds=byTitle[f.title].dayShowings;
    if(!ds[f.date])ds[f.date]=[];
    // avoid duplicate time entries
    if(!ds[f.date].find(x=>x.time===f.time))
      ds[f.date].push({time:f.time,venue:f.venue,duration:f.duration});
  });

  // ‚îÄ‚îÄ Build overlap-based slots ‚îÄ‚îÄ
  // Collect every (date, time, duration) combo as an event
  // Two events overlap if their time windows intersect (with 15min buffer)
  // Group overlapping events into slots; a slot spans max(end times) of all events in it
  // We do this per-day first, then merge across days by time proximity

  // Step 1: collect all unique start times across all days
  const allTimes=new Set();
  Object.values(byTitle).forEach(f=>{
    Object.values(f.dayShowings).forEach(showings=>{
      showings.forEach(s=>{ if(s.time)allTimes.add(s.time); });
    });
  });

  // Step 2: build overlap groups ‚Äî sort times, merge if within 45 min of group start
  const sortedTimes=[...allTimes].sort((a,b)=>timeToMin(a)-timeToMin(b));
  const slotGroups=[]; // [{startMin, endMin, label, times:Set}]

  sortedTimes.forEach(t=>{
    const m=timeToMin(t);
    // Find existing group where this time is within 45 min of group start
    const grp=slotGroups.find(g=>m-g.startMin<=45 && m>=g.startMin);
    if(grp){
      grp.times.add(t);
      // extend end if needed
      if(m>grp.endMin)grp.endMin=m;
    } else {
      slotGroups.push({startMin:m,endMin:m,label:t,times:new Set([t])});
    }
  });

  // Step 3: label each slot by earliest time
  slotGroups.forEach(g=>{
    const sorted=[...g.times].sort((a,b)=>timeToMin(a)-timeToMin(b));
    g.label=sorted[0];
  });

  // Step 4: for each slot, collect films per day whose showing time is in that slot
  const grid=slotGroups.map(g=>({
    label:g.label,
    startMin:g.startMin,
    days: Object.fromEntries(dates.map(d=>[d,[]]))
  }));

  Object.values(byTitle).forEach(f=>{
    dates.forEach(d=>{
      (f.dayShowings[d]||[]).forEach(s=>{
        const m=timeToMin(s.time);
        const slot=grid.find(g=>m>=g.startMin && m<=g.startMin+45);
        if(slot && !slot.days[d].find(x=>x.title===f.title)){
          slot.days[d].push({...f,_showing:s});
        }
      });
    });
  });

  // Step 5: assign slot IDs so toggling can dim siblings
  grid.forEach((slot,si)=>{
    dates.forEach(d=>{
      slot.days[d].forEach(f=>{f._slotId=si;});
    });
  });

  const totalUnique=Object.keys(byTitle).length;
  document.getElementById('film-list-meta').textContent=
    `${totalUnique} unikke film ¬∑ V√¶lg √©n pr. tidspunkt ‚Äî de andre d√¶mpes automatisk`;

  const listEl=document.getElementById('film-list');
  listEl.innerHTML='';

  const cols=dates.length;
  const gridFr=`52px ${Array(cols).fill('1fr').join(' ')}`;

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  const hdr=document.createElement('div');
  hdr.style.cssText=`display:grid;grid-template-columns:${gridFr};gap:10px;margin-bottom:8px;position:sticky;top:56px;z-index:10;background:var(--bg);padding:8px 0 4px;`;
  hdr.innerHTML='<div></div>'+dates.map(d=>`
    <div style="background:var(--surface2);border:1px solid var(--border);padding:10px 14px;
      font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);text-align:center;">
      ${fmtDate(d)}
    </div>`).join('');
  listEl.appendChild(hdr);

  // ‚îÄ‚îÄ Time rows ‚îÄ‚îÄ
  let lastSlotHour=-1;
  grid.forEach((slot,si)=>{
    const hasAny=dates.some(d=>slot.days[d].length>0);
    if(!hasAny)return;

    const slotHour=Math.floor(slot.startMin/60);

    // Hour-break divider
    if(lastSlotHour>=0 && slotHour-lastSlotHour>=2){
      const div=document.createElement('div');
      div.style.cssText=`display:grid;grid-template-columns:${gridFr};gap:10px;margin:6px 0;`;
      div.innerHTML=`<div></div><div style="grid-column:2/-1;height:1px;background:rgba(232,240,72,0.15);"></div>`;
      listEl.appendChild(div);
    }
    lastSlotHour=slotHour;

    const row=document.createElement('div');
    row.className='time-row-el';
    row.dataset.slotId=si;
    row.style.cssText=`display:grid;grid-template-columns:${gridFr};gap:10px;margin-bottom:6px;align-items:start;`;

    // Time label
    const tl=document.createElement('div');
    tl.style.cssText='padding-top:10px;text-align:right;padding-right:8px;font-family:"DM Serif Display",serif;font-style:italic;font-size:0.9rem;color:var(--muted);line-height:1.2;';
    tl.textContent=slot.label;
    row.appendChild(tl);

    // Day columns
    dates.forEach(d=>{
      const cell=document.createElement('div');
      const films=slot.days[d];
      if(!films.length){
        // empty placeholder keeps grid aligned
        const ph=document.createElement('div');
        ph.style.cssText='min-height:4px;border-left:1px solid rgba(255,255,255,0.03);';
        cell.appendChild(ph);
      } else {
        films.forEach(f=>{
          const card=document.createElement('div');
          card.className='film-card';
          card.dataset.title=f.title;
          card.dataset.slotId=si;
          card.dataset.date=d;

          const otherDays=dates.filter(dd=>dd!==d&&f.dayShowings[dd]);
          const multiText=otherDays.map(dd=>{
            const s=f.dayShowings[dd]?.[0];
            return s?`${fmtShort(dd)} ${s.time}`:'';
          }).filter(Boolean).join(' ¬∑ ');

          card.innerHTML=`
            <div class="fc-check">‚óã</div>
            <div class="fc-time">${f._showing.time}</div>
            <div class="fc-title">${f.title}</div>
            <div class="fc-venue">üìç ${f._showing.venue||''}</div>
            <div class="fc-dur">${f._showing.duration||''}</div>
            ${f.description?`<div class="fc-desc">${f.description}</div>`:''}
            ${multiText?`<div class="fc-multi">‚Üî Ogs√•: ${multiText}</div>`:''}`;

          if(selectedTitles.has(f.title)){
            card.classList.add('selected');
            card.querySelector('.fc-check').textContent='‚úì';
          }

          card.addEventListener('click',()=>toggleFilmCard(f.title,card,si));
          cell.appendChild(card);
        });
      }
      row.appendChild(cell);
    });

    listEl.appendChild(row);
  });

  document.getElementById('film-list-container').style.display='block';
  refreshSlotDimming();
  updateSelBar();
}

// Dim unselected cards in slots where something is already selected
function refreshSlotDimming(){
  // Find which slot IDs have a selected film
  const selectedSlots=new Set();
  document.querySelectorAll('.film-card.selected').forEach(card=>{
    if(card.dataset.slotId!==undefined) selectedSlots.add(card.dataset.slotId);
  });
  // Dim non-selected cards in those slots
  document.querySelectorAll('.film-card').forEach(card=>{
    const sid=card.dataset.slotId;
    if(sid!==undefined && selectedSlots.has(sid) && !card.classList.contains('selected')){
      card.classList.add('dimmed');
    } else {
      card.classList.remove('dimmed');
    }
  });
}

function toggleFilm(title,row){
  if(selectedTitles.has(title)){
    selectedTitles.delete(title);
    row.classList.remove('selected');
    row.querySelector('.film-check').textContent='‚óã';
  }else{
    selectedTitles.add(title);
    row.classList.add('selected');
    row.querySelector('.film-check').textContent='‚úì';
  }
  updateSelBar();
}

// Find byTitle entry for a film card by title
function getFilmByTitle(title){
  // Scan allFilms to rebuild dayShowings for this title
  const showings={};
  allFilms.filter(f=>f.title===title).forEach(f=>{
    if(!showings[f.date])showings[f.date]=[];
    if(!showings[f.date].find(s=>s.time===f.time))
      showings[f.date].push({time:f.time,venue:f.venue,duration:f.duration});
  });
  return showings; // date ‚Üí [{time,venue,duration}]
}

function toggleFilmCard(title,card,slotId){
  if(selectedTitles.has(title)){
    // Deselect
    selectedTitles.delete(title);
    delete selectedShowings[title];
    document.querySelectorAll('.film-card').forEach(c=>{
      if(c.dataset.title===title){
        c.classList.remove('selected');
        c.querySelector('.fc-check').textContent='‚óã';
        const cd=c.querySelector('.fc-chosen-day');
        if(cd)cd.remove();
      }
    });
    refreshSlotDimming();
    updateSelBar();
    return;
  }

  // Selecting ‚Äî check how many days this film is shown on
  const dayShowings=getFilmByTitle(title);
  const availableDays=Object.keys(dayShowings).filter(d=>dates.includes(d));

  if(availableDays.length<=1){
    // Only one day ‚Äî select directly
    const d=availableDays[0]||card.dataset.date;
    const s=(dayShowings[d]||[])[0]||{time:card.querySelector('.fc-time')?.textContent,venue:'',duration:''};
    selectFilmOnDay(title,d,s,slotId);
  } else {
    // Multiple days ‚Äî show picker
    openDayPicker(title,dayShowings,slotId);
  }
}

function selectFilmOnDay(title,date,showing,slotId){
  selectedTitles.add(title);
  selectedShowings[title]={date,time:showing.time,venue:showing.venue,duration:showing.duration,slotId};

  // Update all cards for this title
  document.querySelectorAll('.film-card').forEach(c=>{
    if(c.dataset.title===title){
      c.classList.add('selected');
      c.querySelector('.fc-check').textContent='‚úì';
      // Show chosen day label
      let cd=c.querySelector('.fc-chosen-day');
      if(!cd){cd=document.createElement('div');cd.className='fc-chosen-day';c.appendChild(cd);}
      cd.textContent='‚úì '+fmtShort(date)+' '+showing.time;
    }
  });
  refreshSlotDimming();
  updateSelBar();
}

// ‚îÄ‚îÄ DAY PICKER ‚îÄ‚îÄ
let _dpFilm=null;
function openDayPicker(title,dayShowings,slotId){
  _dpFilm={title,slotId};
  document.getElementById('dp-title').textContent=title;
  const body=document.getElementById('dp-body');

  // Check which slots are already taken (another selected film in same slot on that day)
  // We detect "taken" if another selected film's slotId matches on that date
  // Simplified: check if any selected film occupies same time slot on that day
  body.innerHTML=dates.filter(d=>dayShowings[d]).map(d=>{
    const showings=dayShowings[d];
    return showings.map(s=>{
      // Is this slot taken? Check if selectedShowings has something at same slotId on same day
      const slotTaken=Object.values(selectedShowings).some(sel=>
        sel.date===d && sel.slotId===slotId
      );
      const takenClass=slotTaken?' dp-taken':'';
      return `<div class="dp-option${takenClass}" onclick="pickDay('${d}',${JSON.stringify(s).replace(/"/g,'&quot;')},${slotId})">
        <div class="dp-day">${fmtShort(d)}</div>
        <div class="dp-meta">
          <div class="dp-time">${s.time}</div>
          <div class="dp-venue">üìç ${s.venue||''} ¬∑ ${s.duration||''}</div>
        </div>
      </div>`;
    }).join('');
  }).join('');

  document.getElementById('day-picker-modal').classList.add('open');
}

function pickDay(date,showing,slotId){
  if(!_dpFilm)return;
  closeDayPicker();
  selectFilmOnDay(_dpFilm.title,date,showing,slotId);
}

function closeDayPicker(){
  document.getElementById('day-picker-modal').classList.remove('open');
  _dpFilm=null;
}

function selectAll(){
  document.querySelectorAll('.film-row,.film-card').forEach(el=>{
    const title=el.dataset.title;
    if(title){
      selectedTitles.add(title);
      el.classList.add('selected');
      const chk=el.querySelector('.film-check,.fc-check');
      if(chk)chk.textContent='‚úì';
    }
  });
  refreshSlotDimming();
  updateSelBar();
}
function selectNone(){
  selectedTitles.clear();
  document.querySelectorAll('.film-row,.film-card').forEach(el=>{
    el.classList.remove('selected');
    const chk=el.querySelector('.film-check,.fc-check');
    if(chk)chk.textContent='‚óã';
  });
  refreshSlotDimming();
  updateSelBar();
}

function updateSelBar(){
  const n=selectedTitles.size;
  document.getElementById('sel-count').innerHTML=n===0?'Ingen film valgt':`<strong>${n}</strong> film valgt`;
  document.getElementById('plan-btn').disabled=n===0;
}

function goBackSetup(){
  document.getElementById('screen-select').style.display='none';
  document.getElementById('screen-setup').style.display='block';
}
function restartPlanner(){
  document.getElementById('output').style.display='none';
  document.getElementById('screen-setup').style.display='block';
  currentPlanData=null;
}

// ‚îÄ‚îÄ GENERATE PLAN ‚îÄ‚îÄ
async function generatePlan(){
  if(!selectedTitles.size){alert('V√¶lg mindst √©n film.');return;}

  // Collect all showings for selected titles
  const selectedFilms=allFilms.filter(f=>selectedTitles.has(f.title));

  // Group by title with all showings
  const byTitle={};
  selectedFilms.forEach(f=>{
    if(!byTitle[f.title])byTitle[f.title]={title:f.title,description:f.description,ticketUrl:f.ticketUrl,showings:[]};
    byTitle[f.title].showings.push({date:f.date,dateLabel:fmtDate(f.date),time:f.time,venue:f.venue,duration:f.duration});
  });
  // Mark preferred showing from user's day selection
  Object.keys(selectedShowings).forEach(title=>{
    if(byTitle[title]){
      const pref=selectedShowings[title];
      byTitle[title].preferredDate=pref.date;
      byTitle[title].preferredTime=pref.time;
    }
  });

  document.getElementById('screen-select').style.display='none';
  document.getElementById('loading-plan').style.display='block';
  document.getElementById('error-plan').style.display='none';
  document.getElementById('output').style.display='none';

  const msgs=['Analyserer dine valg...','Finder optimal fordeling...','Beregner gangtider...','Identificerer film der ikke passer...','N√¶sten klar...'];
  let mi=0;
  const lt=setInterval(()=>{document.getElementById('loading-plan-text').textContent=msgs[++mi%msgs.length];},2500);

  // Compact scheduling data only ‚Äî no descriptions to save tokens
  const filmList=Object.values(byTitle).map(f=>{
    const pref=f.preferredDate?` [FORETRUKKET: ${f.preferredDate} ${f.preferredTime||''}]`:'';
    return `${f.title}|${f.showings.map(s=>`${s.date} ${s.time} ${s.venue} ${s.duration||''}`).join(' / ')}${pref}`;
  }).join('\n');

  // Keep descriptions in a lookup so we can re-attach them after plan is returned
  const descLookup={};
  Object.values(byTitle).forEach(f=>{descLookup[f.title]={description:f.description,ticketUrl:f.ticketUrl};});

  try{
    const raw=await callAI([{
      role:'user',
      content:`Lav en optimal CPH:DOX festivalplan. Svar KUN med JSON.

REGLER:
- Hver film KUN √©n gang i planen
- V√¶lg bedste visningstidspunkt baseret p√• pr√¶ferencer og logistik
- Film der ikke passer ind ‚Üí "missed_films"
- Gangtider i K√∏benhavn: 10-20 min mellem biografer

Festivaldage: ${dates.map(d=>fmtDate(d)+' ('+d+')').join(', ')}
Pr√¶ferencer: ${prefsText()}

Film (titel|dato tid sted varighed):
${filmList}

JSON:
{"days":[{"date":"2026-03-14","date_label":"L√∏rdag 14. marts","screenings":[{"time":"13:00","title":"...","venue":"...","duration":"90 min","distance_to_next":1.2,"walk_minutes_to_next":15}]}],"missed_films":[{"title":"...","reason":"...","all_showings":[{"date_label":"...","time":"14:00","venue":"..."}]}],"notes":"..."}`
    }], 4000);

    const plan=parseJSON(raw);
    // Re-attach descriptions and ticketUrls from our local lookup
    (plan.days||[]).forEach(day=>{
      (day.screenings||[]).forEach(s=>{
        const meta=descLookup[s.title];
        if(meta){
          if(!s.description)s.description=meta.description||'';
          if(!s.ticketUrl)s.ticketUrl=meta.ticketUrl||`https://cphdox.dk/film/${(s.title||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')}`;
        }
      });
    });
    clearInterval(lt);
    currentPlanData=plan;
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('output').style.display='block';
    renderPlan(plan, document.getElementById('plan-cards'), document.getElementById('missed-section'), document.getElementById('summary-section'));
  }catch(err){
    clearInterval(lt);
    document.getElementById('loading-plan').style.display='none';
    document.getElementById('screen-select').style.display='block';
    document.getElementById('error-plan').style.display='block';
    const errMsg=err.message+(err.stack?'\n\n'+err.stack:'');
    document.getElementById('error-plan').innerHTML=
      '<strong>‚ö† Fejl:</strong> '+err.message+
      '<div class="error-log" id="err-log-plan">'+errMsg+'</div>'+
      '<button class="copy-log-btn" onclick="copyLog(\'err-log-plan\')">üìã Kopi√©r fejllog</button>';
  }
}

// ‚îÄ‚îÄ RENDER PLAN ‚îÄ‚îÄ
function renderPlan(data, planContainer, missedContainer, summaryContainer){
  planContainer.innerHTML='';
  if(!data.days?.length){planContainer.innerHTML='<p style="color:var(--muted);">Ingen plan.</p>';return;}

  data.days.forEach(day=>{
    const card=document.createElement('div');
    card.className='day-card';
    const hdr=document.createElement('div');
    hdr.className='day-card-header';
    hdr.innerHTML=`<span class="day-card-title">${day.date_label||day.date}</span><span class="day-card-date">${day.date}</span>`;
    card.appendChild(hdr);

    (day.screenings||[]).forEach((s,i)=>{
      const sc=document.createElement('div');
      sc.className='screening';
      const tickUrl=s.ticketUrl||`https://cphdox.dk/film/${(s.title||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')}`;
      const venueEsc=(s.venue||'').replace(/'/g,"\\'");
      sc.innerHTML=`
        <div class="sc-time">${s.time}</div>
        <div class="sc-title">${s.title}</div>
        <div class="sc-venue">üìç ${s.venue||''}</div>
        ${s.duration?`<div class="sc-dur">${s.duration}</div>`:''}
        ${s.description?`<div class="sc-desc">${s.description}</div>`:''}
        <div class="sc-btns">
          <a href="${tickUrl}" target="_blank" class="btn-ticket">üéü K√∏b billet</a>
          <button class="btn-cafe" onclick="openCafeModal('${venueEsc}')">‚òï Cafeer</button>
          <button class="btn-replace" onclick="openSwapModal(${JSON.stringify(s)}, '${day.date}', ${i})">‚áÑ Erstat</button>
        </div>`;
      card.appendChild(sc);

      const next=day.screenings[i+1];
      if(next){
        const t=document.createElement('div');t.className='travel-badge';
        if((s.venue||'')!==(next.venue||'')){
          const fr=encodeURIComponent((s.venue||'')+', Copenhagen');
          const to=encodeURIComponent((next.venue||'')+', Copenhagen');
          t.innerHTML=`<div class="travel-info">üö∂ ${s.distance_to_next||'?'} km ¬∑ ca. ${s.walk_minutes_to_next||'?'} min ‚Üí ${next.venue}</div>
            <a href="https://www.google.com/maps/dir/?api=1&origin=${fr}&destination=${to}&travelmode=walking" target="_blank" class="btn-maps">Maps ‚Üí</a>`;
        }else{
          t.innerHTML=`<div class="travel-info">üìç Bliv i ${s.venue||''}</div>`;
        }
        card.appendChild(t);
      }
    });
    planContainer.appendChild(card);
  });

  if(data.notes){
    const nb=document.createElement('div');nb.className='note-box';nb.style.marginTop='20px';
    nb.innerHTML=`<strong>Planens logik:</strong> ${data.notes}`;
    planContainer.appendChild(nb);
  }

  // Missed films
  missedContainer.innerHTML='';
  if(data.missed_films?.length){
    const sec=document.createElement('div');
    sec.className='missed-section';
    sec.innerHTML=`
      <div class="missed-header">
        <div>
          <h3>üé¨ Film der ikke kunne passes ind</h3>
          <p style="margin-top:4px;">${data.missed_films.length} film kunne ikke placeres i planen</p>
        </div>
      </div>`;
    data.missed_films.forEach(f=>{
      const mf=document.createElement('div');
      mf.className='missed-film';
      const showings=(f.all_showings||[]).map(s=>
        `<span class="missed-showing-time">${s.date_label} ${s.time}</span> ¬∑ ${s.venue||''}`
      ).join('<br>');
      mf.innerHTML=`
        <div class="missed-title">${f.title}</div>
        <div class="missed-showings" style="margin-top:4px;color:var(--muted);font-size:0.7rem;">${f.reason||''}</div>
        ${showings?`<div class="missed-showings" style="margin-top:6px;">Vises:<br>${showings}</div>`:''}`;
      sec.appendChild(mf);
    });
    missedContainer.appendChild(sec);
  }

  // ‚îÄ‚îÄ SUMMARY SECTION ‚îÄ‚îÄ
  if(summaryContainer){
    summaryContainer.innerHTML='';
    const inPlan=[];
    (data.days||[]).forEach(day=>{
      (day.screenings||[]).forEach(s=>{
        inPlan.push({title:s.title,when:`${day.date_label||day.date} ${s.time} @ ${s.venue||''}`});
      });
    });
    const missed=data.missed_films||[];
    if(!inPlan.length&&!missed.length)return;

    const sec=document.createElement('div');
    sec.className='summary-section';
    sec.innerHTML=`<div class="summary-header"><h3>üìã Alle valgte film</h3></div>
      <div class="summary-grid">
        <div class="summary-col">
          <div class="summary-col-label">‚úì I planen (${inPlan.length})</div>
          ${inPlan.map(f=>`<div class="summary-film"><span class="summary-film-title">${f.title}</span><span class="summary-film-when">${f.when}</span></div>`).join('')}
        </div>
        <div class="summary-col">
          <div class="summary-col-label">‚úï Ikke i planen (${missed.length})</div>
          ${missed.length?missed.map(f=>`<div class="summary-film"><span class="summary-film-title">${f.title}</span><span class="summary-film-when">${(f.all_showings||[]).map(s=>s.time+' '+s.venue).join(', ')}</span></div>`).join(''):'<div style="font-size:0.75rem;color:var(--green);padding:8px 0;">Alle film er med! üéâ</div>'}
        </div>
      </div>`;
    summaryContainer.appendChild(sec);
  }
}

// ‚îÄ‚îÄ SWAP MODAL ‚îÄ‚îÄ
let _swapTarget=null; // {screening, date, idx}

function timeToMin(t){if(!t)return 0;const[h,m]=(t||'').split(':');return parseInt(h||0)*60+parseInt(m||0);}

function openSwapModal(screening, date, idx){
  _swapTarget={screening,date,idx};
  document.getElementById('swap-modal-sub').textContent=`Erstatter: ${screening.title} (${screening.time} @ ${screening.venue||'?'})`;
  const missed=currentPlanData?.missed_films||[];
  const body=document.getElementById('swap-body');

  // Find the day object to know what other screenings are already there
  const dayObj=currentPlanData.days.find(d=>d.date===date);
  const otherScreenings=(dayObj?.screenings||[]).filter((_,i2)=>i2!==idx);

  // For each missed film, find showings on the target day within ¬±3 hours of the replaced slot
  const targetMin=timeToMin(screening.time);
  const filmDurMin=parseInt((screening.duration||'90 min').match(/\d+/)?.[0]||90);

  // Build candidates: missed films that have a showing on the same date, roughly same time window
  const candidates=[];
  missed.forEach((f,fi)=>{
    const showingsOnDay=(f.all_showings||[]).filter(s=>{
      // Match by date: all_showings store date_label, but we need to match the date string
      // We'll match by checking if the showing time exists and is within window
      return s.time && s.date_label;
    });

    // Try to find showings on the target date
    // all_showings may have date_label like "Fredag 20. marts" ‚Äî match by day number
    const dayNum=parseInt(date.slice(8,10)); // e.g. 20 from 2026-03-20
    const showingsThisDay=showingsOnDay.filter(s=>{
      // Check if date_label contains the day number
      const labelNums=s.date_label.match(/\d+/g)||[];
      return labelNums.includes(String(dayNum));
    });

    if(!showingsThisDay.length)return; // no showing this day ‚Üí skip

    showingsThisDay.forEach(showing=>{
      const showMin=timeToMin(showing.time);
      const timeDiff=Math.abs(showMin-targetMin);

      // Check it doesn't overlap with other screenings already in the day
      const showDur=parseInt((showing.duration||f.duration||'90 min').match(/\d+/)?.[0]||90);
      const showEnd=showMin+showDur;
      const conflicts=otherScreenings.some(s2=>{
        const s2Min=timeToMin(s2.time);
        const s2Dur=parseInt((s2.duration||'90 min').match(/\d+/)?.[0]||90);
        const s2End=s2Min+s2Dur;
        return showMin<s2End+20 && showEnd>s2Min-20; // 20 min buffer
      });

      candidates.push({film:f,filmIdx:fi,showing,timeDiff,conflicts});
    });
  });

  // Sort: non-conflicting first, then by closeness to original time
  candidates.sort((a,b)=>{
    if(a.conflicts!==b.conflicts)return a.conflicts?1:-1;
    return a.timeDiff-b.timeDiff;
  });

  if(!candidates.length){
    // Fallback: show all missed films but grayed, with their showings
    const fallback=missed.map((f,fi)=>({film:f,filmIdx:fi,showing:(f.all_showings||[])[0]||{},timeDiff:999,conflicts:true}));
    body.innerHTML='<p style="color:var(--muted);font-size:0.73rem;margin-bottom:14px;">Ingen film p√• ventelisten vises p√• denne dag. Viser alle muligheder:</p>'+
      renderSwapCandidates(fallback);
  }else{
    const hasConflicts=candidates.some(c=>c.conflicts);
    body.innerHTML=(hasConflicts?'<p style="color:var(--muted);font-size:0.73rem;margin-bottom:12px;">‚ö† Film markeret med r√∏d kan overlappe med andre film i planen.</p>':'')+
      renderSwapCandidates(candidates);
  }
  document.getElementById('swap-modal').classList.add('open');
}

function renderSwapCandidates(candidates){
  return candidates.map((c,ci)=>{
    const conflictStyle=c.conflicts?'border-color:rgba(240,72,72,0.3);':'';
    const conflictBadge=c.conflicts?'<span style="font-size:0.6rem;color:var(--red);margin-left:6px;">‚ö† muligt overlap</span>':'';
    return `<div class="swap-film-item" style="${conflictStyle}" onclick="doSwap(${c.filmIdx},${ci})">
      <div class="swap-film-meta">
        <div class="swap-film-title">${c.film.title}${conflictBadge}</div>
        <div class="swap-film-times">${c.showing.time||'?'} ¬∑ ${c.showing.venue||''}</div>
        ${c.film.description?`<div style="font-size:0.68rem;color:var(--muted);margin-top:3px;">${c.film.description}</div>`:''}
      </div>
      <div class="swap-arrow">‚Üí</div>
    </div>`;
  }).join('');
}

function closeSwapModal(){document.getElementById('swap-modal').classList.remove('open');_swapTarget=null;}

function doSwap(missedIdx, candidateIdx){
  if(!_swapTarget||!currentPlanData)return;
  const missed=currentPlanData.missed_films||[];
  const incoming=missed[missedIdx];
  if(!incoming)return;

  const targetDate=_swapTarget.date;
  const dayObj=currentPlanData.days.find(d=>d.date===targetDate);
  if(!dayObj)return;

  // Find the specific showing that was presented in the modal
  const dayNum=parseInt(targetDate.slice(8,10));
  const showingsThisDay=(incoming.all_showings||[]).filter(s=>{
    const labelNums=(s.date_label||'').match(/\d+/g)||[];
    return labelNums.includes(String(dayNum));
  });
  const chosenShowing=showingsThisDay[0]||(incoming.all_showings||[])[0]||{};

  const replacement={
    time:chosenShowing.time||_swapTarget.screening.time,
    title:incoming.title,
    venue:chosenShowing.venue||'',
    duration:chosenShowing.duration||incoming.duration||'',
    description:incoming.description||'',
    ticketUrl:`https://cphdox.dk/film/${incoming.title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')}`,
    distance_to_next:null,
    walk_minutes_to_next:null
  };

  const evicted=dayObj.screenings[_swapTarget.idx];
  dayObj.screenings[_swapTarget.idx]=replacement;
  // Re-sort day screenings by time after swap
  dayObj.screenings.sort((a,b)=>timeToMin(a.time)-timeToMin(b.time));

  currentPlanData.missed_films.splice(missedIdx,1);
  currentPlanData.missed_films.push({
    title:evicted.title,
    reason:'Manuelt byttet ud',
    all_showings:[{date_label:dayObj.date_label,time:evicted.time,venue:evicted.venue}],
    description:evicted.description
  });

  closeSwapModal();
  renderPlan(currentPlanData,document.getElementById('plan-cards'),document.getElementById('missed-section'),document.getElementById('summary-section'));
  const btn=document.getElementById('save-btn');
  btn.textContent='üíæ Gem √¶ndringer';
  btn.style.cssText+='background:rgba(232,240,72,0.15);border-color:rgba(232,240,72,0.5);';
  setTimeout(()=>{btn.textContent='üíæ Gem plan';btn.style.cssText='';},4000);
}

// ‚îÄ‚îÄ CAFE MODAL ‚îÄ‚îÄ
function openCafeModal(venue){
  document.getElementById('cafe-modal-sub').textContent='T√¶t p√• '+venue;
  document.getElementById('cafe-body').innerHTML='<div style="text-align:center;padding:32px;font-size:0.75rem;color:var(--muted);">‚è≥ Finder cafeer...</div>';
  document.getElementById('cafe-modal').classList.add('open');
  callAI([{role:'user',content:`Find 5 cafeer eller restauranter t√¶t p√• ${venue} i K√∏benhavn. JSON kun:
[{"name":"...","type":"Caf√©","distance":"3 min gang","description":"1 linje","mapsUrl":"https://maps.google.com/?q=...+Copenhagen"}]`}])
  .then(raw=>{
    const cafes=parseJSON(raw);
    document.getElementById('cafe-body').innerHTML=cafes.map(c=>`
      <div class="cafe-card">
        <div class="cafe-name">${c.name}<span class="cafe-type">${c.type||''}</span></div>
        <div class="cafe-meta"><span style="color:var(--accent);">üìç ${c.distance||''}</span> ‚Äî ${c.description||''}
          ${c.mapsUrl?`<br><a href="${c.mapsUrl}" target="_blank" style="color:var(--accent2);font-size:0.67rem;text-decoration:none;">Google Maps ‚Üí</a>`:''}
        </div>
      </div>`).join('');
  }).catch(err=>{document.getElementById('cafe-body').innerHTML=`<p style="color:var(--red);font-size:0.78rem;">${err.message}</p>`;});
}
function closeCafeModal(){document.getElementById('cafe-modal').classList.remove('open');}

// ‚îÄ‚îÄ ICS EXPORT ‚îÄ‚îÄ
function downloadICS(){
  if(!currentPlanData?.days){alert('Ingen plan at eksportere.');return;}
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CPH:DOX Planner//DA','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
  currentPlanData.days.forEach(day=>{
    (day.screenings||[]).forEach((s,i)=>{
      const ds=day.date.replace(/-/g,'');
      const sh=parseInt(s.time?.split(':')?.[0]||12),sm=parseInt(s.time?.split(':')?.[1]||0);
      const dur=parseInt((s.duration||'90 min').match(/\d+/)?.[0]||90);
      const te=sh*60+sm+dur,eh=Math.floor(te/60),em=te%60;
      const dtS=`${ds}T${pad(sh)}${pad(sm)}00`,dtE=`${ds}T${pad(eh)}${pad(em)}00`;
      lines.push('BEGIN:VEVENT',`UID:cphdox26-${ds}-${i}@planner`,
        `DTSTART;TZID=Europe/Copenhagen:${dtS}`,`DTEND;TZID=Europe/Copenhagen:${dtE}`,
        `SUMMARY:üé¨ ${s.title}`,`LOCATION:${s.venue||''}`,
        `DESCRIPTION:${(s.description||'').replace(/\n/g,'\\n')}\\n\\nBillet: ${s.ticketUrl||'cphdox.dk'}`,
        'BEGIN:VALARM','TRIGGER:-PT30M','ACTION:DISPLAY',`DESCRIPTION:Om 30 min: ${s.title}`,'END:VALARM','END:VEVENT');
      const next=day.screenings[i+1];
      if(next&&(s.venue||'')!==(next.venue||'')&&s.walk_minutes_to_next){
        const tw=te+parseInt(s.walk_minutes_to_next);
        lines.push('BEGIN:VEVENT',`UID:travel-${ds}-${i}@planner`,
          `DTSTART;TZID=Europe/Copenhagen:${dtE}`,
          `DTEND;TZID=Europe/Copenhagen:${ds}T${pad(Math.floor(tw/60))}${pad(tw%60)}00`,
          `SUMMARY:üö∂ G√• til ${next.venue}`,`DESCRIPTION:Ca. ${s.walk_minutes_to_next} min fra ${s.venue} til ${next.venue}`,'END:VEVENT');
      }
    });
  });
  lines.push('END:VCALENDAR');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lines.join('\r\n')],{type:'text/calendar'}));
  a.download='cphdox-2026.ics';a.click();
}

function copyLog(elId){
  const el=document.getElementById(elId);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent).then(()=>{
    const btn=el.nextElementSibling;
    if(btn){btn.textContent='‚úì Kopieret!';setTimeout(()=>{btn.textContent='üìã Kopi√©r fejllog';},2000);}
  });
}

// ‚îÄ‚îÄ SAVE / ARCHIVE ‚îÄ‚îÄ
function openSaveModal(){if(!currentPlanData)return;document.getElementById('plan-name-input').value='';document.getElementById('save-modal').classList.add('open');setTimeout(()=>document.getElementById('plan-name-input').focus(),100);}
function closeSaveModal(){document.getElementById('save-modal').classList.remove('open');}
async function confirmSave(){
  const name=document.getElementById('plan-name-input').value.trim();
  if(!name){alert('Giv planen et navn.');return;}
  const id='plan:'+Date.now();
  await sSet(id,{id,name,savedAt:new Date().toISOString(),data:currentPlanData});
  closeSaveModal();
  const btn=document.getElementById('save-btn');
  btn.textContent='‚úì Gemt!';
  btn.style.cssText+='background:rgba(72,240,168,0.12);border-color:rgba(72,240,168,0.3);color:#48f0a8;';
  setTimeout(()=>{btn.textContent='üíæ Gem plan';btn.style.cssText='';},2200);
}

async function renderArchive(){
  document.getElementById('archive-list').style.display='block';
  document.getElementById('archive-view').style.display='none';
  const keys=await sList('plan:');
  const container=document.getElementById('archive-cards');
  if(!keys.length){container.innerHTML='<div class="archive-empty"><p>Ingen gemte planer endnu.</p></div>';return;}
  const plans=(await Promise.all(keys.map(k=>sGet(k)))).filter(Boolean);
  plans.sort((a,b)=>new Date(b.savedAt)-new Date(a.savedAt));
  container.innerHTML='';
  plans.forEach(plan=>{
    const card=document.createElement('div');card.className='archive-card';
    const days=plan.data.days||[];
    const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
    const missed=(plan.data.missed_films||[]).length;
    const saved=new Date(plan.savedAt).toLocaleDateString('da-DK',{day:'numeric',month:'long',year:'numeric'});
    const pills=days.map(d=>`<span class="day-pill">${(d.date_label||d.date).split(' ').slice(0,2).join(' ')}</span>`).join('');
    card.innerHTML=`<button class="arc-del" onclick="delPlan(event,'${plan.id}')">Slet</button>
      <div class="arc-name">${plan.name}</div>
      <div class="arc-meta">Gemt ${saved} ¬∑ ${films.length} film i planen${missed?' ¬∑ '+missed+' ikke passet ind':''}</div>
      <div class="arc-days">${pills}</div>`;
    card.addEventListener('click',e=>{if(e.target.classList.contains('arc-del'))return;openAV(plan);});
    container.appendChild(card);
  });
}

function openAV(plan){
  document.getElementById('archive-list').style.display='none';
  document.getElementById('archive-view').style.display='block';
  const days=plan.data.days||[];
  const films=days.flatMap(d=>(d.screenings||[]).map(s=>s.title));
  document.getElementById('av-title').textContent=plan.name;
  document.getElementById('av-sub').textContent=`// ${films.length} film i planen`;
  currentPlanData=plan.data;
  renderPlan(plan.data,document.getElementById('av-cards'),document.getElementById('av-missed'),document.getElementById('av-summary'));
}
function closeArchiveView(){document.getElementById('archive-list').style.display='block';document.getElementById('archive-view').style.display='none';}
async function delPlan(e,id){e.stopPropagation();if(!confirm('Slet denne plan?'))return;await sDel(id);renderArchive();}
</script>
</body>
</html>
