<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPH:DOX Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: rgba(255,255,255,0.08);
    --accent: #e8f048;
    --accent2: #48c8f0;
    --text: #f0ede8;
    --muted: #7a7a8a;
    --red: #f04848;
    --green: #48f0a8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg); color: var(--text);
    font-family: 'DM Mono', monospace; min-height: 100vh;
  }

  body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 0%, rgba(232,240,72,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(72,200,240,0.05) 0%, transparent 60%);
  }

  /* â”€â”€ NAV â”€â”€ */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.94); backdrop-filter: blur(14px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 24px; height: 56px;
  }
  .nav-brand { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--text); margin-right:32px; white-space:nowrap; }
  .nav-brand span { color: var(--accent); }
  .nav-tabs { display:flex; gap:4px; flex:1; }
  .nav-tab {
    padding: 8px 18px; font-family:'DM Mono',monospace; font-size:0.72rem;
    letter-spacing:0.12em; text-transform:uppercase; cursor:pointer;
    border: 1px solid transparent; background:none; color:var(--muted); transition:all 0.18s;
  }
  .nav-tab:hover { color: var(--text); }
  .nav-tab.active { color:var(--accent); border-color:rgba(232,240,72,0.25); background:rgba(232,240,72,0.06); }
  .storage-status { font-size:0.65rem; color:var(--muted); letter-spacing:0.08em; display:flex; align-items:center; gap:6px; margin-left:auto; }
  .storage-dot { width:6px; height:6px; border-radius:50%; background:var(--muted); flex-shrink:0; }
  .storage-dot.ok { background: var(--accent); }

  /* â”€â”€ PAGES â”€â”€ */
  .page { display:none; }
  .page.active { display:block; }
  .container { max-width:900px; margin:0 auto; padding:40px 20px 100px; position:relative; z-index:1; }

  .page-title { font-family:'DM Serif Display',serif; font-size:clamp(1.8rem,4vw,2.8rem); margin-bottom:6px; line-height:1.1; }
  .page-sub { font-size:0.75rem; color:var(--muted); letter-spacing:0.05em; margin-bottom:40px; }

  .section-label {
    font-size:0.62rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--accent);
    margin-bottom:14px; display:flex; align-items:center; gap:12px;
  }
  .section-label::after { content:''; flex:1; height:1px; background:var(--border); }
  .section { margin-bottom:36px; }

  /* â”€â”€ FORM â”€â”€ */
  label { display:block; font-size:0.68rem; letter-spacing:0.1em; color:var(--muted); text-transform:uppercase; margin-bottom:7px; margin-top:18px; }
  label:first-child { margin-top:0; }

  input[type="text"], input[type="date"], input[type="password"], textarea, select {
    width:100%; background:var(--surface); border:1px solid var(--border);
    color:var(--text); font-family:'DM Mono',monospace; font-size:0.85rem;
    padding:11px 14px; outline:none; transition:border-color 0.2s, background 0.2s;
    appearance: none;
  }
  input:focus, textarea:focus, select:focus { border-color:rgba(232,240,72,0.35); background:var(--surface2); }
  textarea { resize:vertical; min-height:70px; line-height:1.6; }

  .dates-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  @media(max-width:580px) { .dates-row { grid-template-columns:1fr; } }
  .date-wrap { position:relative; }
  .date-num { position:absolute; top:10px; left:10px; font-size:0.58rem; color:var(--accent); letter-spacing:0.1em; pointer-events:none; }
  .date-wrap input { padding-left:34px; }

  .pref-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media(max-width:580px) { .pref-row { grid-template-columns:1fr; } }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn { display:inline-flex; align-items:center; gap:8px; padding:11px 22px; font-family:'DM Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; cursor:pointer; border:none; transition:all 0.18s; text-decoration:none; }
  .btn-ghost { background:var(--surface2); border:1px solid var(--border); color:var(--muted); margin-top:10px; }
  .btn-ghost:hover { border-color:rgba(255,255,255,0.18); color:var(--text); }
  .btn-primary { background:var(--accent); color:#0a0a0f; font-weight:600; margin-top:28px; width:100%; justify-content:center; font-size:0.84rem; }
  .btn-primary:hover { background:#f0fa60; transform:translateY(-1px); }
  .btn-primary:disabled { background:var(--surface2); color:var(--muted); cursor:not-allowed; transform:none; }
  .btn-outline { padding:9px 18px; background:none; border:1px solid var(--border); color:var(--muted); font-family:'DM Mono',monospace; font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; }
  .btn-outline:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }
  .btn-outline-accent { padding:9px 18px; background:rgba(232,240,72,0.07); border:1px solid rgba(232,240,72,0.25); color:var(--accent); font-family:'DM Mono',monospace; font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; }
  .btn-outline-accent:hover { background:rgba(232,240,72,0.14); }

  /* â”€â”€ STEP INDICATORS â”€â”€ */
  .steps { display:flex; gap:0; margin-bottom:40px; }
  .step {
    flex:1; padding:12px 16px; border:1px solid var(--border);
    border-right:none; font-size:0.65rem; letter-spacing:0.12em;
    text-transform:uppercase; color:var(--muted); position:relative;
    background: var(--surface);
  }
  .step:last-child { border-right:1px solid var(--border); }
  .step.active { color:var(--accent); border-color:rgba(232,240,72,0.3); background:rgba(232,240,72,0.05); }
  .step.done { color:var(--green); }
  .step-num { font-size:0.8rem; display:block; margin-bottom:2px; }

  /* â”€â”€ FILM PICKER â”€â”€ */
  #film-picker { display:none; }

  .fetch-row { display:flex; gap:10px; align-items:flex-end; }
  .fetch-row .date-wrap { flex:1; }
  .btn-fetch {
    padding:11px 20px; background:var(--accent); color:#0a0a0f; font-family:'DM Mono',monospace;
    font-size:0.75rem; letter-spacing:0.08em; text-transform:uppercase; cursor:pointer;
    border:none; font-weight:600; transition:all 0.18s; white-space:nowrap; flex-shrink:0;
  }
  .btn-fetch:hover { background:#f0fa60; }
  .btn-fetch:disabled { background:var(--surface2); color:var(--muted); cursor:not-allowed; }

  /* day tabs */
  .day-tabs { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px; }
  .day-tab-btn {
    padding:7px 16px; font-family:'DM Mono',monospace; font-size:0.7rem; letter-spacing:0.1em;
    text-transform:uppercase; cursor:pointer; border:1px solid var(--border);
    background:var(--surface); color:var(--muted); transition:all 0.18s;
  }
  .day-tab-btn:hover { color:var(--text); }
  .day-tab-btn.active { color:var(--accent); border-color:rgba(232,240,72,0.3); background:rgba(232,240,72,0.06); }
  .day-tab-btn .check { color:var(--green); margin-left:4px; display:none; }
  .day-tab-btn.has-selection .check { display:inline; }

  /* film cards in picker */
  .film-grid { display:grid; gap:12px; }

  .film-pick-card {
    background:var(--surface); border:1px solid var(--border);
    padding:18px 20px; cursor:pointer; transition:all 0.18s;
    display:grid; grid-template-columns:auto 1fr; gap:14px; align-items:start;
  }
  .film-pick-card:hover { border-color:rgba(232,240,72,0.2); background:var(--surface2); }
  .film-pick-card.selected { border-color:rgba(232,240,72,0.5); background:rgba(232,240,72,0.05); }

  .film-checkbox {
    width:18px; height:18px; border:1px solid var(--border); background:var(--surface2);
    display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px;
    transition:all 0.18s;
  }
  .film-pick-card.selected .film-checkbox { background:var(--accent); border-color:var(--accent); }
  .film-checkbox-inner { width:10px; height:10px; background:var(--bg); display:none; }
  .film-pick-card.selected .film-checkbox-inner { display:block; }

  .film-pick-info {}
  .film-pick-title { font-size:0.95rem; margin-bottom:4px; }
  .film-pick-time { font-size:0.7rem; color:var(--accent); letter-spacing:0.08em; margin-bottom:6px; }
  .film-pick-desc { font-size:0.73rem; color:var(--muted); line-height:1.65; margin-bottom:8px; }
  .film-pick-actions { display:flex; gap:8px; flex-wrap:wrap; }

  .btn-trailer {
    display:inline-flex; align-items:center; gap:5px; padding:5px 11px;
    background:rgba(72,200,240,0.08); border:1px solid rgba(72,200,240,0.22);
    color:var(--accent2); font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase;
    text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s;
  }
  .btn-trailer:hover { background:rgba(72,200,240,0.15); }

  .film-pick-venue { font-size:0.68rem; color:var(--muted); }

  .picker-footer {
    margin-top:20px; padding:16px 0; border-top:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
  }
  .selection-count { font-size:0.73rem; color:var(--muted); }
  .selection-count strong { color:var(--accent); }

  /* â”€â”€ LOADING â”€â”€ */
  .loading-box {
    display:none; text-align:center; padding:50px 20px;
    border:1px solid var(--border); background:var(--surface); margin:20px 0;
  }
  .film-strip { display:flex; gap:4px; justify-content:center; margin-bottom:16px; }
  .film-frame { width:13px; height:19px; background:var(--surface2); border:1px solid var(--border); animation:filmroll 1.2s ease-in-out infinite; }
  .film-frame:nth-child(2){animation-delay:0.1s} .film-frame:nth-child(3){animation-delay:0.2s}
  .film-frame:nth-child(4){animation-delay:0.3s} .film-frame:nth-child(5){animation-delay:0.4s}
  @keyframes filmroll { 0%,100%{background:var(--surface2);border-color:var(--border)} 50%{background:var(--accent);border-color:var(--accent)} }
  .loading-text { font-size:0.73rem; color:var(--muted); letter-spacing:0.1em; }

  /* â”€â”€ ERROR / NOTE â”€â”€ */
  .error-box { border:1px solid rgba(240,72,72,0.3); background:rgba(240,72,72,0.07); padding:18px; color:var(--red); font-size:0.78rem; line-height:1.6; margin-top:20px; display:none; }
  .note-box { background:rgba(232,240,72,0.04); border:1px solid rgba(232,240,72,0.14); padding:14px 18px; font-size:0.73rem; color:var(--muted); line-height:1.7; }
  .note-box strong { color:var(--accent); }
  .note-box a { color:var(--accent); text-decoration:none; }

  /* â”€â”€ OUTPUT â”€â”€ */
  #output { display:none; animation:fadeIn 0.4s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .output-actions { display:flex; gap:10px; margin-bottom:24px; flex-wrap:wrap; }

  /* â”€â”€ DAY CARDS â”€â”€ */
  .day-card { background:var(--surface); border:1px solid var(--border); margin-bottom:20px; overflow:hidden; }
  .day-header { padding:14px 22px; background:var(--surface2); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .day-title { font-family:'DM Serif Display',serif; font-size:1.2rem; }
  .day-date { font-size:0.68rem; color:var(--accent); letter-spacing:0.1em; }
  .screening-item { padding:18px 22px; border-bottom:1px solid var(--border); }
  .screening-item:last-child { border-bottom:none; }
  .screening-time { font-family:'DM Serif Display',serif; font-style:italic; font-size:1.25rem; color:var(--accent); margin-bottom:3px; }
  .screening-title { font-size:0.95rem; margin-bottom:3px; font-weight:500; }
  .screening-venue { font-size:0.73rem; color:var(--muted); }
  .screening-dur { font-size:0.68rem; color:var(--muted); margin-top:3px; }
  .screening-desc { font-size:0.75rem; color:var(--muted); line-height:1.65; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
  .screening-btns { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

  .btn-ticket { display:inline-flex; align-items:center; gap:5px; background:rgba(232,240,72,0.07); border:1px solid rgba(232,240,72,0.22); color:var(--accent); padding:6px 13px; font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase; text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s; }
  .btn-ticket:hover { background:rgba(232,240,72,0.14); }
  .btn-trailer-sm { display:inline-flex; align-items:center; gap:5px; background:rgba(72,200,240,0.08); border:1px solid rgba(72,200,240,0.22); color:var(--accent2); padding:6px 13px; font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase; text-decoration:none; font-family:'DM Mono',monospace; transition:all 0.18s; }
  .btn-trailer-sm:hover { background:rgba(72,200,240,0.15); }

  .travel-badge { display:flex; align-items:center; gap:12px; padding:11px 22px; background:rgba(72,200,240,0.04); border-top:1px dashed rgba(72,200,240,0.18); border-bottom:1px dashed rgba(72,200,240,0.18); }
  .travel-info { font-size:0.73rem; color:var(--accent2); }
  .btn-maps { margin-left:auto; display:inline-flex; align-items:center; gap:5px; background:rgba(72,200,240,0.1); border:1px solid rgba(72,200,240,0.28); color:var(--accent2); padding:6px 13px; font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; font-family:'DM Mono',monospace; transition:all 0.18s; text-decoration:none; flex-shrink:0; }
  .btn-maps:hover { background:rgba(72,200,240,0.18); }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.78); align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid rgba(232,240,72,0.2); padding:32px; max-width:420px; width:90%; animation:fadeUp 0.25s ease; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .modal h2 { font-family:'DM Serif Display',serif; font-size:1.4rem; margin-bottom:8px; }
  .modal p { font-size:0.75rem; color:var(--muted); margin-bottom:20px; }
  .modal-btns { display:flex; gap:10px; margin-top:20px; }
  .btn-save-confirm { flex:1; background:var(--accent); color:#0a0a0f; font-family:'DM Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; padding:11px; cursor:pointer; border:none; font-weight:600; transition:background 0.18s; }
  .btn-save-confirm:hover { background:#f0fa60; }
  .btn-cancel { padding:11px 18px; background:none; border:1px solid var(--border); color:var(--muted); font-family:'DM Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; }
  .btn-cancel:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  /* â”€â”€ ARCHIVE â”€â”€ */
  .archive-empty { text-align:center; padding:60px 20px; border:1px solid var(--border); background:var(--surface); }
  .archive-empty p { font-size:0.8rem; color:var(--muted); line-height:1.7; }
  .archive-card { background:var(--surface); border:1px solid var(--border); padding:20px 22px; cursor:pointer; transition:all 0.18s; position:relative; margin-bottom:12px; }
  .archive-card:hover { border-color:rgba(232,240,72,0.25); background:var(--surface2); }
  .archive-card-name { font-family:'DM Serif Display',serif; font-size:1.15rem; margin-bottom:5px; }
  .archive-card-meta { font-size:0.7rem; color:var(--muted); line-height:1.6; }
  .archive-card-days { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
  .day-pill { font-size:0.65rem; padding:3px 9px; background:rgba(232,240,72,0.07); border:1px solid rgba(232,240,72,0.18); color:var(--accent); letter-spacing:0.06em; }
  .archive-card-actions { position:absolute; top:14px; right:14px; }
  .btn-icon { background:none; border:1px solid var(--border); color:var(--muted); padding:5px 10px; font-size:0.7rem; cursor:pointer; font-family:'DM Mono',monospace; transition:all 0.18s; }
  .btn-icon:hover { border-color:rgba(240,72,72,0.4); color:var(--red); }
  #archive-view { display:none; }
  .back-btn { display:inline-flex; align-items:center; gap:8px; background:none; border:1px solid var(--border); color:var(--muted); padding:8px 16px; font-family:'DM Mono',monospace; font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.18s; margin-bottom:28px; }
  .back-btn:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  ::-webkit-scrollbar{width:4px} ::-webkit-scrollbar-track{background:var(--bg)} ::-webkit-scrollbar-thumb{background:var(--border)}
</style>
</head>
<body>

<nav>
  <div class="nav-brand">CPH<span>:</span>DOX</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('planner')">PlanlÃ¦gger</button>
    <button class="nav-tab" onclick="showPage('archive')">Mine planer</button>
  </div>
  <div class="storage-status">
    <div class="storage-dot" id="storage-dot"></div>
    <span id="storage-label">IndlÃ¦ser...</span>
  </div>
</nav>

<!-- â•â• PAGE: PLANNER â•â• -->
<div class="page active" id="page-planner">
<div class="container">
  <h1 class="page-title">Lav en festivalplan</h1>
  <p class="page-sub">// Hent dagens program, vÃ¦lg film og fÃ¥ en plan med ruter</p>

  <!-- STEP 1: Setup -->
  <div id="step-setup">
    <div class="section">
      <div class="section-label">01 â€” API-nÃ¸gle</div>
      <div style="position:relative;">
        <input type="password" id="api-key" placeholder="sk-ant-..." style="padding-right:80px;" />
        <button onclick="toggleKey()" id="toggle-btn" style="position:absolute;right:0;top:0;bottom:0;background:var(--surface2);border:none;border-left:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;padding:0 13px;cursor:pointer;text-transform:uppercase;">Vis</button>
      </div>
      <div style="font-size:0.68rem;color:var(--muted);margin-top:7px;line-height:1.6;">
        Hent den pÃ¥ <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a>
      </div>
    </div>

    <div class="section">
      <div class="section-label">02 â€” VÃ¦lg dine festivaldage</div>
      <p style="font-size:0.73rem;color:var(--muted);margin-bottom:16px;line-height:1.6;">VÃ¦lg op til 3 dage. For hver dag hentes dagens fulde filmprogram automatisk fra CPH:DOX.</p>
      <div class="dates-row">
        <div class="date-wrap"><span class="date-num">Dag 1</span><input type="date" id="date1" /></div>
        <div class="date-wrap"><span class="date-num">Dag 2</span><input type="date" id="date2" /></div>
        <div class="date-wrap"><span class="date-num">Dag 3</span><input type="date" id="date3" /></div>
      </div>
    </div>

    <div class="section">
      <div class="section-label">03 â€” PrÃ¦ferencer (valgfrit)</div>
      <div class="pref-row">
        <div><label>Tidligste starttidspunkt</label><input type="text" id="pref-start" placeholder="fx ikke fÃ¸r 11:00" /></div>
        <div><label>Seneste sluttidspunkt</label><input type="text" id="pref-end" placeholder="fx ikke efter 22:00" /></div>
      </div>
      <label>Ã˜vrige Ã¸nsker</label>
      <textarea id="pref-notes" placeholder="fx max 2 film om dagen, undgÃ¥ Palads..."></textarea>
    </div>

    <div class="note-box">
      <strong>SÃ¥dan virker det:</strong> Claude sÃ¸ger i CPH:DOX's program for dine valgte dage, finder alle film med beskrivelser og trailere. Du vÃ¦lger selv hvilke film du vil se â€” derefter laves planen med gangtider og ruter.
    </div>

    <button class="btn btn-primary" onclick="startFetch()">â–¶ Hent filmprogram</button>
  </div>

  <!-- STEP 2: Film picker -->
  <div id="film-picker">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
      <div>
        <h2 style="font-family:'DM Serif Display',serif;font-size:1.5rem;margin-bottom:4px;">VÃ¦lg dine film</h2>
        <p style="font-size:0.73rem;color:var(--muted);">Klik pÃ¥ de film du vil se â€” sÃ¦t kryds ved dem du er interesseret i</p>
      </div>
      <button class="btn-outline" onclick="goBackToSetup()">â† Tilbage</button>
    </div>

    <div class="day-tabs" id="day-tabs"></div>
    <div class="loading-box" id="loading-fetch">
      <div class="film-strip">
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div><div class="film-frame"></div>
        <div class="film-frame"></div>
      </div>
      <div class="loading-text" id="loading-fetch-text">Henter filmprogram...</div>
    </div>
    <div class="error-box" id="error-fetch"></div>
    <div class="film-grid" id="film-grid"></div>

    <div class="picker-footer">
      <div class="selection-count" id="selection-count">Ingen film valgt endnu</div>
      <button class="btn-primary" style="margin-top:0;width:auto;padding:11px 28px;" onclick="generatePlan()">â–¶ Lav plan med valgte film</button>
    </div>
  </div>

  <!-- STEP 3: Loading plan -->
  <div class="loading-box" id="loading-plan">
    <div class="film-strip">
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div><div class="film-frame"></div>
      <div class="film-frame"></div>
    </div>
    <div class="loading-text" id="loading-plan-text">SammensÃ¦tter din festivalplan...</div>
  </div>

  <div class="error-box" id="error-plan"></div>

  <!-- STEP 4: Output -->
  <div id="output">
    <div class="output-actions">
      <button class="btn-outline" onclick="backToPicker()">â† Skift film</button>
      <button class="btn-outline-accent" id="save-btn" onclick="openSaveModal()">ğŸ’¾ Gem plan</button>
    </div>
    <div id="plan-cards"></div>
  </div>

</div>
</div>

<!-- â•â• PAGE: ARCHIVE â•â• -->
<div class="page" id="page-archive">
<div class="container">
  <div id="archive-list">
    <h1 class="page-title">Mine planer</h1>
    <p class="page-sub">// Alle gemte festivalplaner â€” klik for at Ã¥bne</p>
    <div id="archive-cards"></div>
  </div>
  <div id="archive-view">
    <button class="back-btn" onclick="closeArchiveView()">â† Tilbage til alle planer</button>
    <h1 class="page-title" id="archive-view-title"></h1>
    <p class="page-sub" id="archive-view-sub"></p>
    <div id="archive-view-cards"></div>
  </div>
</div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="save-modal">
  <div class="modal">
    <h2>Gem plan</h2>
    <p>Giv din plan et navn sÃ¥ du nemt kan finde den igen â€” fx "DOX 2025" eller "Weekendplan marts".</p>
    <label>Plannavn</label>
    <input type="text" id="plan-name-input" placeholder="fx DOX 2025..." maxlength="60" />
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeSaveModal()">Annuller</button>
      <button class="btn-save-confirm" onclick="confirmSave()">Gem â†’</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPlanData = null;
let fetchedDays = {};      // { "2025-03-10": [ {title, time, venue, desc, trailerUrl, ...} ] }
let selectedFilms = {};    // { "2025-03-10": [ filmObj, ... ] }
let activeDayTab = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function storageSet(key, value) {
  if (window.storage) { try { await window.storage.set(key, JSON.stringify(value)); return; } catch {} }
  localStorage.setItem(key, JSON.stringify(value));
}
async function storageGet(key) {
  if (window.storage) { try { const r = await window.storage.get(key); return r ? JSON.parse(r.value) : null; } catch { return null; } }
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
}
async function storageDelete(key) {
  if (window.storage) { try { await window.storage.delete(key); } catch {} } else localStorage.removeItem(key);
}
async function storageList(prefix) {
  if (window.storage) { try { const r = await window.storage.list(prefix); return r ? r.keys : []; } catch { return []; } }
  const keys = [];
  for (let i = 0; i < localStorage.length; i++) { const k = localStorage.key(i); if (k && k.startsWith(prefix)) keys.push(k); }
  return keys;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  const ok = !!window.storage;
  document.getElementById('storage-dot').className = 'storage-dot' + (ok ? ' ok' : '');
  document.getElementById('storage-label').textContent = ok ? 'Cloud-lagring aktiv' : 'Lokal lagring';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-tab')[name === 'planner' ? 0 : 1].classList.add('active');
  if (name === 'archive') renderArchive();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleKey() {
  const inp = document.getElementById('api-key');
  const btn = document.getElementById('toggle-btn');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'Vis' : 'Skjul';
}

function getDates() {
  return ['date1','date2','date3'].map(id => document.getElementById(id).value).filter(Boolean);
}

function formatDateLabel(s) {
  if (!s) return '';
  return new Date(s).toLocaleDateString('da-DK', { weekday:'long', day:'numeric', month:'long' });
}

function getApiKey() { return document.getElementById('api-key').value.trim(); }

async function callClaude(prompt, useSearch = true) {
  const apiKey = getApiKey();
  const tools = useSearch ? [{ type: 'web_search_20250305', name: 'web_search' }] : [];
  const body = { model:'claude-sonnet-4-20250514', max_tokens:4000, messages:[{ role:'user', content:prompt }] };
  if (useSearch) body.tools = tools;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'x-api-key': apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return (data.content || []).filter(b => b.type === 'text').map(b => b.text).join('');
}

function parseJSON(text) {
  const clean = text.replace(/```json|```/g, '').trim();
  const match = clean.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
  if (!match) throw new Error('Ingen JSON fundet i svaret');
  return JSON.parse(match[0]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 1 â†’ 2: FETCH PROGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startFetch() {
  const apiKey = getApiKey();
  if (!apiKey) { alert('Indtast din Anthropic API-nÃ¸gle.'); return; }
  const dates = getDates();
  if (!dates.length) { alert('VÃ¦lg mindst Ã©n festivaldato.'); return; }

  // Reset state
  fetchedDays = {};
  selectedFilms = {};
  activeDayTab = null;

  document.getElementById('step-setup').style.display = 'none';
  document.getElementById('film-picker').style.display = 'block';
  document.getElementById('output').style.display = 'none';
  document.getElementById('error-plan').style.display = 'none';

  // Build day tabs (empty for now)
  buildDayTabs(dates);

  // Fetch each day sequentially
  for (const date of dates) {
    await fetchDayProgram(date);
  }
}

function buildDayTabs(dates) {
  const container = document.getElementById('day-tabs');
  container.innerHTML = '';
  dates.forEach((date, i) => {
    const btn = document.createElement('button');
    btn.className = 'day-tab-btn' + (i === 0 ? ' active' : '');
    btn.id = 'tab-' + date;
    btn.innerHTML = `${formatDateLabel(date)} <span class="check">âœ“</span>`;
    btn.onclick = () => switchDayTab(date);
    container.appendChild(btn);
  });
  activeDayTab = dates[0];
}

function switchDayTab(date) {
  document.querySelectorAll('.day-tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + date).classList.add('active');
  activeDayTab = date;
  renderFilmGrid(date);
}

async function fetchDayProgram(date) {
  const loadingEl = document.getElementById('loading-fetch');
  const loadingText = document.getElementById('loading-fetch-text');
  const errorEl = document.getElementById('error-fetch');

  loadingEl.style.display = 'block';
  loadingText.textContent = `Henter program for ${formatDateLabel(date)}...`;
  errorEl.style.display = 'none';

  const prompt = `Du er en hjÃ¦lper der finder filmprogram for CPH:DOX (Copenhagen International Documentary Film Festival).

Find ALLE film der vises pÃ¥ CPH:DOX festivalen den ${date} (${formatDateLabel(date)}).

SÃ¸g pÃ¥ https://cphdox.dk/program og find de film der vises denne dag.

For HVER film skal du finde:
1. Filmtitel
2. Visningstidspunkt(er) denne dag
3. Biograf/venue
4. En kort beskrivelse pÃ¥ dansk (2-4 sÃ¦tninger om hvad filmen handler om)
5. Et YouTube trailer link hvis du kan finde det (sÃ¸g pÃ¥ YouTube efter "[filmtitel] trailer" eller "[filmtitel] official trailer")

Svar KUN med gyldigt JSON array (ingen markdown, ingen tekst udenfor JSON):
[
  {
    "title": "Filmtitel",
    "screenings": [
      { "time": "14:00", "venue": "Cinemateket", "duration": "85 min" }
    ],
    "description": "Kort beskrivelse af filmen pÃ¥ dansk...",
    "trailerUrl": "https://youtube.com/watch?v=..." 
  }
]

trailerUrl skal vÃ¦re null hvis du ikke kan finde en trailer.
InkludÃ©r alle film du kan finde for denne dag. Hvis du ikke kan finde det prÃ¦cise program, lav et kvalificeret bud baseret pÃ¥ typiske CPH:DOX film og marker det tydeligt i beskrivelserne.`;

  try {
    const raw = await callClaude(prompt, true);
    let films;
    try { films = parseJSON(raw); } catch(e) { throw new Error('Kunne ikke parse filmprogram: ' + e.message); }

    if (!Array.isArray(films)) throw new Error('Uventet format fra AI');

    fetchedDays[date] = films;
    selectedFilms[date] = [];

    // If this is the active tab, render it
    if (date === activeDayTab) renderFilmGrid(date);

    // Update tab to show it's loaded
    const tab = document.getElementById('tab-' + date);
    if (tab) tab.title = films.length + ' film fundet';

  } catch(err) {
    errorEl.style.display = 'block';
    errorEl.textContent = 'âš  Fejl ved hentning af program for ' + formatDateLabel(date) + ': ' + err.message;
  } finally {
    loadingEl.style.display = 'none';
  }
}

function renderFilmGrid(date) {
  const grid = document.getElementById('film-grid');
  const films = fetchedDays[date];

  if (!films) {
    grid.innerHTML = '<p style="color:var(--muted);font-size:0.8rem;padding:20px 0;">Henter program...</p>';
    return;
  }

  if (!films.length) {
    grid.innerHTML = '<p style="color:var(--muted);font-size:0.8rem;padding:20px 0;">Ingen film fundet for denne dag.</p>';
    return;
  }

  grid.innerHTML = '';
  const selected = selectedFilms[date] || [];

  films.forEach((film, idx) => {
    const isSelected = selected.some(f => f.title === film.title);
    const card = document.createElement('div');
    card.className = 'film-pick-card' + (isSelected ? ' selected' : '');
    card.id = 'film-card-' + date + '-' + idx;

    const times = (film.screenings || []).map(s => `${s.time}${s.venue ? ' Â· ' + s.venue : ''}${s.duration ? ' (' + s.duration + ')' : ''}`).join('  |  ');

    const trailerBtn = film.trailerUrl
      ? `<a href="${film.trailerUrl}" target="_blank" class="btn-trailer" onclick="event.stopPropagation()">â–¶ Se trailer</a>`
      : '';

    card.innerHTML = `
      <div class="film-checkbox"><div class="film-checkbox-inner"></div></div>
      <div class="film-pick-info">
        <div class="film-pick-title">${film.title}</div>
        <div class="film-pick-time">${times || 'Tidspunkt ikke fundet'}</div>
        <div class="film-pick-desc">${film.description || ''}</div>
        <div class="film-pick-actions">${trailerBtn}</div>
      </div>
    `;

    card.addEventListener('click', () => toggleFilmSelection(date, idx, film, card));
    grid.appendChild(card);
  });

  updateSelectionCount();
}

function toggleFilmSelection(date, idx, film, card) {
  if (!selectedFilms[date]) selectedFilms[date] = [];

  const existing = selectedFilms[date].findIndex(f => f.title === film.title);
  if (existing >= 0) {
    selectedFilms[date].splice(existing, 1);
    card.classList.remove('selected');
  } else {
    selectedFilms[date].push(film);
    card.classList.add('selected');
  }

  // Update tab indicator
  const tab = document.getElementById('tab-' + date);
  if (tab) tab.classList.toggle('has-selection', selectedFilms[date].length > 0);

  updateSelectionCount();
}

function updateSelectionCount() {
  const total = Object.values(selectedFilms).reduce((sum, arr) => sum + arr.length, 0);
  const el = document.getElementById('selection-count');
  if (total === 0) {
    el.innerHTML = 'Ingen film valgt endnu';
  } else {
    el.innerHTML = `<strong>${total}</strong> film valgt`;
  }
}

function goBackToSetup() {
  document.getElementById('film-picker').style.display = 'none';
  document.getElementById('step-setup').style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 3: GENERATE PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generatePlan() {
  const apiKey = getApiKey();
  if (!apiKey) { alert('Ingen API-nÃ¸gle fundet.'); return; }

  // Build selected film list
  const allSelected = [];
  Object.entries(selectedFilms).forEach(([date, films]) => {
    films.forEach(f => allSelected.push({ date, ...f }));
  });

  if (!allSelected.length) { alert('VÃ¦lg mindst Ã©n film.'); return; }

  const prefStart = document.getElementById('pref-start').value.trim();
  const prefEnd   = document.getElementById('pref-end').value.trim();
  const prefNotes = document.getElementById('pref-notes').value.trim();

  document.getElementById('film-picker').style.display = 'none';
  document.getElementById('loading-plan').style.display = 'block';
  document.getElementById('error-plan').style.display = 'none';
  document.getElementById('output').style.display = 'none';

  const msgs = ['SammensÃ¦tter din festivalplan...','Beregner gangtider og afstande...','Tjekker tidspunkter og overlap...','FÃ¦rdiggÃ¸r din plan...'];
  let mi = 0;
  const lt = setInterval(() => { document.getElementById('loading-plan-text').textContent = msgs[++mi % msgs.length]; }, 2500);

  const filmsSummary = allSelected.map(f => {
    const times = (f.screenings || []).map(s => `${s.time} pÃ¥ ${s.venue}`).join(', ');
    return `- ${f.title} (${formatDateLabel(f.date)}, ${times})`;
  }).join('\n');

  const prompt = `Du er en festivalplanlÃ¦gger for CPH:DOX.

Brugeren har valgt disse film:
${filmsSummary}

${prefStart ? `Foretrukket tidligste start: ${prefStart}` : ''}
${prefEnd ? `Foretrukket seneste slut: ${prefEnd}` : ''}
${prefNotes ? `Ã˜vrige prÃ¦ferencer: ${prefNotes}` : ''}

Lav en optimal festivalplan:
1. VÃ¦lg det bedste tidspunkt for hver film hvis der er flere visninger
2. UndgÃ¥ tidsmÃ¦ssigt overlap
3. Beregn gangtid i minutter og afstand i km mellem biografer pÃ¥ samme dag
4. SÃ¸rg for nok buffer til transport

Svar KUN med gyldigt JSON:
{
  "days": [
    {
      "date": "YYYY-MM-DD",
      "date_label": "Mandag 10. marts",
      "screenings": [
        {
          "time": "13:00",
          "title": "Filmtitel",
          "venue": "Biografnavn",
          "duration": "90 min",
          "description": "Filmens beskrivelse",
          "trailerUrl": "https://youtube.com/...",
          "ticketUrl": "https://cphdox.dk/film/...",
          "distance_to_next": 1.2,
          "walk_minutes_to_next": 15
        }
      ]
    }
  ],
  "notes": "Kort note om planen"
}

Brug de faktiske biografnavne og adresser fra de valgte film.
distance_to_next og walk_minutes_to_next kun hvis nÃ¦ste screening er i anden biograf.
trailerUrl og description fra de valgte films data som du har fÃ¥et.`;

  // Inject film data into prompt
  const filmData = JSON.stringify(allSelected, null, 2);
  const fullPrompt = prompt + '\n\nFilmdata:\n' + filmData;

  try {
    const raw = await callClaude(fullPrompt, false);
    let planData;
    try { planData = parseJSON(raw); } catch(e) { throw new Error('Kunne ikke parse plan: ' + e.message); }

    clearInterval(lt);
    currentPlanData = planData;
    document.getElementById('loading-plan').style.display = 'none';
    document.getElementById('output').style.display = 'block';
    renderDayCards(planData, document.getElementById('plan-cards'));

  } catch(err) {
    clearInterval(lt);
    document.getElementById('loading-plan').style.display = 'none';
    document.getElementById('film-picker').style.display = 'block';
    const eb = document.getElementById('error-plan');
    eb.style.display = 'block';
    eb.textContent = 'âš  Fejl: ' + err.message;
  }
}

function backToPicker() {
  document.getElementById('output').style.display = 'none';
  document.getElementById('film-picker').style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER DAY CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDayCards(data, container) {
  container.innerHTML = '';
  if (!data.days || !data.days.length) {
    container.innerHTML = '<p style="color:var(--muted);font-size:0.8rem;">Ingen plan kunne genereres.</p>';
    return;
  }

  data.days.forEach(day => {
    const card = document.createElement('div');
    card.className = 'day-card';

    const hdr = document.createElement('div');
    hdr.className = 'day-header';
    hdr.innerHTML = `<span class="day-title">${day.date_label || day.date}</span><span class="day-date">${day.date}</span>`;
    card.appendChild(hdr);

    (day.screenings || []).forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'screening-item';

      const ticketUrl = s.ticketUrl || `https://cphdox.dk/program/?s=${encodeURIComponent(s.title)}`;
      const trailerBtn = s.trailerUrl
        ? `<a href="${s.trailerUrl}" target="_blank" class="btn-trailer-sm">â–¶ Trailer</a>`
        : '';

      item.innerHTML = `
        <div class="screening-time">${s.time}</div>
        <div class="screening-title">${s.title}</div>
        <div class="screening-venue">ğŸ“ ${s.venue}</div>
        ${s.duration ? `<div class="screening-dur">Varighed: ${s.duration}</div>` : ''}
        ${s.description ? `<div class="screening-desc">${s.description}</div>` : ''}
        <div class="screening-btns">
          <a href="${ticketUrl}" target="_blank" class="btn-ticket">ğŸŸ KÃ¸b billet</a>
          ${trailerBtn}
        </div>
      `;
      card.appendChild(item);

      const next = day.screenings[idx + 1];
      if (next) {
        const travel = document.createElement('div');
        travel.className = 'travel-badge';
        if (s.venue !== next.venue) {
          const from = encodeURIComponent(s.venue + ', Copenhagen');
          const to   = encodeURIComponent(next.venue + ', Copenhagen');
          const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${from}&destination=${to}&travelmode=walking`;
          travel.innerHTML = `
            <div class="travel-info">ğŸš¶ ${s.distance_to_next || '?'} km Â· ca. ${s.walk_minutes_to_next || '?'} min til fods â†’ ${next.venue}</div>
            <a href="${mapsUrl}" target="_blank" class="btn-maps">Ã…bn Maps â†’</a>
          `;
        } else {
          travel.innerHTML = `<div class="travel-info">ğŸ“ Bliv i ${s.venue}</div>`;
        }
        card.appendChild(travel);
      }
    });

    container.appendChild(card);
  });

  if (data.notes) {
    const nb = document.createElement('div');
    nb.className = 'note-box';
    nb.style.marginTop = '20px';
    nb.innerHTML = `<strong>Note:</strong> ${data.notes}`;
    container.appendChild(nb);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSaveModal() {
  if (!currentPlanData) return;
  document.getElementById('plan-name-input').value = '';
  document.getElementById('save-modal').classList.add('open');
  setTimeout(() => document.getElementById('plan-name-input').focus(), 100);
}
function closeSaveModal() { document.getElementById('save-modal').classList.remove('open'); }
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeSaveModal();
  if (e.key === 'Enter' && document.getElementById('save-modal').classList.contains('open')) confirmSave();
});

async function confirmSave() {
  const name = document.getElementById('plan-name-input').value.trim();
  if (!name) { alert('Giv planen et navn.'); return; }
  if (!currentPlanData) return;
  const id = 'plan:' + Date.now();
  await storageSet(id, { id, name, savedAt: new Date().toISOString(), data: currentPlanData });
  closeSaveModal();
  const btn = document.getElementById('save-btn');
  const orig = btn.textContent;
  btn.textContent = 'âœ“ Gemt!';
  btn.style.cssText += 'background:rgba(72,240,168,0.12);border-color:rgba(72,240,168,0.3);color:#48f0a8;';
  setTimeout(() => { btn.textContent = orig; btn.style.cssText = ''; }, 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARCHIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderArchive() {
  document.getElementById('archive-list').style.display = 'block';
  document.getElementById('archive-view').style.display = 'none';
  const keys = await storageList('plan:');
  const container = document.getElementById('archive-cards');

  if (!keys.length) {
    container.innerHTML = `<div class="archive-empty"><p>Du har ikke gemt nogen planer endnu.<br>Lav en plan og tryk <em>Gem plan</em>.</p></div>`;
    return;
  }

  container.innerHTML = '<p style="font-size:0.73rem;color:var(--muted);margin-bottom:16px;">IndlÃ¦ser...</p>';
  const plans = (await Promise.all(keys.map(k => storageGet(k)))).filter(Boolean);
  plans.sort((a,b) => new Date(b.savedAt) - new Date(a.savedAt));
  container.innerHTML = '';

  plans.forEach(plan => {
    const card = document.createElement('div');
    card.className = 'archive-card';
    const days = plan.data.days || [];
    const films = days.flatMap(d => (d.screenings||[]).map(s => s.title));
    const savedDate = new Date(plan.savedAt).toLocaleDateString('da-DK', { day:'numeric', month:'long', year:'numeric' });
    const pills = days.map(d => `<span class="day-pill">${(d.date_label||d.date).split(' ').slice(0,2).join(' ')}</span>`).join('');

    card.innerHTML = `
      <div class="archive-card-actions"><button class="btn-icon" onclick="deletePlan(event,'${plan.id}')">Slet</button></div>
      <div class="archive-card-name">${plan.name}</div>
      <div class="archive-card-meta">Gemt ${savedDate} Â· ${films.length} film over ${days.length} dag${days.length !== 1 ? 'e' : ''}</div>
      <div class="archive-card-days">${pills}</div>
    `;
    card.addEventListener('click', e => { if (e.target.classList.contains('btn-icon')) return; openArchiveView(plan); });
    container.appendChild(card);
  });
}

function openArchiveView(plan) {
  document.getElementById('archive-list').style.display = 'none';
  document.getElementById('archive-view').style.display = 'block';
  const days = plan.data.days || [];
  const films = days.flatMap(d => (d.screenings||[]).map(s => s.title));
  const savedDate = new Date(plan.savedAt).toLocaleDateString('da-DK', { day:'numeric', month:'long', year:'numeric' });
  document.getElementById('archive-view-title').textContent = plan.name;
  document.getElementById('archive-view-sub').textContent = `// Gemt ${savedDate} Â· ${films.length} film over ${days.length} dage`;
  renderDayCards(plan.data, document.getElementById('archive-view-cards'));
}

function closeArchiveView() {
  document.getElementById('archive-list').style.display = 'block';
  document.getElementById('archive-view').style.display = 'none';
}

async function deletePlan(e, id) {
  e.stopPropagation();
  if (!confirm('Er du sikker pÃ¥ at du vil slette denne plan?')) return;
  await storageDelete(id);
  renderArchive();
}
</script>
</body>
</html>
